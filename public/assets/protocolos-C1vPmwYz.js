import{r as M,j as i,a1 as V,S as y,_ as v,a2 as ne,a3 as _,F as ae,$ as q,a0 as J}from"./index-BkPAYC4t.js";import{u as se}from"./eventos-DRwgwRrc.js";import{u as re}from"./subproyectos-BGw0_UMO.js";import{u as ie}from"./laboratorios-DlLEjG8j.js";import{u as Y}from"./useQuery-BAPTrFW-.js";import{A as ee,a as le}from"./apiResource-CLOj6waL.js";import{u as ce}from"./matrices-Ck3D_uNN.js";import{E as de}from"./exceljs.min-DwoinmsD.js";import{s as U,f as ue}from"./specialValues-CHSjwz8L.js";import{f as me,s as pe}from"./protocolosDataAccess-hWDhrFck.js";import{T as fe}from"./toast-YCVj4MMS.js";import"./m_file_uploader-CMQ6q2Vg.js";import{f as he}from"./localization-D8w3L9Lu.js";import{D,E as W,C}from"./data-grid-BNyC2bq0.js";import{u as xe}from"./compuestos-BTtq0jfa.js";import{u as ge}from"./metodos-DJ3Reldp.js";import{u as be}from"./um-DiDMn0L_.js";import"./m_export-BPchivYo.js";const we=ee;async function Se(e){if(!e)return[];const o=await fetch(`${we}matrizcadena?eventoId=${e}`);if(!o.ok)throw new Error(`Error al obtener matrices del evento: ${o.statusText}`);return o.json()}const ye=e=>{const{data:o=[],isLoading:t,error:n,...a}=Y({queryKey:["matrizDeEvento",e],queryFn:()=>Se(e),enabled:!!e});return{matrizEvento:o,isLoadingMatrizEvento:t,isErrorMatrizEvento:n,...a}};function A(e){if(typeof e=="string"){const t=e.trim().toLowerCase();if(t.startsWith("<")||t.startsWith("nc"))return U.LQ;if(t.startsWith("no detectado"))return U.NO_DETECTADO;if(!t||t.startsWith("x")||t.startsWith("-"))return U.NO_ANALIZADO;let n=e.trim();n=n.replace(/[^\d.,-]/g,""),n.includes(",")&&!n.includes(".")&&(n=n.replace(",","."));const a=parseFloat(n);return isNaN(a)?null:a}if(typeof e=="number")return isNaN(e)?null:e;const o=parseFloat(e);return isNaN(o)?null:o}function Ee(e){return ve(e,["encabezado","monitore","metodos"])}function Le(e,o){const t=[],n=Fe(e,t),a=e.worksheets.find(p=>p.id===o),{rows:s,parametroIndex:l,unidadIndex:d,metodosIndex:u,pozoIndices:f}=Ce(a,["LD","LQ","LC"]);console.log("extractSheetData",s,l,d,u,f);const h=Ie(s,{parametroIndex:l,unidadIndex:d,metodosIndex:u,pozoIndices:f,metodosData:n}),r=je(f);return console.log("muestrasListLab: ",r),{matrizLab:h,muestrasListLab:r,warnMessages:t}}function Ie(e,{parametroIndex:o,unidadIndex:t,metodosIndex:n,pozoIndices:a,metodosData:s}){return e.map(l=>{var r;const d=l[o];if(!d)return null;const u=((r=l[t])==null?void 0:r.toLowerCase())||null,f=n!==null&&s.length>0?Me(l[n],s):null,h=a.reduce((p,m)=>(p[m.name]=A(l[m.index]),p),{});return{compuestoLab:d,compuestoId:null,metodoLab:f,metodoId:null,unidadLab:u,unidadId:null,...h}}).filter(Boolean)}function je(e){return e.map(o=>({muestraLab:o.name,muestraCadena:null}))}function Me(e,o){const t=T(e),n=o.find(a=>T(a.parametro)===t);return n?n.metodo:null}function ve(e,o){const t=e.worksheets.filter(n=>!o.some(a=>n.name.toLowerCase().includes(a)));if(!t.length===0)throw new Error("No se encontró una hoja válida.");return t}function Ce(e,o=[]){const n=e.getSheetValues().slice(1).map(r=>r?r.slice(1):[]),a=n.findIndex(r=>r==null?void 0:r.some(p=>T(p).includes("parametro")));if(a===-1)throw new Error("No se encontró la fila de cabecera.");const s=n[a],l=n.slice(a+1),d=s.findIndex(r=>typeof r=="string"&&T(r).includes("parametro")),u=s.findIndex(r=>typeof r=="string"&&T(r).includes("unidad")),f=s.findIndex(r=>typeof r=="string"&&T(r).includes("metodo"));if(console.log("headers",s),a>0){const r=n[a-1],p=s.length;let m=!1,x=[];if(Array.isArray(r)&&r.length>p?(x=r.slice(p),m=x.some(g=>!!g&&T(g).length>0)):m=!1,m)for(let g=0;g<x.length;g++)s[p+g]=x[g]}console.log("newheaders",s);const h=s.map((r,p)=>({name:r,index:p})).filter(r=>r.index!==d&&r.index!==u&&r.index!==f&&!o.includes(r.name));return{rows:l,parametroIndex:d,unidadIndex:u,metodosIndex:f!==-1?f:null,pozoIndices:h}}function T(e){return(e??"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim()}function Fe(e,o){const t=[],n=e.worksheets.find(u=>u.name.toLowerCase().startsWith("metodos"));if(!n)return o.push("El protocolo no tiene la hoja Metodos"),t;const a=n.getSheetValues(),{headerRow:s,metodoIndex:l,parametroIndex:d}=Pe(a,o);if(!s)return t;for(let u=s+1;u<a.length;u++){const f=a[u];if(!f)continue;const h=f[l],r=f[d];if(!h&&!r)break;t.push({parametro:String(r||"").trim(),metodo:String(h||"").trim()})}return t}function Pe(e,o){for(let t=1;t<e.length;t++){const n=e[t];if(!n)continue;const a=n.map(d=>T(typeof d=="string"||typeof d=="number"?d:" ")),s=a.findIndex(d=>d==="parametro"),l=a.findIndex(d=>typeof d=="string"&&d.includes("metodo"));if(s!==-1&&l!==-1)return{headerRow:t,parametroIndex:s,metodoIndex:l}}return o.push("No se encontraron correctamente las columnas de Método y Parámetro."),{headerRow:null}}function ke(e,o){const t=[],s=e.worksheets[0].getSheetValues().slice(1).map(c=>c?c.slice(1):[]),l=s.findIndex(c=>c&&c.includes("Parámetros"));if(l===-1)throw new Error("No se encontró la fila de cabecera.");const d=s[l],u=s.slice(l+1),f=[];for(const c of u){if(!c||!c[0]&&!c[1])break;f.push(c)}const h=0,r=1,p=2,m=d.slice(3).map((c,w)=>({name:c,index:w+3})).filter(c=>c.name&&c.name.toLowerCase()!=="límite detección"),x=f.map(c=>{var S;const w=c[h];if(!w)return null;const E=c[r]||null,L=((S=c[p])==null?void 0:S.toLowerCase())||null,I=m.reduce((k,O)=>(k[O.name]=A(c[O.index]),k),{});return{compuestoLab:w,compuestoId:null,metodoLab:E,metodoId:null,unidadLab:L,unidadId:null,...I}}).filter(Boolean),g=m.map(c=>({muestraLab:c.name,muestraCadena:null}));return{matrizLab:x,muestrasListLab:g,warnMessages:t}}function Oe(e){const o=e.toLowerCase(),t="muestra",n="proyecto",a=o.indexOf(t);if(a===-1)return null;let s=e.substring(a+t.length).trim();const l=s.toLowerCase().indexOf(n);return l!==-1&&(s=s.substring(0,l).trim()),s}function ze(e,o){const t=e.findIndex(s=>s[0]&&s[0].toString().toLowerCase().includes("muestra"));if(t===-1)return console.warn(`No se encontró la palabra "muestra" en la hoja "${o}". Se omite.`),{finded:!1,nombreMuestra:"",warnMuestraMessage:`No se encontró la palabra "muestra" en la hoja [${o}]. Se omite.`};const n=e[t][0].toString();return{finded:!0,nombreMuestra:Oe(n)||o}}function Te(e,o){let t=e.findIndex(n=>n[0]&&n[0].toString().toLowerCase().includes("parámetro"));return t===-1?(console.warn(`No se encontró la fila con "Parámetro" en la hoja "${o}". Se omite.`),{headersRow:t,warnHeaderMessage:`No se encontró la fila con "Parámetro" en la hoja [${o}]. Se omite.`}):(e[t][0]==e[t+1][0]&&t++,{headersRow:t})}function Ae(e,o){const t={},n=[],a=[];return e.worksheets.forEach(l=>{const d=l.name,f=l.getSheetValues().slice(1).map(c=>c?c.slice(1):[]),{finded:h,nombreMuestra:r,warnMuestraMessage:p}=ze(f,d);if(!h){a.push(p);return}const{headersRow:m,warnHeaderMessage:x}=Te(f,d);if(m===-1){a.push(x);return}const g=f.slice(m+1);for(const c of g){if(!c[0])break;const w=c[0]?c[0].toString().trim():null,E=c[1]?c[1].toString().trim():null,L=c[2],I=c[3]?c[3].toString().toLowerCase().trim():null,S=`${w}||${E}||${I}`;t[S]||(t[S]={compuestoLab:w,compuestoId:null,metodoLab:E,metodoId:null,unidadLab:I,unidadId:null}),t[S][r]=A(L)}n.push({muestraLab:r,muestraCadena:null})}),{matrizLab:Object.values(t),muestrasListLab:n,warnMessages:a}}const Ne="parametros",Q=0,Re=1,Be=3,K=4,Ue=["limite deteccion","limite de cuantificacion"];function R(e,o=!0){if(!e)return"";let t=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s\-/()]/g,"").replace(/\s+/g," ").trim();return o?t.toLowerCase():t}function Z(e){const o=/\b(MA|MS|MG|MP)[ -]\S+\b/,t=e.match(o);return t?t[0]:null}function Ve(e,o){const t=[],s=e.worksheets[0].getSheetValues().slice(1).map(m=>m?m.slice(1):[]),l=s.findIndex(m=>m&&R(m[Q])===Ne);if(l===-1)throw new Error("No se encontró la fila de cabecera.");const d=s[l],u=s.slice(l+1),f=[];for(const m of u){if(!m||!m[0]&&!m[1])break;f.push(m)}const h=d.slice(K).map((m,x)=>({name:m,index:x+K})).filter(m=>m.name&&!Ue.includes(R(m.name))),r=f.map(m=>{var E;const x=m[Q];if(!x)return null;const g=m[Re]||null,c=((E=m[Be])==null?void 0:E.toLowerCase())||null,w=h.reduce((L,I)=>{const S=Z(R(I.name,!1));return L[S]=A(m[I.index]),L},{});return{compuestoLab:x,compuestoId:null,metodoLab:g,metodoId:null,unidadLab:c,unidadId:null,...w}}).filter(Boolean),p=h.map(m=>({muestraLab:Z(R(m.name,!1)),muestraCadena:null}));return{matrizLab:r,muestrasListLab:p,warnMessages:t}}function $e(e,o){const t=[],s=e.worksheets[0].getSheetValues().slice(1).map(c=>c?c.slice(1):[]),l=s.findIndex(c=>c&&c.includes("Determinaciones"));if(l===-1)throw new Error("No se encontró la fila de cabecera.");const d=s[l],u=s.slice(l+1),f=[];for(const c of u){if(!c||!c[0]&&!c[1])break;f.push(c)}const h=0,r=1,p=2,m=d.slice(3).map((c,w)=>({name:c,index:w+3})).filter(c=>c.name),x=f.map(c=>{var S;const w=c[h];if(!w)return null;const E=c[r]||null,L=((S=c[p])==null?void 0:S.toLowerCase())||null,I=m.reduce((k,O)=>{const b=c[O.index]!==void 0?A(c[O.index]):U.NO_ANALIZADO;return k[O.name]=b,k},{});return{compuestoLab:w,compuestoId:null,metodoLab:E,metodoId:null,unidadLab:L,unidadId:null,...I}}).filter(Boolean),g=m.map(c=>({muestraLab:c.name,muestraCadena:null}));return{matrizLab:x,muestrasListLab:g,warnMessages:t}}const B=e=>[e.worksheets[0]],oe={als:{process:Le,getPages:Ee},inducer:{process:ke,getPages:B},labca:{process:Ae,getPages:B},cit:{process:Ve,getPages:B},fix:{process:$e,getPages:B}};async function De(e,o){const t=await He(e),n=oe[o.toLowerCase()];if(!n)throw new Error("Formato no soportado");const a=n.getPages(t);return{workbook:t,sheets:a}}async function We(e,o,t){const n=oe[t.toLowerCase()];if(!n)throw new Error("Formato no soportado");return n.process(e,o)}async function He(e){const o=await Ge(e),t=new de.Workbook;return await t.xlsx.load(o),t}async function Ge(e){const o=new FileReader;return new Promise((t,n)=>{o.onload=a=>t(a.target.result),o.onerror=()=>n("Error al leer el archivo."),o.readAsArrayBuffer(e)})}const H=ee;async function _e(e,o){try{const t=await fetch(`${H}sinonimoscompuestos/listasinonimos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({matrizId:e,compuestosOriginales:o})});if(!t.ok)throw new Error("Error fetching Sinonimos Compuestos");return await t.json()}catch(t){throw console.error("Error fetching Sinonimos Compuestos:",t),t}}async function qe(e){try{const o=await fetch(`${H}sinonimosmetodos/listasinonimos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({metodosOriginales:e})});if(!o.ok)throw new Error("Error fetching Sinonimos Metodos");return await o.json()}catch(o){throw console.error("Error fetching Sinonimos Metodos:",o),o}}async function Je(e){try{const o=await fetch(`${H}sinonimosums/listasinonimos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({umsOriginales:e})});if(!o.ok)throw new Error("Error fetching Sinonimos UMs");return await o.json()}catch(o){throw console.error("Error fetching Sinonimos UMs:",o),o}}async function Qe(e,o){return await Ke(e,o),await Ze(e),await Xe(e),e}async function Ke(e,o){const t=[...new Set(e.map(a=>a.compuestoLab).filter(a=>!!a&&a.length<=60))],n=await _e(o,t);e.forEach(a=>{const s=n.find(l=>l.compuestoOriginal===a.compuestoLab);a.compuestoId=s?s.compuestoId:null})}async function Ze(e){const o=[...new Set(e.map(n=>n.metodoLab).filter(n=>!!n&&n.length<=60))];if(o.length<=0)return;const t=await qe(o);e.forEach(n=>{const a=t.find(s=>s.metodoOriginal===n.metodoLab);n.metodoId=a?a.metodoId:null})}async function Xe(e){const o=[...new Set(e.map(n=>n.unidadLab).filter(n=>!!n&&n.length<=10))];if(o.length<=0)return;const t=await Je(o);e.forEach(n=>{const a=t.find(s=>s.umOriginal===n.unidadLab);n.unidadId=a?a.umId:null})}async function Ye(e,o){const t=a=>a.toLowerCase().replace(/[.,;:/()_*\+\-\s]/g,"");function n(a){const s=/\b(MA|MS|MG|MP)[ -]\S+\b/,l=a.match(s);return l?l[0]:null}return e.forEach(a=>{const s=n(a.muestraLab);if(!s)return;const l=t(s),d=o.find(u=>t(u.muestra)===l);d&&(a.muestraCadena=d.muestraId)}),e}const eo=async(e,o,t)=>{const n=new le("protocolos");let a=[];return e!==0&&a.push(["eventoMuestreoId","=",e]),e!==0&&o!==0&&a.push("and"),o!==0&&a.push(["matrizId","=",o]),e!==0&&o!==0&&t!==0&&a.push("and"),t!==0&&a.push(["laboratorioId","=",t]),a.length===0&&(a=null),(await n.fetch({filter:a,sort:[{selector:"fecha",desc:!1}]})).data},oo=(e,o,t)=>{const{data:n=[],isLoading:a,error:s,...l}=Y({queryKey:["protocolos",e,o,t],queryFn:()=>eo(e,o,t),enabled:e!=null&&o!=null&&t!=null});return{protocolos:n,isLoadingProtocolos:a,isErrorProtocolos:s,...l}};function to({subproyectos:e,laboratorios:o,filteredEventos:t,matrices:n,formData:a,protocolos:s,excelPages:l}){const[d,u]=M.useState(null),[f,h]=M.useState(null);return i.jsxs(i.Fragment,{children:[i.jsxs(V,{caption:"Datos de referencia",colSpan:8,colCount:2,children:[i.jsx(y,{dataField:"subproyecto",editorType:"dxSelectBox",editorOptions:{dataSource:e,displayExpr:r=>r?`${r.codigo} - ${r.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0},children:i.jsx(v,{text:"Seleccione un Subproyecto"})}),i.jsx(y,{dataField:"evento",editorType:"dxSelectBox",editorOptions:{dataSource:t,displayExpr:r=>r?`${he(new Date(r.fecha),"dd/MM/yyyy")} - ${r.nombre}`:"",valueExpr:"id",searchEnabled:!0},children:i.jsx(v,{text:"Seleccione un Evento de Muestreo"})}),i.jsx(y,{dataField:"matrizId",caption:"Matriz",editorType:"dxSelectBox",editorOptions:{dataSource:n,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0},children:i.jsx(v,{text:"Seleccione una Matriz"})}),i.jsx(y,{dataField:"laboratorio",editorType:"dxSelectBox",editorOptions:{dataSource:o,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0},children:i.jsx(v,{text:"Seleccione un Laboratorio"})})]}),i.jsxs(V,{caption:"Adelanto de Protocolo",colSpan:4,colCount:1,children:[i.jsx(y,{dataField:"adelanto",editorType:"dxFileUploader",cssClass:"file-uploader-container",editorOptions:{selectButtonText:"Seleccionar archivo",labelText:"o arrastre un archivo aquí",accept:".xlsx",uploadMode:"useForm",width:"100%",disabled:!(a.evento&&a.laboratorio)||f,onValueChanged:r=>{u(r.value[0]||null),r.value[0]&&h(null)}},children:i.jsx(v,{text:"Cargar archivo Excel"})}),l.length>1&&i.jsx(y,{dataField:"indicePagina",editorType:"dxSelectBox",editorOptions:{dataSource:l,displayExpr:"name",valueExpr:"id",searchEnabled:!0},children:i.jsx(v,{text:"Seleccione una página"})}),l.length<=1&&i.jsx(y,{dataField:"importados",editorType:"dxSelectBox",editorOptions:{dataSource:s,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0,uploadMode:"useForm",width:"100%",disabled:!(a.evento&&a.laboratorio)||d,onValueChanged:r=>{h(r.value||null),r.value&&u(null)}},children:i.jsx(v,{text:"Protocolos Importados"})})]})]})}function no(){const e=window.innerHeight;return e>900?"lg":e>680?"md":"sm"}function G(e){const o=no();return o==="lg"?e:Math.round(o==="md"?e*.8:e*.7)}function ao({subproyectos:e,eventos:o,laboratorios:t,matrices:n,formData:a}){var s,l,d,u,f,h;return i.jsxs(i.Fragment,{children:[i.jsx(y,{colSpan:3,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((s=e.find(r=>r.id===a.subproyecto))==null?void 0:s.nombreLocacion)||"No seleccionado"},children:i.jsx(v,{text:"Subproyecto"})}),i.jsx(y,{colSpan:3,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((l=o.find(r=>r.id===a.evento))==null?void 0:l.nombre)||"No seleccionado"},children:i.jsx(v,{text:"Evento"})}),i.jsx(y,{colSpan:2,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((d=t.find(r=>r.id===a.laboratorio))==null?void 0:d.nombre)||"No seleccionado"},children:i.jsx(v,{text:"Laboratorio"})}),i.jsx(y,{colSpan:1,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((u=n.find(r=>r.id===a.matrizId))==null?void 0:u.nombre)||"No seleccionado"},children:i.jsx(v,{text:"Matriz"})}),i.jsx(y,{colSpan:3,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((h=(f=a.adelanto)==null?void 0:f[0])==null?void 0:h.name)||"Archivo no cargado"},children:i.jsx(v,{text:"Archivo Importado"})})]})}function so({adelantoData:e,setAdelantoData:o,matrizId:t}){const{compuestos:n,isLoadingCompuestos:a}=xe(),{metodos:s,isLoadingMetodos:l}=ge(),{UM:d,isLoadingUM:u}=be(),f=M.useMemo(()=>n.filter(p=>p.matrizCodigo===t),[n,t]);if(a||l||u)return i.jsx("div",{children:"Cargando datos..."});const h=p=>{const{data:m}=p;o(x=>({...x,data:x.data.map(g=>g.compuestoLab===m.compuestoLab?{...g,...m}:g)}))},r=G(500);return i.jsxs(D,{dataSource:e.data,keyExpr:"compuestoLab",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:r,scrolling:{mode:"virtual"},allowColumnResizing:!0,columnResizingMode:"widget",onRowUpdated:h,children:[i.jsx(W,{mode:"cell",allowUpdating:!0}),i.jsx(C,{dataField:"compuestoLab",caption:"Compuesto (Lab)",width:320,allowEditing:!1}),i.jsx(C,{dataField:"compuestoId",caption:"Compuesto (BFU)",width:320,lookup:{dataSource:f,valueExpr:"id",displayExpr:"nombre"}}),i.jsx(C,{dataField:"metodoLab",caption:"Metodo (Lab)",allowEditing:!1}),i.jsx(C,{dataField:"metodoId",caption:"Metodo (BFU)",lookup:{dataSource:s,valueExpr:"id",displayExpr:"nombre"}}),i.jsx(C,{dataField:"unidadLab",caption:"UM (Lab)",allowEditing:!1}),i.jsx(C,{dataField:"unidadId",caption:"UM (BFU)",lookup:{dataSource:d,valueExpr:"id",displayExpr:"nombre"}})]})}function ro({adelantoData:e,setAdelantoData:o,muestras:t}){const n=s=>{const{data:l}=s;o(d=>({...d,muestras:d.muestras.map(u=>u.muestraLab===l.muestraLab?{...u,...l}:u)}))},a=G(500);return i.jsxs(D,{dataSource:e.muestras,keyExpr:"muestraLab",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:a,scrolling:{mode:"virtual"},onRowUpdated:n,children:[i.jsx(W,{mode:"cell",allowUpdating:!0}),i.jsx(C,{dataField:"muestraLab",caption:"Laboratorio",allowEditing:!1}),i.jsx(C,{dataField:"muestraCadena",caption:"Cadena",lookup:{dataSource:t||[],valueExpr:"muestraId",displayExpr:"muestra"}})]})}function io({formData:e,subproyectos:o,laboratorios:t,eventos:n,matrices:a,adelantoData:s,setAdelantoData:l,muestras:d,modo:u}){const h=window.innerWidth/100,r=G(500);return i.jsxs(V,{colSpan:12,colCount:12,children:[i.jsx(ao,{subproyectos:o,eventos:n,laboratorios:t,matrices:a,formData:e}),i.jsxs(ne,{deferRendering:!1,colSpan:12,children:[i.jsx(_,{title:"Vista Importada",children:i.jsxs(D,{dataSource:s.data,keyExpr:"compuestoLab",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!1,height:r,scrolling:{mode:"virtual"},onCellPrepared:p=>{p.rowType==="data"&&p.column.dataField!=="compuestoId"&&p.column.dataField!=="metodoId"&&p.column.dataField!=="unidadId"&&(p.value===-1?p.cellElement.style.backgroundColor="#E0F7E9":p.value===-2&&(p.cellElement.style.backgroundColor="#ECEFF1"))},children:[i.jsx(C,{dataField:"compuestoLab",caption:"Compuesto",fixed:!0,fixedPosition:"left",width:12*h}),i.jsx(C,{dataField:"metodoLab",caption:"Método",fixed:!0,fixedPosition:"left",width:12*h}),i.jsx(C,{dataField:"unidadLab",caption:"Unidad",fixed:!0,fixedPosition:"left",width:5*h}),i.jsx(W,{allowUpdating:u==="excel",allowAdding:!1,allowDeleting:!1,mode:"cell"}),Object.keys(s.data[0]).filter(p=>!["compuestoId","metodoId","unidadId","compuestoLab","metodoLab","unidadLab"].includes(p)).map(p=>i.jsx(C,{dataField:p,caption:p,cellRender:({value:m})=>ue(m)},p))]})}),i.jsxs(_,{title:"Asignación Compuestos",colCount:12,children:[i.jsx(y,{colSpan:9,children:i.jsx(so,{adelantoData:s,setAdelantoData:l,matrizId:e.matrizId})}),i.jsx(y,{colSpan:3,children:i.jsx(ro,{adelantoData:s,setAdelantoData:l,muestras:d})})]})]})]})}const X=async(e,o,t,n,a,s,l,d,u,f)=>{if(e){console.log(o.name,t);try{const{matrizLab:h,muestrasListLab:r,warnMessages:p}=await We(o,t,d);p.length>0&&u({visible:!0,message:p.join(`
`),type:"warning"});const m=await Qe(h,n.matrizId),x=await Ye(r,l.muestras);a({data:m,muestras:x}),f("excel")}catch(h){console.error("Error:",h),u({visible:!0,message:`Error al procesar el archivo: ${h.message||h}`,type:"error"}),s(r=>({...r,adelanto:[]}))}}},lo=(e,o,t)=>{let n=[];const a=o.data.filter(l=>l.compuestoId===null||l.metodoId===null||l.unidadId===null);a.length>0&&n.push(`Hay ${a.length} compuestos sin asignar.`);const s=o.muestras.filter(l=>l.muestraCadena===null);return s.length>0&&n.push(`Hay ${s.length} muestras sin referencia en la cadena de custodia.`),n.length>0?(t({visible:!0,message:`Error: ${n.join(" ")}`,type:"warning"}),!1):!0},co=async(e,o,t,n,a)=>{try{if(!lo(o,t,n))return;const s=await pe(o,t);n({visible:!0,message:"Protocolo guardado exitosamente.",type:"success"}),a()}catch(s){console.error("Error al guardar el protocolo:",s),n({visible:!0,message:`Error al guardar el protocolo: ${s.message}`,type:"error"})}},uo=async(e,o,t,n,a)=>{if(e)try{const s=await me(e);o({data:s.adelantoData.data,muestras:s.adelantoData.muestras}),a("protocolo")}catch(s){console.error("Error:",s),n({visible:!0,message:`Error al cargar el protocolo: ${s.message||s}`,type:"error"}),t(l=>({...l,adelanto:[]}))}};function Po(){const[e,o]=M.useState({visible:!1,message:"",type:"info"}),[t,n]=M.useState({data:[],muestras:[]}),[a,s]=M.useState([]),[l,d]=M.useState(null),[u,f]=M.useState({subproyecto:null,evento:null,laboratorio:null,adelanto:null,matrizId:null,protocoloSeleccionado:null,indicePagina:0}),[h,r]=M.useState(null),[p,m]=M.useState([]),[x,g]=M.useState(null),{laboratorios:c}=ie(),{subproyectos:w}=re(),{eventos:E}=se(!1),{matrizEvento:L}=ye(u.evento),{matrices:I}=ce(),{protocolos:S}=oo(u.evento,u.matrizId,u.laboratorio),k=()=>{n({data:[],muestras:[]}),f({subproyecto:null,evento:null,laboratorio:null,adelanto:null,matrizId:null,protocoloSeleccionado:null,indicePagina:0}),s([]),d(null),r(null),m([]),g(null)},O=M.useCallback(async b=>{const F={...u,[b.dataField]:b.value};if(b.dataField==="subproyecto"&&s(E.filter(j=>j.subproyectoId===b.value)),["subproyecto","evento","matrizId","laboratorio"].includes(b.dataField)&&(d(null),n({data:[],muestras:[]}),F.adelanto=null,F.protocoloSeleccionado=null),b.dataField==="adelanto"&&b.value){const j=b.value[0],P=c.find(z=>z.id===F.laboratorio),{workbook:N,sheets:te}=await De(j,P.formato),$=te.map(z=>({id:z.id,name:z.name}));if(r(j),g(N),m($),$.length===1){const z=$[0].id;console.log("Hoja seleccionada automaticamente: ",z),F.indicePagina=z,await X(j,N,z,F,n,f,L,P==null?void 0:P.formato,o,d)}else F.indicePagina=0}if(b.dataField==="indicePagina"&&b.value!=null&&h){F.indicePagina=b.value;const j=c.find(N=>N.id===F.laboratorio),P=b.value;console.log("Hoja seleccionada: ",P),await X(h,x,P,F,n,f,L,j==null?void 0:j.formato,o,d)}if(b.dataField==="importados"&&b.value){const j=S.find(P=>P.id===b.value);F.adelanto=j?[{name:j.nombre}]:null,await uo(b.value,n,f,o,d)}f(F)},[E,L,c,S,h,x,p]);return i.jsxs("div",{children:[i.jsx(ae,{formData:u,onFieldDataChanged:O,colCount:12,children:t.data.length<=0?i.jsx(to,{subproyectos:w,laboratorios:c,filteredEventos:a,matrices:I,formData:u,protocolos:S,excelPages:p}):i.jsxs(i.Fragment,{children:[i.jsx(io,{subproyectos:w,laboratorios:c,eventos:E,matrices:I,formData:u,adelantoData:t,setAdelantoData:n,muestras:L.muestras,modo:l}),i.jsxs(V,{cssClass:"buttons-group",colSpan:12,colCount:12,children:[i.jsx(q,{colSpan:8}),l!="protocolo"?i.jsx(J,{colSpan:2,buttonOptions:{text:"Confirmar",width:"100%",type:"default",onClick:b=>co(b,u,t,o,k)}}):i.jsx(q,{colSpan:2}),i.jsx(J,{colSpan:2,buttonOptions:{text:"Cancelar",width:"100%",type:"default",onClick:k}})]})]})}),i.jsx(fe,{visible:e.visible,message:e.message,type:e.type,displayTime:4e3,onHiding:()=>o({...e,visible:!1})})]})}export{Po as default};
