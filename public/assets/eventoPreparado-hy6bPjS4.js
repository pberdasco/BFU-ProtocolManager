import{j as c,S as L,_ as q,$ as Y,af as ce,r as R,F as ue,a0 as _}from"./index-DxIfR8rB.js";import{T as me}from"./toast-DwSVZDn8.js";import"./tag-box-BSsJpT0o.js";import{f as fe}from"./localization-DlSvhbZG.js";import{D as pe,b as ge,a as be,I as Ce,E as xe,C as $}from"./data-grid-IbXsafsR.js";import{e as he}from"./excelExport-OaVydRV0.js";import{f as ee}from"./specialValues-CHSjwz8L.js";import{u as ve}from"./subproyectos-C5uZQa17.js";import{u as ye}from"./eventos-RF303lcB.js";import{u as Ee}from"./matrices-BSQd1T2g.js";import{u as we}from"./compuestos-D_eDBQfj.js";import{u as Se}from"./metodos-2hyBTFQV.js";import{u as Fe}from"./um-CEkkwIlb.js";import{u as V}from"./useQuery-u5ONSuT_.js";import{a as Ie,A as te}from"./apiResource-5P-thon0.js";import{u as Oe}from"./laboratorios-Bghc6xCp.js";import{b as je,c as ze}from"./cadenaCompletaDataAccess-Dvit168Y.js";import{E as Ae}from"./exceljs.min-Cm9aiCzu.js";import{F as Me}from"./export_merged_ranges_manager-VIrBL5Rb.js";import"./m_utils.scroll-Dy5AD996.js";import"./m_export-CsJrd_c-.js";const Ge=[{nombre:"Original",id:1},{nombre:"Reducido",id:2},{nombre:"Muy Reducido",id:3}];function Re({subproyectos:e,matrices:o,filteredEventos:a,setColor:n}){return c.jsxs(c.Fragment,{children:[c.jsx(L,{dataField:"subproyecto",editorType:"dxSelectBox",colSpan:3,editorOptions:{dataSource:e,displayExpr:l=>l?`${l.codigo} - ${l.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0},children:c.jsx(q,{text:"Seleccione un Subproyecto"})}),c.jsx(L,{dataField:"matriz",editorType:"dxSelectBox",colSpan:1,editorOptions:{dataSource:o,displayExpr:"nombre",valueExpr:"id",searchEnabled:!1},children:c.jsx(q,{text:"Matriz"})}),c.jsx(L,{dataField:"evento",editorType:"dxSelectBox",colSpan:3,editorOptions:{dataSource:a,displayExpr:l=>l?`${fe(new Date(l.fecha),"dd/MM/yyyy")} - ${l.nombre}`:"",valueExpr:"id",searchEnabled:!0},children:c.jsx(q,{text:"Seleccione un Evento de Muestreo"})}),c.jsx(Y,{colSpan:1}),c.jsx(L,{dataField:"mostrar",editorType:"dxSelectBox",colSpan:2,editorOptions:{dataSource:Ge,displayExpr:"nombre",valueExpr:"id",searchEnabled:!1},children:c.jsx(q,{text:"Mostrar"})}),c.jsx(L,{dataField:"colorear",editorType:"dxCheckBox",colSpan:1,label:{text:"Regulaciones",showColon:!0},editorOptions:{text:"Colorear",onValueChanged:l=>n(l.value)}}),c.jsx(Y,{colSpan:1})]})}function Ne({filas:e,muestras:o,compuestos:a,metodos:n,UM:l,colorActive:p,onRowPrepared:t}){function C(s){var u;if(p&&s.rowType==="data"){const g=(u=s.column)==null?void 0:u.dataField;if(!g||["compuestoId","metodoId","umId","nivelGuia","nivelGuiaUM"].includes(g))return;const r=s.value,d=parseFloat(s.data.nivelGuia);if(isNaN(d)||r===null||r===void 0||r===-3)return;d===-1?r>0?s.cellElement.style.backgroundColor="red":(r===-1||r===-2||r===0)&&(s.cellElement.style.backgroundColor="green"):d===-2?s.cellElement.style.backgroundColor="green":d===-3?r>0||r===-1?s.cellElement.style.backgroundColor="red":(r===-2||r===0)&&(s.cellElement.style.backgroundColor="green"):r>d?s.cellElement.style.backgroundColor="red":s.cellElement.style.backgroundColor="green"}}function m(s){he(s.component,"ReporteEventoPreparado.xlsx")}return c.jsx(ce,{colSpan:12,children:c.jsxs(pe,{dataSource:e,keyExpr:"id",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:450,scrolling:{mode:"virtual"},onCellPrepared:C,onRowPrepared:t,onExporting:m,children:[c.jsx(ge,{enabled:!0,allowExportSelectedData:!0,fileName:"ReporteEventoPreparado"}),c.jsx(be,{children:c.jsx(Ce,{name:"exportButton"})}),c.jsx(xe,{mode:"cell",allowUpdating:!0,allowDeleting:!0}),c.jsx($,{dataField:"compuestoId",caption:"Compuesto",allowEditing:!1,width:220,lookup:{dataSource:a,valueExpr:"id",displayExpr:"nombre"},fixed:!0,fixedPosition:"left"}),c.jsx($,{dataField:"metodoId",caption:"Método",allowEditing:!1,width:220,lookup:{dataSource:n,valueExpr:"id",displayExpr:"nombre"}}),c.jsx($,{dataField:"umId",caption:"UM",width:80,lookup:{dataSource:l,valueExpr:"id",displayExpr:"nombre"}}),c.jsx($,{dataField:"nivelGuia",caption:"NG",width:100,cellRender:({value:s})=>Ue(s)}),o.map(s=>c.jsx($,{dataField:s.muestra,caption:s.muestra,cellRender:({value:u})=>ee(u,!1)},s.muestra))]})})}function Ue(e){return e==null?"NL":Number(e)===-1?"<LC":Number(e)===-2?"SAT/SOL":Number(e)===-3?"<LD":Number(e)||e}const W=async e=>{const o=new Ie("regulados");if(e===null)return[];const a=e!==0?["autAplicacionId","=",e]:null;return(await o.fetch({filter:a})).data},ke=({agua:e,suelo:o,gases:a,FLNA:n})=>{const l=V({queryKey:["regulados","agua",e],queryFn:()=>W(e),enabled:!!e}),p=V({queryKey:["regulados","suelo",o],queryFn:()=>W(o),enabled:!!o}),t=V({queryKey:["regulados","gases",a],queryFn:()=>W(a),enabled:!!a}),C=V({queryKey:["regulados","FLNA",n],queryFn:()=>W(n),enabled:!!n}),s=[...l.data||[],...p.data||[],...t.data||[],...C.data||[]].reduce((g,r)=>{const d=r.compuestoId,E=new Date(r.fechaVigencia);return(!g[d]||new Date(g[d].fechaVigencia)<E)&&(g[d]=r),g},{});return{regulados:Object.values(s),isLoadingRegulados:l.isLoading||p.isLoading||t.isLoading||C.isLoading,errorRegulados:l.error||p.error||t.error||C.error}};function De(e){const o=["id","cadenaCustodiaId","compuestoId","estado","metodoId","umId","protocoloItemId","codigo","nivelGuia","nivelGuiaOriginalUM","nivelGuiaOriginal"];return Object.entries(e).some(([n,l])=>o.includes(n)?!1:typeof l=="number"&&l>0)}function Te(e,o,a){if(o===1)return!0;const n=a.find(l=>l.id===e.compuestoId);if(!n)return!0;if(o===2)return n.exponeId!=0;if(o===3)return n.exponeId==1||n.exponeId==2&&De(e)}function oe(e,o,a){return{muestras:e.muestras,filas:e.filas.filter(n=>Te(n,o,a))}}async function Le(e,o,a){try{const[n,l]=await Promise.all([je(e,o),ze()]);if(n&&n.filas&&n.filas.length>0)return n.filas=Be(n.filas,a,l),n;throw new Error("Evento preparado no ha devuelto datos")}catch(n){throw n}}const $e=(e,o)=>{const a=Math.pow(10,o);return Number((Math.round(e*a)/a).toFixed(o))};function Be(e,o,a){const n=Object.fromEntries(o.map(p=>[p.compuestoId,p])),l=new Map;return a.forEach(p=>{l.set(`${p.desdeUMId}-${p.hastaUMId}`,parseFloat(p.factor))}),e.map(p=>{const t=n[p.compuestoId];if(!t)return{...p,nivelGuia:null,nivelGuiaOriginal:null,nivelGuiaOriginalUM:null};const C=parseFloat(t.valorReferencia),m=t.umId,s=p.umId;if(C===-1||C===-2||C===-3)return{...p,nivelGuia:C,nivelGuiaOriginal:C,nivelGuiaOriginalUM:m};if(isNaN(C))return{...p,nivelGuia:null,nivelGuiaOriginal:null,nivelGuiaOriginalUM:m};let u=C;if(s!==m){const g=l.get(`${m}-${s}`);g?u=$e(C*g,5):u=null}return{...p,nivelGuia:u,nivelGuiaOriginal:C,nivelGuiaOriginalUM:m}})}const re=3,H=4,Pe=1,ae=2,le=2,ne=35,se=15,D=12,N=11,K="FF00B050",Q="FFFF0000",G="FFFFFFFF",Z="FF808080",M="FFD9D9D9",z={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},X={AGUA:1,SUELO:3,GASES:4};function qe(e){let o="";for(;e>0;){const a=(e-1)%26;o=String.fromCharCode(65+a)+o,e=Math.floor((e-a)/26)}return o}function ie(e,o,a){if(!a||isNaN(o)||e===null||e===void 0||e===-3)return G;if(o===-1)return e>0?Q:e===-1||e===-2||e===0?K:G;if(o===-2)return K;if(o===-1)return e>0||e===-1?Q:e===-2||e===0?K:G;if(typeof e=="number"){if(e>o)return Q;if(e<=o)return K}return G}function de(e,o){var a;return((a=o.find(n=>n.id===e.compuestoId))==null?void 0:a.nombre)||`Compuesto ${e.compuestoId}`}function Ve(e,o){var a;return((a=o.find(n=>n.id===e.umId))==null?void 0:a.nombre)||`UM ${e.umId}`}async function We(e,o,a,n,l){const p=new Ae.Workbook,t=p.addWorksheet("Muestras");if(o===X.AGUA||o===X.GASES){const s=1+e.filas.length;let u=0;for(const g of e.muestras){if(g.tipo!==1)continue;const r=u%re*(H+Pe)+1,d=Math.floor(u/re)*(s+ae)+1;t.getColumn(r).width=10,t.getColumn(r+1).width=ne,t.getColumn(r+2).width=se,t.getColumn(r+3).width=10,t.mergeCells(d,r,d,r+H-1);const E=t.getCell(d,r);E.value=g.muestra||"",E.alignment={horizontal:"center",vertical:"middle"},E.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},E.font={name:"Arial",size:D,bold:!1,color:{argb:G}},E.border=z;const w=d+1;let v=w;for(const i of e.filas){const S=i[g.muestra],F=ee(i[g.muestra],!1)??"",k=de(i,a),b=Ve(i,n),I=isNaN(i.nivelGuia)?NaN:parseFloat(i.nivelGuia);t.getCell(v,r).value="";const T=t.getCell(v,r+1);T.value=k,T.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},T.font={name:"Arial",size:D,bold:!1};const B=t.getCell(v,r+2);B.value=F,B.font={name:"Arial",size:N,bold:!1},B.alignment={horizontal:"center",vertical:"middle"},B.fill={type:"pattern",pattern:"solid",fgColor:{argb:ie(S,I,l)}};const P=t.getCell(v,r+3);P.value=b,P.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},P.alignment={horizontal:"center",vertical:"middle"},P.font={name:"Arial",size:N,bold:!1};for(let J=r;J<r+H;J++)t.getCell(v,J).border=z;v++}const O=w,A=v-1,h=qe(r),x=`${h}${O}:${h}${A}`;t.mergeCells(x);const f=t.getCell(O,r);f.value="Compuesto",f.alignment={horizontal:"center",vertical:"middle",textRotation:90},f.font={name:"Arial",size:D,bold:!1},f.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}};for(let i=O;i<=A;i++)t.getCell(i,r).border=z;const y=r+3;let j=!0;const U=t.getCell(w,y).value;for(let i=w;i<v;i++)if(t.getCell(i,y).value!==U){j=!1;break}if(j){t.mergeCells(w,y,v-1,y);const i=t.getCell(w,y);i.alignment={horizontal:"center",vertical:"middle"},i.font={name:"Arial",size:N,bold:!1},i.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}else{let i=w,S=t.getCell(i,y).value;for(let F=w+1;F<v;F++){const k=t.getCell(F,y).value;if(k!==S){if(F-i>=le){t.mergeCells(i,y,F-1,y);const b=t.getCell(i,y);b.alignment={horizontal:"center",vertical:"middle"},b.font={name:"Arial",size:N,bold:!1},b.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}i=F,S=k}}if(v-i>=le){t.mergeCells(i,y,v-1,y);const F=t.getCell(i,y);F.alignment={horizontal:"center",vertical:"middle"},F.font={name:"Arial",size:N,bold:!1},F.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}}u++}}else if(o===X.SUELO){const m=e.muestras.filter(g=>g.tipo===1),s=[...new Set(m.map(g=>g.pozo))];let u=1;for(const g of s){const r=m.filter(h=>h.pozo===g);r.sort((h,x)=>h.profundidad-x.profundidad);const d=1;t.getColumn(d).width=ne;for(let h=0;h<r.length;h++)t.getColumn(d+1+h).width=se;const E=t.getCell(u,d);E.value="INTERVENCION",E.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},E.font={name:"Arial",size:D,bold:!0,color:{argb:G}},E.alignment={horizontal:"center",vertical:"middle"},E.border=z,r.forEach((h,x)=>{const f=t.getCell(u,d+1+x);f.value=h.muestra,f.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},f.font={name:"Arial",size:D,bold:!0,color:{argb:G}},f.alignment={horizontal:"center",vertical:"middle"},f.border=z});const w=u+1,v=t.getCell(w,d);v.value="COMPUESTOS",v.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},v.font={name:"Arial",size:D,bold:!1},v.alignment={horizontal:"center",vertical:"middle"},v.border=z,r.forEach((h,x)=>{const f=t.getCell(w,d+1+x);f.value=h.profundidad,f.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},f.font={name:"Arial",size:N,bold:!1},f.alignment={horizontal:"center",vertical:"middle"},f.border=z});const O=u+2;t.mergeCells(w,d,O,d),r.forEach((h,x)=>{const f=e.filas.find(S=>S[h.muestra]!==void 0);let y=f==null?void 0:f.umId,j=n.find(S=>S.id===y),U=(j==null?void 0:j.nombre)||"UM";const i=t.getCell(O,d+1+x);i.value=U,i.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},i.font={name:"Arial",size:N,bold:!1},i.alignment={horizontal:"center",vertical:"middle"},i.border=z});let A=u+3;for(const h of e.filas){const x=de(h,a),f=t.getCell(A,d);f.value=x,f.fill={type:"pattern",pattern:"solid",fgColor:{argb:G}},f.font={name:"Arial",size:D,bold:!1},f.alignment={vertical:"middle"},f.border=z,r.forEach((y,j)=>{const U=ee(h[y.muestra],!1)??"",i=isNaN(h.nivelGuia)?NaN:parseFloat(h.nivelGuia),S=t.getCell(A,d+1+j);S.value=U,S.font={name:"Arial",size:N,bold:!1},S.alignment={horizontal:"center",vertical:"middle"},S.border=z,S.fill={type:"pattern",pattern:"solid",fgColor:{argb:ie(valorMuestraNumerico,i,l)}}}),A++}u=A+ae}}const C=await p.xlsx.writeBuffer();Me.saveAs(new Blob([C]),"muestrasCDI.xlsx")}async function Ke(e,o,a,n,l,p,t){const C={proyecto:o.codigo,fecha:a.fecha,data:n};C.data.compuestos=p,C.data.nivelesGuia=l,C.data.laboratorios=t;try{const m=await fetch(`${te}cadenatodoctabla`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(C)});if(!m.ok){const w=(await m.json()).message||`Error al obtener los datos del evento: ${m.statusText}`;throw new Error(w)}const s=await m.json();if(!s.file)throw new Error("No se recibió un nombre de archivo válido");const u=await fetch(`${te}cadenatodoctabla/${s.file}`);if(!u.ok)throw new Error(`Error al descargar el archivo: ${u.statusText}`);const g=await u.blob(),r=window.URL.createObjectURL(g),d=document.createElement("a");d.href=r,d.download=s.file,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(r),e({visible:!0,message:"Exportación exitosa",type:"success"})}catch(m){e({visible:!0,message:(m==null?void 0:m.message)||"Error al exportar tablas",type:"error"})}}function pt(){var k;const[e,o]=R.useState([]),[a,n]=R.useState(!1),[l,p]=R.useState({subproyecto:null,matriz:null,evento:null,mostrar:1}),[t,C]=R.useState([]),[m,s]=R.useState([]),[u,g]=R.useState({visible:!1,message:"",type:"info"}),{subproyectos:r}=ve(),{eventos:d}=ye(!1),{matrices:E}=Ee(),{laboratorios:w}=Oe(),v=[...E,{id:0,codigo:0,nombre:"Todos"}],{compuestos:O}=we(),{metodos:A}=Se(),{UM:h}=Fe(),x=r.find(b=>b.id===l.subproyecto),f={agua:(x==null?void 0:x.autAplicacionAguaId)||null,suelo:(x==null?void 0:x.autAplicacionSueloId)||null,gases:(x==null?void 0:x.autAplicacionGasesId)||null,FLNA:(x==null?void 0:x.autAplicacionFLNAId)||null},{regulados:y}=ke(f),j=d.find(b=>b.id===l.evento),U=()=>{s({filas:[],muestras:[]}),p({subproyecto:null,matriz:null,evento:null,mostrar:1})},i=b=>{n(b)},S=R.useCallback(async b=>{if(b.dataField==="subproyecto")o(d.filter(I=>I.subproyectoId===b.value));else if(b.dataField==="evento")try{const I=await Le(b.value,l.matriz,y);C(I);const T=oe(I,l.mostrar,O);s(T)}catch(I){C({filas:[],muestras:[]}),s({filas:[],muestras:[]}),g({visible:!0,message:`(${I.status||"NS"}) ${I.message||I}`,type:"error"})}else if(b.dataField==="matriz")C({filas:[],muestras:[]}),s({filas:[],muestras:[]});else if(b.dataField==="mostrar"&&t){const I=oe(t,b.value,O);s(I)}p(I=>({...I,[b.dataField]:b.value,...b.dataField==="matriz"?{evento:null}:{}}))},[l,d,m]),F=R.useCallback(b=>{b.rowType},[]);return c.jsxs("div",{children:[c.jsxs(ue,{formData:l,onFieldDataChanged:S,colCount:12,children:[c.jsx(Re,{subproyectos:r,matrices:v,filteredEventos:e,setColor:i}),((k=m.filas)==null?void 0:k.length)>0&&c.jsxs(c.Fragment,{children:[c.jsx(Ne,{filas:m.filas,muestras:m.muestras,compuestos:O,metodos:A,UM:h,colorActive:a,onRowPrepared:F}),c.jsxs(ce,{cssClass:"buttons-group",colSpan:12,colCount:12,children:[c.jsx(Y,{colSpan:8}),l.matriz===0&&c.jsx(_,{colSpan:2,buttonOptions:{text:"Exportar Tablas",type:"default",width:200,onClick:b=>Ke(g,x,j,m,y,O,w)}}),l.matriz!==0&&c.jsx(_,{colSpan:2,buttonOptions:{text:"Exportar CDI",type:"default",width:200,onClick:b=>We(m,l.matriz,O,h,a)}}),c.jsx(_,{colSpan:2,buttonOptions:{text:"Cancelar",type:"default",width:200,onClick:b=>U()}})]})]})]}),c.jsx(me,{visible:u.visible,message:u.message,type:u.type,displayTime:4e3,onHiding:()=>g({...u,visible:!1})})]})}export{pt as default};
