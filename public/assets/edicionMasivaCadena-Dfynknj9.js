import{r as f,C as W,j as e,B as U,F as Z,S as k,_ as V}from"./index-BkPAYC4t.js";import{f as J}from"./localization-D8w3L9Lu.js";import{T as K}from"./toast-YCVj4MMS.js";import{u as X}from"./subproyectos-BGw0_UMO.js";import{u as q}from"./eventos-DRwgwRrc.js";import{u as Q}from"./cadenas-DqncSTh1.js";import{E as Y}from"./exceljs.min-DwoinmsD.js";import{F as ee}from"./m_file_uploader-CMQ6q2Vg.js";import{D as oe,E as te,a as ae,I as G,C as S,L as I}from"./data-grid-BNyC2bq0.js";import{t as le,M as T}from"./muestrasConfig-CwDeG0hD.js";import{u as se}from"./pozosDeSubproyecto-CigqRIAy.js";import{A as ne}from"./apiResource-CLOj6waL.js";import{f as re}from"./cadenaCompletaDataAccess-d8WUpXRw.js";import{e as ie}from"./excelExport-D3xDkmLP.js";import"./useQuery-BAPTrFW-.js";import"./m_export-BPchivYo.js";import"./export_merged_ranges_manager-yK1-asbs.js";/*!
 * devextreme-react
 * Version: 24.2.3
 * Build date: Fri Dec 06 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-react
 */const ce=f.memo(f.forwardRef((s,d)=>{const o=f.useRef(null);f.useImperativeHandle(d,()=>({instance(){var m;return(m=o.current)==null?void 0:m.getInstance()}}),[o.current]);const n=f.useMemo(()=>["value"],[]),a=f.useMemo(()=>["onBeforeSend","onContentReady","onDisposing","onDropZoneEnter","onDropZoneLeave","onFilesUploaded","onInitialized","onProgress","onUploadAborted","onUploaded","onUploadError","onUploadStarted","onValueChanged"],[]),E=f.useMemo(()=>({defaultValue:"value"}),[]);return f.createElement(W,{WidgetClass:ee,ref:o,subscribableOptions:n,independentEvents:a,defaults:E,...s})})),de=ne;async function ue(s,d){const o=await fetch(`${de}muestras/${s}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!o.ok)throw new Error("Error al guardar la Muestra completa");return await o.json()}async function pe(s,d){if(!s.value){d([]);return}try{const o=await re(s.value);o&&o.filas?d(o.muestras):d([])}catch(o){console.error("Error al cargar la cadena completa guardada:",o)}}const _={default:{filaTitulos:1,colMatriz:5,colMuestra:6,colCadena:7,colProtocolo:8,colNivelFreatico:9,colNivelFLNA:10,encabezadosEsperados:{colMatriz:["tipo muestra","matriz","tipo"],colMuestra:["nombre muestra","muestra","id muestra"]}},CITSA:{filaTitulos:1,colMatriz:5,colMuestra:6,colCadena:7,colProtocolo:8,colNivelFreatico:9,colNivelFLNA:10,encabezadosEsperados:{colMatriz:["tipo muestra","matriz","tipo"],colMuestra:["nombre muestra","muestra","id muestra"],colCadena:["Cadena de Custodia"]}}},me=(s,d,o)=>{const n=o.encabezadosEsperados||{},a=[];return Object.entries(n).forEach(([E,m])=>{var C,y;const j=o[E],i=s.getRow(d).getCell(j).value,u=(y=(C=i==null?void 0:i.toString())==null?void 0:C.trim())==null?void 0:y.toLowerCase();if(!(Array.isArray(m)?m.some(h=>u==null?void 0:u.includes(h.toLowerCase())):u==null?void 0:u.includes(m.toLowerCase()))){const h=Array.isArray(m)?m.join('" o "'):m;a.push(`Columna ${j}: se esperaba "${h}"`)}}),a},H=s=>(s==null?void 0:s.toString().toLowerCase().replace(/[.,;:/()_*\+\-\s]/g,""))||"",fe=s=>{const d=/\b(MA|MS|MG|MP)[ -]?\S+\b/i,o=s==null?void 0:s.toString().match(d);return o?o[0].replace("-"," "):null},ve=(s,d,o,n,a,E)=>{const m=[...d],j=[];let i=!1;return s.eachRow((u,L)=>{var N,x,A,t,l,r;if(L<=o.filaTitulos)return;const C=(N=u.getCell(o.colMatriz).value)==null?void 0:N.toString().toUpperCase().trim();if(!n(C))return;const y=(x=u.getCell(o.colMuestra).value)==null?void 0:x.toString(),h=fe(y);if(!h)return;const O=H(h),v=m.find(c=>H(c.muestra)===O);if(v){const c=((t=(A=u.getCell(o.colCadena).value)==null?void 0:A.toString())==null?void 0:t.trim())||null,p=((r=(l=u.getCell(o.colProtocolo).value)==null?void 0:l.toString())==null?void 0:r.trim())||null,b=a==null?void 0:a.getRowIndexByKey(v.muestraId);if(v.cadenaOPDS=c,a==null||a.cellValue(b,"cadenaOPDS",c),i=!0,v.protocoloOPDS=p,a==null||a.cellValue(b,"protocoloOPDS",p),i=!0,E){const g=parseFloat(u.getCell(o.colNivelFreatico).value);isNaN(g)||(v.nivelFreatico=g,a==null||a.cellValue(b,"nivelFreatico",g),i=!0);const w=parseFloat(u.getCell(o.colNivelFLNA).value);isNaN(w)||(v.nivelFLNA=w,a==null||a.cellValue(b,"nivelFLNA",w),i=!0)}}else j.push(h)}),{nuevasMuestras:m,noEncontradas:j,cambios:i}};function xe({muestras:s=[],cadenaId:d,subproyectoId:o,matrizId:n,setToastOptions:a,onSalir:E,setMuestrasCadena:m}){const j=f.useRef(null),[i,u]=f.useState(null),{pozos:L}=se(o),C=n===T.FLNA,y=n===T.SUELO,h=n===T.AGUA,O=n===T.GASES,v=n===T.AGUA||n===T.FLNA,N=async t=>{const l="NivelesyOPDS.xlsx",r=t.component;r.hasEditData()&&await r.saveEditData(),ie(r,l)},x=async(t,l="default")=>{const r=t.value[0];if(!r)return;const c=_[l]||_.default,p=await r.arrayBuffer(),b=new Y.Workbook;await b.xlsx.load(p);const g=b.worksheets[0],w=c.filaTitulos||1;if(me(g,w,c).length>0){a({visible:!0,message:"El archivo no tiene el formato esperado",type:"error"});return}const D=F=>h&&F.includes("AGUA")||C&&F.includes("FLNA")||y&&F.includes("SUELO")||O&&F.includes("AIRE"),{nuevasMuestras:B,noEncontradas:R,cambios:P}=ve(g,s,c,D,i,v);m(B);let M="";if(P?M="Importación desde Excel completada.":M="Importacion completada sin cambios encontrados",R.length>0){const F=[...new Set(R)];M+=`

 Hay muestras en el excel no encontradas en la grilla:
- ${F.join(`
- `)}`}a({visible:!0,message:M,type:R.length>0?"warning":"success"})},A=async t=>{if(t.changes.length>0){t.cancel=!0;try{const l=[...s];for(const r of t.changes){const c=r.key,p=l.findIndex(w=>w.muestraId===c);if(p===-1)continue;const g={...l[p],...r.data,cadenaCustodiaId:d};await ue(c,g),l[p]=g}i.cancelEditData(),m(l),a({visible:!0,message:"Cambios guardados correctamente",type:"success"})}catch(l){console.error(l),a({visible:!0,message:"Error al guardar cambios",type:"error"})}}};return e.jsxs("div",{style:{marginTop:10},children:[e.jsxs(oe,{ref:j,onInitialized:t=>u(t.component),dataSource:s,height:500,rowAlternationEnabled:!0,keyExpr:"muestraId",showBorders:!0,columnAutoWidth:!0,repaintChangesOnly:!1,onExporting:N,paging:{pageSize:30},scrolling:{mode:"standard"},export:{enabled:!0,allowExportSelectedData:!1},onSaving:A,focusedCellEnabled:!0,onEditorPreparing:t=>{if(t.parentType==="dataRow"&&(t.editorName==="dxTextBox"||t.editorName==="dxNumberBox")){const l=t.editorOptions.onKeyDown;t.editorOptions.onKeyDown=r=>{var c;if(r.event.key==="Enter"){const p=t.component,b=(c=t.row)==null?void 0:c.rowIndex,w=p.getVisibleColumns().findIndex(F=>F.dataField===t.dataField),z=r.event.target.value;let D=z;t.dataType==="number"&&(D=z===""?null:Number(z));const B=p.cellValue(b,t.dataField);r.event.preventDefault(),D!==B&&p.cellValue(b,t.dataField,D),p.closeEditCell();const R=p.getDataSource().items(),P=b+1>=R.length,M=P?b:b+1;setTimeout(()=>{var F;if(!P){const $=p.getRowElement(M);$&&((F=p.getScrollable())==null||F.scrollToElement($))}setTimeout(()=>{p.editCell(M,w)},10)},10)}l==null||l(r)}}},children:[e.jsx(te,{mode:"batch",allowUpdating:!0}),e.jsxs(ae,{children:[e.jsx(G,{location:"before",html:'<div class="toolbar-title">Niveles y OPDS</div>'}),e.jsx(G,{location:"after",children:e.jsxs("div",{style:{position:"relative",display:"inline-block"},children:[e.jsx(U,{icon:"upload",hint:"Importar Excel",stylingMode:"outlined"}),e.jsx(ce,{accept:".xlsx",uploadMode:"useForm",showFileList:!1,labelText:"",selectButtonText:"",style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",opacity:0,cursor:"pointer",zIndex:10},onValueChanged:t=>{const l=t.value[0];l&&x({value:[l]})}})]})}),e.jsx(G,{name:"exportButton",location:"after"})]}),e.jsx(S,{dataField:"muestraId",caption:"ID",allowEditing:!1,visible:!1}),e.jsx(S,{dataField:"tipo",caption:"Tipo",allowEditing:!1,children:e.jsx(I,{dataSource:le,valueExpr:"value",displayExpr:"text"})}),e.jsx(S,{dataField:"pozo",caption:"pozo",allowEditing:!1,children:e.jsx(I,{dataSource:L,valueExpr:"id",displayExpr:"nombre"})}),e.jsx(S,{dataField:"muestra",caption:"Muestra",allowEditing:!1}),e.jsx(S,{dataField:"nivelFreatico",caption:"Nivel Freático",allowEditing:v,visible:v,dataType:"number",format:"#0.000",setCellValue:(t,l,r)=>{t.nivelFreatico=l,r.nivelFLNA==null||r.nivelFLNA==null?t.flna=null:t.flna=r.nivelFLNA==0?0:l-r.nivelFLNA},validationRules:[{type:"range",min:0,message:"Debe ser mayor o igual a 0"}]}),e.jsx(S,{dataField:"nivelFLNA",caption:"Nivel FLNA",allowEditing:v,visible:v,dataType:"number",format:"#0.000",setCellValue:(t,l,r)=>{const c=l===""||l===null||l===void 0?null:l;t.nivelFLNA=c,c==null?t.flna=null:t.flna=c==0?0:(r.nivelFreatico||0)-c},validationRules:[{type:"range",min:0,message:"Debe ser mayor o igual a 0"}]}),e.jsx(S,{dataField:"flna",caption:"Espesor FLNA",dataType:"number",format:"#0.000",visible:v,allowEditing:!1}),e.jsx(S,{dataField:"profundidad",caption:"Profundidad",dataType:"number",visible:y,allowEditing:!1,format:"#0.0"}),e.jsx(S,{dataField:"cadenaOPDS",caption:"Cadena OPDS",visible:!0,allowEditing:!0,editorOptions:{showClearButton:!0}}),e.jsx(S,{dataField:"protocoloOPDS",caption:"Protocolo OPDS",visible:!0,allowEditing:!0,editorOptions:{showClearButton:!0}})]}),e.jsxs("div",{style:{marginTop:30,textAlign:"right"},children:[e.jsx(U,{text:"Guardar",type:"default",onClick:()=>i==null?void 0:i.saveEditData()}),e.jsx(U,{text:"Salir  ",type:"default",onClick:E})]})]})}function ze(){var N;const[s,d]=f.useState([]),[o,n]=f.useState({subproyecto:null,evento:null,cadena:null}),[a,E]=f.useState([]),[m,j]=f.useState(!1),[i,u]=f.useState({visible:!1,message:"",type:"info"}),{subproyectos:L}=X(),{eventos:C}=q(!1),{cadenas:y}=Q(o.evento),h=()=>{E([]),n({subproyecto:null,evento:null,cadena:null})},O=f.useCallback(async x=>{x.dataField==="subproyecto"?(d(C.filter(A=>A.subproyectoId===x.value)),n({subproyecto:x.value,evento:null,cadena:null}),E([])):x.dataField==="cadena"&&await pe(x,E),n(A=>({...A,[x.dataField]:x.value}))},[o,C,y,a]),v=((N=y==null?void 0:y.find(x=>x.id===o.cadena))==null?void 0:N.matrizCodigo)||null;return e.jsxs("div",{children:[e.jsxs(Z,{formData:o,onFieldDataChanged:O,colCount:4,children:[e.jsx(be,{subproyectos:L,filteredEventos:s,cadenas:y}),o.cadena&&e.jsx(e.Fragment,{children:e.jsx(xe,{muestras:a,cadenaId:o.cadena,subproyectoId:o.subproyecto,matrizId:v,setToastOptions:u,onSalir:h,setMuestrasCadena:E})})]}),e.jsx(K,{visible:i.visible,message:i.message,type:i.type,displayTime:4e3,onHiding:()=>u({...i,visible:!1})})]})}function be({subproyectos:s,filteredEventos:d,cadenas:o}){return e.jsxs(e.Fragment,{children:[e.jsx(k,{dataField:"subproyecto",editorType:"dxSelectBox",editorOptions:{dataSource:s,displayExpr:n=>n?`${n.codigo} - ${n.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0,showClearButton:!0},children:e.jsx(V,{text:"Seleccione un Subproyecto"})}),e.jsx(k,{dataField:"evento",editorType:"dxSelectBox",editorOptions:{dataSource:d,displayExpr:n=>n?`${J(new Date(n.fecha),"dd/MM/yyyy")} - ${n.nombre}`:"",valueExpr:"id",searchEnabled:!0,showClearButton:!0},children:e.jsx(V,{text:"Seleccione un Evento de Muestreo"})}),e.jsx(k,{dataField:"cadena",editorType:"dxSelectBox",editorOptions:{dataSource:o,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0,showClearButton:!0},children:e.jsx(V,{text:"Seleccione una Cadena de Custodia"})})]})}export{be as CargaCadena,ze as default};
