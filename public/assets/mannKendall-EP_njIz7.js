import{r as p,j as s,F as X,S as y,$ as F,a1 as Y,a0 as C,ai as Z}from"./index-BkPAYC4t.js";import{S as z}from"./select-box-BFfHfwAx.js";import{D as R,E as H,C as x}from"./data-grid-BNyC2bq0.js";import{T as ee}from"./toast-YCVj4MMS.js";import{u as oe}from"./subproyectos-BGw0_UMO.js";import{u as ae}from"./eventos-DRwgwRrc.js";import{u as te}from"./pozosDeSubproyecto-CigqRIAy.js";import{u as re}from"./compuestos-BTtq0jfa.js";import{u as U}from"./useQuery-BAPTrFW-.js";import{a as O,A as k}from"./apiResource-CLOj6waL.js";import{u as se}from"./um-DiDMn0L_.js";import"./m_export-BPchivYo.js";const ne=async e=>(await new O("mkpozos").fetch({filter:["subproyectoId","=",e],sort:[{selector:"id",desc:!1}]})).data,ie=e=>{const{data:t=[],isLoading:a,error:o,refetch:n,...i}=U({queryKey:["mkpozos",e],queryFn:()=>ne(e),enabled:!!e});return{mkPozos:t,isLoadingMkPozos:a,errorMkPozos:o,refetchMkPozos:n,...i}},le=async e=>(await new O("mkcompuestos").fetch({filter:["subproyectoId","=",e],sort:[{selector:"id",desc:!1}]})).data,ce=e=>{const{data:t=[],isLoading:a,error:o,refetch:n,...i}=U({queryKey:["mkcompuestos",e],queryFn:()=>le(e),enabled:!!e});return{mkCompuestos:t,isLoadingMkCompuestos:a,errorMkCompuestos:o,refetchMkCompuestos:n,...i}},T=k;async function de(e,t){try{const a=t.map(n=>({subproyectoId:e,pozoId:n.pozoId,hojaId:n.hojaId})),o=await fetch(`${T}mkpozos/replace`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!o.ok){if(o.status===409)throw new Error("Hubo pozos duplicados");{const n=await o.text();throw new Error(n||o.statusText)}}return!0}catch(a){throw new Error(a.message)}}async function ue(e,t){try{const a=t.map(n=>({subproyectoId:e,compuestoId:n.compuestoId,umId:n.umId})),o=await fetch(`${T}mkcompuestos/replace`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!o.ok){if(o.status===409)throw new Error("Hubo compuestos duplicados");{const n=await o.text();throw new Error(n||o.statusText)}}return!0}catch(a){throw console.log("error: ",a),new Error(a.message)}}async function pe(e,t,a,o){var m;const n=(m=t.find(c=>c.id===e))==null?void 0:m.codigo,i=new Date().toISOString().split("T")[0],d=new Date(a).toISOString().split("T")[0],u=new Date(o).toISOString().split("T")[0],l=`MK_${n}_${i}`;try{const c=await fetch(`${k}mannKendall/${e}?fechaDesde=${d}&fechaHasta=${u}`);if(!c.ok)throw new Error(`Error al processar los excel de mannKendall: ${c.statusText}`);const h=await c.json();if(!Array.isArray(h)||h.length===0)throw new Error("No se crearon archivos excel para MannKendall");const g=await fetch(`${k}mannKendall/getzip`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({archivos:h})});if(!g.ok)throw new Error(`Error al descargar el zip con los excel MannKendall: ${g.statusText}`);const b=await g.blob(),w=window.URL.createObjectURL(b),f=document.createElement("a");return f.href=w,f.download=l,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(w),l}catch(c){throw c}}async function fe(e,t,a,o,n,i,d){try{if(await L(d),await L(i),!ge(a,o)||!ye(t,o))return;await ue(e,t),await de(e,a),n(!1),o({visible:!0,message:"Configuración guardada exitosamente.",type:"success"})}catch(u){o({visible:!0,message:`Error al guardar la configuración: ${u.message}`,type:"error"})}}function me(e,t,a,o,n){e(),t(),o(!1),n({visible:!0,message:"Valores restaurados al estado guardado.",type:"success"})}async function he(e,t,a,o,n,i,d,u){if(!d||!u){e({visible:!0,message:"Debe seleccionar un rango de fechas de evento.",type:"warning"});return}if(d>u){e({visible:!0,message:"La fecha desde no puede ser mayor que la fecha hasta.",type:"warning"});return}if(!(n!=null&&n.length)||!(i!=null&&i.length)){e({visible:!0,message:"Debe configurar al menos un pozo y un compuesto antes de generar MannKendall.",type:"warning"});return}o(!0);try{const l=await pe(t,a,d,u);e({visible:!0,message:`Generación exitosa - ${l}`,type:"success"})}catch(l){e({visible:!0,message:(l==null?void 0:l.message)||"Error al Generar MannKendall",type:"error"})}finally{o(!1)}}function $e(){const[e,t]=p.useState(null),[a,o]=p.useState(!1),[n,i]=p.useState({visible:!1,message:"",type:"info"}),[d,u]=p.useState(!1),l=p.useRef(null),m=p.useRef(null),{subproyectos:c,isLoadingSubproyectos:h,errorSubproyecto:g}=oe(),[b,w]=p.useState([]),{compuestos:f,isLoadingCompuestos:K,errorCompuestos:A}=re(),{UM:G,isLoadingUM:q,errorUM:N}=se(),{pozos:B,isLoadingPozos:V,errorPozos:_}=te(e),{mkPozos:v,refetchMkPozos:J}=ie(e),{mkCompuestos:j,refetchMkCompuestos:W}=ce(e),{eventos:Q}=ae(!1),[S,$]=p.useState(null),[E,I]=p.useState(null);return h||K||V||q?s.jsx("div",{children:"Cargando datos..."}):g||A||_||N?s.jsx("div",{children:"Error al cargar datos (Subproyecto / Compuestos / Pozos)"}):s.jsxs(s.Fragment,{children:[s.jsxs(X,{colCount:12,children:[s.jsx(y,{colSpan:6,children:s.jsx(z,{dataSource:c,displayExpr:r=>r?`${r.codigo}: ${r.nombreLocacion}`:"",valueExpr:"id",label:"Seleccione un Subproyecto",labelMode:"outside",searchEnabled:!0,showClearButton:!0,value:e,onValueChanged:r=>{const P=Q.filter(M=>M.subproyectoId===r.value),D=P.map(M=>M.fecha).sort();t(r.value),w(P),$(D[0]||null),I(D.at(-1)||null)}})}),s.jsx(y,{colSpan:3,children:s.jsx(z,{dataSource:b.map(r=>r.fecha).sort(),displayExpr:r=>r?new Date(r).toISOString().split("T")[0]:"",label:"Fecha Desde",labelMode:"outside",displayFormat:"yyyy-MM-dd",value:S,onValueChanged:r=>{$(r.value),r.value>E&&I(r.value)}})}),s.jsx(y,{colSpan:3,children:s.jsx(z,{dataSource:b.map(r=>r.fecha).filter(r=>r>=S).sort(),displayExpr:r=>r?new Date(r).toISOString().split("T")[0]:"",displayFormat:"yyyy-MM-dd",label:"Fecha Hasta",labelMode:"outside",value:E,onValueChanged:r=>{r.value<S||I(r.value)}})}),e&&s.jsxs(s.Fragment,{children:[s.jsx(y,{colSpan:6,children:s.jsxs(R,{dataSource:v,keyExpr:"id",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:400,onSaving:()=>o(!0),ref:l,children:[s.jsx(H,{mode:"cell",allowUpdating:!0,allowDeleting:!0,allowAdding:!0,newRowPosition:"last"}),s.jsx(x,{dataField:"pozoId",caption:"Pozo",lookup:{dataSource:B,valueExpr:"id",displayExpr:"nombre"}}),s.jsx(x,{dataField:"hojaId",caption:"Hoja",lookup:{dataSource:[{id:1,nombre:"Hoja 1"},{id:2,nombre:"Hoja 2"},{id:3,nombre:"Hoja 3"},{id:4,nombre:"Hoja 4"},{id:5,nombre:"Hoja 5"}],valueExpr:"id",displayExpr:"nombre"}})]})}),s.jsx(y,{colSpan:6,children:s.jsxs(R,{dataSource:j,keyExpr:"id",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:400,onSaving:()=>o(!0),onInitNewRow:r=>{r.data.umId=1},ref:m,children:[s.jsx(H,{mode:"cell",allowUpdating:!0,allowDeleting:!0,allowAdding:!0,newRowPosition:"last"}),s.jsx(x,{dataField:"compuestoId",caption:"Compuesto",lookup:{dataSource:f,valueExpr:"id",displayExpr:r=>r?`${r.codigo}-${r.nombre} (${r.matriz})`:""}}),s.jsx(x,{dataField:"umId",caption:"UM",lookup:{dataSource:G,valueExpr:"id",displayExpr:"nombre"}})]})}),s.jsx(F,{colSpan:12,cssClass:"spacer-above-buttons"}),s.jsxs(Y,{cssClass:"buttons-group",colSpan:12,colCount:12,children:[s.jsx(F,{colSpan:6}),s.jsx(C,{colSpan:2,buttonOptions:{text:"Grabar",type:"default",width:"100%",disabled:!a,onClick:r=>fe(e,j,v,i,o,l,m)}}),s.jsx(C,{colSpan:2,buttonOptions:{text:"Generar MannKendall",type:"default",width:"100%",disabled:a,onClick:()=>he(i,e,c,u,v,j,S,E)}}),s.jsx(C,{colSpan:2,buttonOptions:{text:"Restaurar",type:"default",width:"100%",disabled:!a,onClick:()=>me(W,J,e,o,i)}})]})]})]}),s.jsx(Z,{visible:d,shading:!0,shadingColor:"rgba(0,0,0,0.4)",showIndicator:!0,showPane:!0,hideOnOutsideClick:!1,hideOnParentScroll:!1,position:{of:"#root"},message:"Procesando…"}),s.jsx(ee,{visible:n.visible,message:n.message,type:n.type,displayTime:4e3,onHiding:()=>i({...n,visible:!1})})]})}async function L(e){var a,o;const t=(a=e.current)==null?void 0:a.instance;(o=t==null?void 0:t.hasEditData)!=null&&o.call(t)&&await t.saveEditData()}function ge(e,t){if(!(e!=null&&e.length))return t({visible:!0,message:"Debe ingresar al menos un pozo antes de guardar.",type:"warning"}),!1;const a={};for(const o of e){if(!o.pozoId||!o.hojaId)return t({visible:!0,message:"Hay pozos con campos incompletos. Verifique Pozo y Hoja.",type:"warning"}),!1;a[o.hojaId]=(a[o.hojaId]||0)+1}for(const[o,n]of Object.entries(a))if(n>7)return t({visible:!0,message:`La Hoja ${o} tiene más de 7 pozos asignados.`,type:"warning"}),!1;return!0}function ye(e,t){if(!(e!=null&&e.length))return t({visible:!0,message:"Debe ingresar al menos un compuesto antes de guardar.",type:"warning"}),!1;for(const a of e){if(!a.compuestoId)return t({visible:!0,message:"Hay compuestos con campos incompletos. Verifique la columna 'Compuesto'.",type:"warning"}),!1;if(!a.umId)return t({visible:!0,message:"Hay compuestos sin unidad de medida seleccionada.",type:"warning"}),!1}return!0}export{$e as default};
