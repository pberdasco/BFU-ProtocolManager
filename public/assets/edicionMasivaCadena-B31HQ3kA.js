import{r as m,j as e,B as R,F as z,S as T,_ as O}from"./index-Dyddoe5k.js";import{f as G}from"./localization-CAfdGNO3.js";import{T as U}from"./toast-DSFNSLSB.js";import{u as $}from"./subproyectos-r_y-EKFw.js";import{u as _}from"./eventos-C6mC4JeA.js";import{u as H}from"./cadenas-DuZ-tKG3.js";import{D as J,E as K,a as W,I as M,C as u,L as P}from"./data-grid-ByYvucdn.js";import{t as Z,M as A}from"./muestrasConfig-CwDeG0hD.js";import{u as q}from"./pozosDeSubproyecto-DsjkQeN3.js";import{A as Q}from"./apiResource-5P-thon0.js";import{f as X}from"./cadenaCompletaDataAccess-Dvit168Y.js";import{e as Y}from"./excelExport-D57iZOje.js";import"./useQuery-DA5bnrbd.js";import"./m_export-BSg2CvWz.js";import"./exceljs.min-CR6lYXX8.js";import"./export_merged_ranges_manager-wABkCk97.js";const ee=Q;async function te(r,d){const s=await fetch(`${ee}muestras/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!s.ok)throw new Error("Error al guardar la Muestra completa");return await s.json()}async function ae(r,d){if(!r.value){d([]);return}try{const s=await X(r.value);s&&s.filas?d(s.muestras):d([])}catch(s){console.error("Error al cargar la cadena completa guardada:",s)}}function oe({muestras:r=[],cadenaId:d,subproyectoId:s,matrizId:n,setToastOptions:v,onSalir:f,setMuestrasCadena:I}){const N=m.useRef(null),[p,y]=m.useState(null),{pozos:E}=q(s),g=n===A.SUELO,c=n===A.AGUA||n===A.FLNA,h=async t=>{const o="NivelesyOPDS.xlsx",a=t.component;a.hasEditData()&&await a.saveEditData(),Y(a,o)},F=async t=>{if(t.changes.length>0){t.cancel=!0;try{const o=[...r];for(const a of t.changes){const i=a.key,l=o.findIndex(j=>j.muestraId===i);if(l===-1)continue;const S={...o[l],...a.data,cadenaCustodiaId:d};await te(i,S),o[l]=S}p.cancelEditData(),I(o),v({visible:!0,message:"Cambios guardados correctamente",type:"success"})}catch(o){console.error(o),v({visible:!0,message:"Error al guardar cambios",type:"error"})}}};return e.jsxs("div",{style:{marginTop:10},children:[e.jsxs(J,{ref:N,onInitialized:t=>y(t.component),dataSource:r,height:500,rowAlternationEnabled:!0,keyExpr:"muestraId",showBorders:!0,columnAutoWidth:!0,repaintChangesOnly:!1,onExporting:h,paging:{pageSize:30},scrolling:{mode:"standard"},export:{enabled:!0,allowExportSelectedData:!1},onSaving:F,focusedCellEnabled:!0,onEditorPreparing:t=>{if(t.parentType==="dataRow"&&(t.editorName==="dxTextBox"||t.editorName==="dxNumberBox")){const o=t.editorOptions.onKeyDown;t.editorOptions.onKeyDown=a=>{var i;if(a.event.key==="Enter"){const l=t.component,x=(i=t.row)==null?void 0:i.rowIndex,j=l.getVisibleColumns().findIndex(b=>b.dataField===t.dataField),w=a.event.target.value;let C=w;t.dataType==="number"&&(C=w===""?null:Number(w));const k=l.cellValue(x,t.dataField);a.event.preventDefault(),C!==k&&l.cellValue(x,t.dataField,C),l.closeEditCell();const V=l.getDataSource().items(),D=x+1>=V.length,L=D?x:x+1;setTimeout(()=>{var b;if(!D){const B=l.getRowElement(L);B&&((b=l.getScrollable())==null||b.scrollToElement(B))}setTimeout(()=>{l.editCell(L,j)},10)},10)}o==null||o(a)}}},children:[e.jsx(K,{mode:"batch",allowUpdating:!0}),e.jsxs(W,{children:[e.jsx(M,{location:"before",html:'<div class="toolbar-title">Niveles y OPDS</div>'}),e.jsx(M,{name:"exportButton"})]}),e.jsx(u,{dataField:"muestraId",caption:"ID",allowEditing:!1,visible:!1}),e.jsx(u,{dataField:"tipo",caption:"Tipo",allowEditing:!1,children:e.jsx(P,{dataSource:Z,valueExpr:"value",displayExpr:"text"})}),e.jsx(u,{dataField:"pozo",caption:"pozo",allowEditing:!1,children:e.jsx(P,{dataSource:E,valueExpr:"id",displayExpr:"nombre"})}),e.jsx(u,{dataField:"muestra",caption:"Muestra",allowEditing:!1}),e.jsx(u,{dataField:"nivelFreatico",caption:"Nivel FreÃ¡tico",allowEditing:c,visible:c,dataType:"number",format:"#0.000",setCellValue:(t,o,a)=>{t.nivelFreatico=o,a.nivelFLNA==null||a.nivelFLNA==null?t.flna=null:t.flna=a.nivelFLNA===0?0:o-a.nivelFLNA},validationRules:[{type:"range",min:0,message:"Debe ser mayor o igual a 0"}]}),e.jsx(u,{dataField:"nivelFLNA",caption:"Nivel FLNA",allowEditing:c,visible:c,dataType:"number",format:"#0.000",setCellValue:(t,o,a)=>{const i=o===""||o===null||o===void 0?null:o;t.nivelFLNA=i,i==null?t.flna=null:t.flna=i===0?0:(a.nivelFreatico||0)-i},validationRules:[{type:"range",min:0,message:"Debe ser mayor o igual a 0"}]}),e.jsx(u,{dataField:"flna",caption:"Espesor FLNA",dataType:"number",format:"#0.000",visible:c,allowEditing:!1}),e.jsx(u,{dataField:"profundidad",caption:"Profundidad",dataType:"number",visible:g,allowEditing:!1,format:"#0.0"}),e.jsx(u,{dataField:"cadenaOPDS",caption:"Cadena OPDS",visible:!0,allowEditing:!0,editorOptions:{showClearButton:!0}}),e.jsx(u,{dataField:"protocoloOPDS",caption:"Protocolo OPDS",visible:!0,allowEditing:!0,editorOptions:{showClearButton:!0}})]}),e.jsxs("div",{style:{marginTop:30,textAlign:"right"},children:[e.jsx(R,{text:"Guardar",type:"default",onClick:()=>p==null?void 0:p.saveEditData()}),e.jsx(R,{text:"Salir  ",type:"default",onClick:f})]})]})}function he(){var o;const[r,d]=m.useState([]),[s,n]=m.useState({subproyecto:null,evento:null,cadena:null}),[v,f]=m.useState([]),[I,N]=m.useState(!1),[p,y]=m.useState({visible:!1,message:"",type:"info"}),{subproyectos:E}=$(),{eventos:g}=_(!1),{cadenas:c}=H(s.evento),h=()=>{f([]),n({subproyecto:null,evento:null,cadena:null})},F=m.useCallback(async a=>{a.dataField==="subproyecto"?(d(g.filter(i=>i.subproyectoId===a.value)),n({subproyecto:a.value,evento:null,cadena:null}),f([])):a.dataField==="cadena"&&await ae(a,f),n(i=>({...i,[a.dataField]:a.value}))},[s,g,c,v]),t=((o=c==null?void 0:c.find(a=>a.id===s.cadena))==null?void 0:o.matrizCodigo)||null;return e.jsxs("div",{children:[e.jsxs(z,{formData:s,onFieldDataChanged:F,colCount:4,children:[e.jsx(se,{subproyectos:E,filteredEventos:r,cadenas:c}),s.cadena&&e.jsx(e.Fragment,{children:e.jsx(oe,{muestras:v,cadenaId:s.cadena,subproyectoId:s.subproyecto,matrizId:t,setToastOptions:y,onSalir:h,setMuestrasCadena:f})})]}),e.jsx(U,{visible:p.visible,message:p.message,type:p.type,displayTime:4e3,onHiding:()=>y({...p,visible:!1})})]})}function se({subproyectos:r,filteredEventos:d,cadenas:s}){return e.jsxs(e.Fragment,{children:[e.jsx(T,{dataField:"subproyecto",editorType:"dxSelectBox",editorOptions:{dataSource:r,displayExpr:n=>n?`${n.codigo} - ${n.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0,showClearButton:!0},children:e.jsx(O,{text:"Seleccione un Subproyecto"})}),e.jsx(T,{dataField:"evento",editorType:"dxSelectBox",editorOptions:{dataSource:d,displayExpr:n=>n?`${G(new Date(n.fecha),"dd/MM/yyyy")} - ${n.nombre}`:"",valueExpr:"id",searchEnabled:!0,showClearButton:!0},children:e.jsx(O,{text:"Seleccione un Evento de Muestreo"})}),e.jsx(T,{dataField:"cadena",editorType:"dxSelectBox",editorOptions:{dataSource:s,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0,showClearButton:!0},children:e.jsx(O,{text:"Seleccione una Cadena de Custodia"})})]})}export{se as CargaCadena,he as default};
