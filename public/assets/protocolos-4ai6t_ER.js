import{a1 as de,a2 as W,h as ve,m as _,o as z,q,O as H,a3 as F,a4 as Se,a5 as Fe,a6 as A,d as M,E as U,a7 as Ce,a8 as k,i as E,a9 as P,aa as j,G as ue,f as T,c as Ee,ab as Q,ac as ee,u as te,ad as ye,ae as G,D as X,w as ce,r as I,j as r,af as N,S as C,_ as L,ag as we,ah as oe,F as Me,$ as ae,a0 as se}from"./index-Cm1k3WOj.js";import{u as Le}from"./eventos-WOvfGx5T.js";import{u as $e}from"./subproyectos-BsnxX71z.js";import{u as Ie}from"./laboratorios-C5etl_zU.js";import{u as pe}from"./useQuery-CW2cZTZx.js";import{A as he,a as Be}from"./apiResource-5P-thon0.js";import{u as Ue}from"./matrices-Q8tWdPl2.js";import{E as Ae}from"./exceljs.min-l8QLPR3U.js";import{s as V,f as ke}from"./specialValues-CHSjwz8L.js";import{f as Te,s as ze}from"./protocolosDataAccess-Hi5oC4Od.js";import{T as De}from"./toast-Y0YPr_e4.js";import{f as Oe}from"./localization-BrGm2QGq.js";import{D as Y,E as J,C as y}from"./data-grid-BFs8E209.js";import{u as Pe}from"./compuestos-Dak9RLOv.js";import{u as je}from"./metodos-BaRMbRPg.js";import{u as Re}from"./um-C4DC3yG0.js";import"./m_export-0R763p3z.js";const Ve=he;async function He(s){if(!s)return[];const e=await fetch(`${Ve}matrizcadena?eventoId=${s}`);if(!e.ok)throw new Error(`Error al obtener matrices del evento: ${e.statusText}`);return e.json()}const Ne=s=>{const{data:e=[],isLoading:t,error:o,...a}=pe({queryKey:["matrizDeEvento",s],queryFn:()=>He(s),enabled:!!s});return{matrizEvento:e,isLoadingMatrizEvento:t,isErrorMatrizEvento:o,...a}};function We(s,e){const t=s.worksheets.find(o=>!e.some(a=>o.name.toLowerCase().includes(a)));if(!t)throw new Error("No se encontró una hoja válida.");return{sheetName:t.name,worksheet:t}}function Ze(s,e=[]){const o=s.getSheetValues().slice(1).map(d=>d?d.slice(1):[]),a=o.findIndex(d=>d&&d.includes("Parámetro"));if(a===-1)throw new Error("No se encontró la fila de cabecera.");const i=o[a],n=o.slice(a+1),h=i.findIndex(d=>typeof d=="string"&&d.toLowerCase().includes("parámetro")),u=i.findIndex(d=>typeof d=="string"&&d.toLowerCase().includes("unidad")),m=i.map((d,p)=>({name:d,index:p})).filter(d=>d.index!==h&&d.index!==u&&!e.includes(d.name));return{headers:i,rows:n,parametroIndex:h,pozoIndices:m,unidadIndex:u}}function O(s){if(typeof s=="string"){const t=s.trim().toLowerCase();if(t.startsWith("<")||t.startsWith("nc"))return V.LQ;if(t.startsWith("no detectado"))return V.NO_DETECTADO;if(!t||t.startsWith("x")||t.startsWith("-"))return V.NO_ANALIZADO}const e=parseFloat(s);return isNaN(e)?null:e}function qe(s){const{worksheet:e}=We(s,["encabezado","monitore","metodos"]),{rows:t,parametroIndex:o,pozoIndices:a,unidadIndex:i}=Ze(e,["LQ"]),n=t.map(u=>{var c;const m=u[o];if(!m)return null;const d=((c=u[i])==null?void 0:c.toLowerCase())||null,p=a.reduce((g,x)=>(g[x.name]=O(u[x.index]),g),{});return{compuestoLab:m,compuestoId:null,metodoLab:null,metodoId:null,unidadLab:d,unidadId:null,...p}}).filter(Boolean),h=a.map(u=>({muestraLab:u.name,muestraCadena:null}));return{matrizLab:n,muestrasListLab:h}}function Ge(s){const e=[],a=s.worksheets[0].getSheetValues().slice(1).map(l=>l?l.slice(1):[]),i=a.findIndex(l=>l&&l.includes("Parámetros"));if(i===-1)throw new Error("No se encontró la fila de cabecera.");const n=a[i],h=a.slice(i+1),u=[];for(const l of h){if(!l||!l[0]&&!l[1])break;u.push(l)}const m=0,d=1,p=2,c=n.slice(3).map((l,v)=>({name:l,index:v+3})).filter(l=>l.name&&l.name.toLowerCase()!=="límite detección"),g=u.map(l=>{var b;const v=l[m];if(!v)return null;const w=l[d]||null,f=((b=l[p])==null?void 0:b.toLowerCase())||null,S=c.reduce(($,B)=>($[B.name]=O(l[B.index]),$),{});return{compuestoLab:v,compuestoId:null,metodoLab:w,metodoId:null,unidadLab:f,unidadId:null,...S}}).filter(Boolean),x=c.map(l=>({muestraLab:l.name,muestraCadena:null}));return{matrizLab:g,muestrasListLab:x,warnMessages:e}}function Xe(s){const e=s.toLowerCase(),t="muestra",o="proyecto",a=e.indexOf(t);if(a===-1)return null;let i=s.substring(a+t.length).trim();const n=i.toLowerCase().indexOf(o);return n!==-1&&(i=i.substring(0,n).trim()),i}function Ye(s,e){const t=s.findIndex(i=>i[0]&&i[0].toString().toLowerCase().includes("muestra"));if(t===-1)return console.warn(`No se encontró la palabra "muestra" en la hoja "${e}". Se omite.`),{finded:!1,nombreMuestra:"",warnMuestraMessage:`No se encontró la palabra "muestra" en la hoja [${e}]. Se omite.`};const o=s[t][0].toString();return{finded:!0,nombreMuestra:Xe(o)||e}}function Je(s,e){let t=s.findIndex(o=>o[0]&&o[0].toString().toLowerCase().includes("parámetro"));return t===-1?(console.warn(`No se encontró la fila con "Parámetro" en la hoja "${e}". Se omite.`),{headersRow:t,warnHeaderMessage:`No se encontró la fila con "Parámetro" en la hoja [${e}]. Se omite.`}):(s[t][0]==s[t+1][0]&&t++,{headersRow:t})}function Ke(s){const e={},t=[],o=[];return s.worksheets.forEach(i=>{const n=i.name,u=i.getSheetValues().slice(1).map(l=>l?l.slice(1):[]),{finded:m,nombreMuestra:d,warnMuestraMessage:p}=Ye(u,n);if(!m){o.push(p);return}const{headersRow:c,warnHeaderMessage:g}=Je(u,n);if(c===-1){o.push(g);return}const x=u.slice(c+1);for(const l of x){if(!l[0])break;const v=l[0]?l[0].toString().trim():null,w=l[1]?l[1].toString().trim():null,f=l[2],S=l[3]?l[3].toString().toLowerCase().trim():null,b=`${v}||${w}||${S}`;e[b]||(e[b]={compuestoLab:v,compuestoId:null,metodoLab:w,metodoId:null,unidadLab:S,unidadId:null}),e[b][d]=O(f)}t.push({muestraLab:d,muestraCadena:null})}),{matrizLab:Object.values(e),muestrasListLab:t,warnMessages:o}}const Qe="parametros",ie=0,et=1,tt=3,ne=4,ot=["limite deteccion","limite de cuantificacion"];function R(s,e=!0){if(!s)return"";let t=s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s\-/()]/g,"").replace(/\s+/g," ").trim();return e?t.toLowerCase():t}function re(s){const e=/\b(MA|MS|MG|MP)[ -]\S+\b/,t=s.match(e);return t?t[0]:null}function at(s){const e=[],a=s.worksheets[0].getSheetValues().slice(1).map(c=>c?c.slice(1):[]),i=a.findIndex(c=>c&&R(c[ie])===Qe);if(i===-1)throw new Error("No se encontró la fila de cabecera.");const n=a[i],h=a.slice(i+1),u=[];for(const c of h){if(!c||!c[0]&&!c[1])break;u.push(c)}const m=n.slice(ne).map((c,g)=>({name:c,index:g+ne})).filter(c=>c.name&&!ot.includes(R(c.name))),d=u.map(c=>{var w;const g=c[ie];if(!g)return null;const x=c[et]||null,l=((w=c[tt])==null?void 0:w.toLowerCase())||null,v=m.reduce((f,S)=>{const b=re(R(S.name,!1));return f[b]=O(c[S.index]),f},{});return{compuestoLab:g,compuestoId:null,metodoLab:x,metodoId:null,unidadLab:l,unidadId:null,...v}}).filter(Boolean),p=m.map(c=>({muestraLab:re(R(c.name,!1)),muestraCadena:null}));return{matrizLab:d,muestrasListLab:p,warnMessages:e}}function st(s){const e=[],a=s.worksheets[0].getSheetValues().slice(1).map(l=>l?l.slice(1):[]),i=a.findIndex(l=>l&&l.includes("Determinaciones"));if(i===-1)throw new Error("No se encontró la fila de cabecera.");const n=a[i],h=a.slice(i+1),u=[];for(const l of h){if(!l||!l[0]&&!l[1])break;u.push(l)}const m=0,d=1,p=2,c=n.slice(3).map((l,v)=>({name:l,index:v+3})).filter(l=>l.name),g=u.map(l=>{var b;const v=l[m];if(!v)return null;const w=l[d]||null,f=((b=l[p])==null?void 0:b.toLowerCase())||null,S=c.reduce(($,B)=>{const xe=l[B.index]!==void 0?O(l[B.index]):V.NO_ANALIZADO;return $[B.name]=xe,$},{});return{compuestoLab:v,compuestoId:null,metodoLab:w,metodoId:null,unidadLab:f,unidadId:null,...S}}).filter(Boolean),x=c.map(l=>({muestraLab:l.name,muestraCadena:null}));return{matrizLab:g,muestrasListLab:x,warnMessages:e}}const it={als:qe,inducer:Ge,labca:Ke,cit:at,fix:st};async function nt(s,e){const t=await rt(s),o=new Ae.Workbook;await o.xlsx.load(t);const a=it[e.toLowerCase()];if(!a)throw new Error("Formato no soportado");return a(o)}async function rt(s){const e=new FileReader;return new Promise((t,o)=>{e.onload=a=>t(a.target.result),e.onerror=()=>o("Error al leer el archivo."),e.readAsArrayBuffer(s)})}const K=he;async function lt(s,e){try{const t=await fetch(`${K}sinonimoscompuestos/listasinonimos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({matrizId:s,compuestosOriginales:e})});if(!t.ok)throw new Error("Error fetching Sinonimos Compuestos");return await t.json()}catch(t){throw console.error("Error fetching Sinonimos Compuestos:",t),t}}async function dt(s){try{const e=await fetch(`${K}sinonimosmetodos/listasinonimos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({metodosOriginales:s})});if(!e.ok)throw new Error("Error fetching Sinonimos Metodos");return await e.json()}catch(e){throw console.error("Error fetching Sinonimos Metodos:",e),e}}async function ut(s){try{const e=await fetch(`${K}sinonimosums/listasinonimos`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({umsOriginales:s})});if(!e.ok)throw new Error("Error fetching Sinonimos UMs");return await e.json()}catch(e){throw console.error("Error fetching Sinonimos UMs:",e),e}}async function ct(s,e){return await pt(s,e),await ht(s),await _t(s),s}async function pt(s,e){const t=[...new Set(s.map(a=>a.compuestoLab).filter(a=>!!a&&a.length<=60))],o=await lt(e,t);s.forEach(a=>{const i=o.find(n=>n.compuestoOriginal===a.compuestoLab);a.compuestoId=i?i.compuestoId:null})}async function ht(s){const e=[...new Set(s.map(o=>o.metodoLab).filter(o=>!!o&&o.length<=60))];if(e.length<=0)return;const t=await dt(e);s.forEach(o=>{const a=t.find(i=>i.metodoOriginal===o.metodoLab);o.metodoId=a?a.metodoId:null})}async function _t(s){const e=[...new Set(s.map(o=>o.unidadLab).filter(o=>!!o&&o.length<=10))];if(e.length<=0)return;const t=await ut(e);s.forEach(o=>{const a=t.find(i=>i.umOriginal===o.unidadLab);o.unidadId=a?a.umId:null})}async function mt(s,e){const t=a=>a.toLowerCase().replace(/[.,;:/()_*\+\-\s]/g,"");function o(a){const i=/\b(MA|MS|MG|MP)[ -]\S+\b/,n=a.match(i);return n?n[0]:null}return s.forEach(a=>{const i=o(a.muestraLab);if(!i)return;const n=t(i),h=e.find(u=>t(u.muestra)===n);h&&(a.muestraCadena=h.muestraId)}),s}const ft=async(s,e,t)=>{const o=new Be("protocolos");let a=[];return s!==0&&a.push(["eventoMuestreoId","=",s]),s!==0&&e!==0&&a.push("and"),e!==0&&a.push(["matrizId","=",e]),s!==0&&e!==0&&t!==0&&a.push("and"),t!==0&&a.push(["laboratorioId","=",t]),a.length===0&&(a=null),(await o.fetch({filter:a,sort:[{selector:"fecha",desc:!1}]})).data},gt=(s,e,t)=>{const{data:o=[],isLoading:a,error:i,...n}=pe({queryKey:["protocolos",s,e,t],queryFn:()=>ft(s,e,t),enabled:s!=null&&e!=null&&t!=null});return{protocolos:o,isLoadingProtocolos:a,isErrorProtocolos:i,...n}},_e=de.inherit({_getDefaultOptions(){return z(this.callBase(),{min:0,max:100,value:0})},_initMarkup(){this.$element().addClass("dx-trackbar"),this._renderWrapper(),this._renderContainer(),this._renderRange(),this._renderValue(),this._setRangeStyles(),this.callBase()},_render(){this.callBase(),this._setRangeStyles(this._rangeStylesConfig())},_renderWrapper(){this._$wrapper=_("<div>").addClass("dx-trackbar-wrapper").appendTo(this.$element())},_renderContainer(){this._$bar=_("<div>").addClass("dx-trackbar-container").appendTo(this._$wrapper)},_renderRange(){this._$range=_("<div>").addClass("dx-trackbar-range").appendTo(this._$bar)},_renderValue(){const s=this.option("value"),e=this.option("min"),t=this.option("max");if(e>t)return;if(s<e){this.option("value",e),this._currentRatio=0;return}if(s>t){this.option("value",t),this._currentRatio=1;return}const o=e===t?0:(s-e)/(t-e);!this._needPreventAnimation&&this._setRangeStyles({width:100*o+"%"}),this.setAria({valuemin:this.option("min"),valuemax:t,valuenow:s}),this._currentRatio=o},_rangeStylesConfig(){return{width:100*this._currentRatio+"%"}},_setRangeStyles(s){if(W.stop(this._$range),!s){this._$range.css({width:0});return}this._needPreventAnimation||!ve()||W.animate(this._$range,{type:"custom",duration:100,to:s})},_optionChanged(s){switch(s.name){case"value":this._renderValue(),this.callBase(s);break;case"max":case"min":this._renderValue();break;default:this.callBase(s)}},_dispose(){W.stop(this._$range),this.callBase()}});q("dxTrackBar",_e);const le="dx-progressbar-animating-segment",me=_e.inherit({_getDefaultOptions(){return z(this.callBase(),{value:0,statusFormat:s=>`Progress: ${Math.round(100*s)}%`,showStatus:!0,onComplete:null,activeStateEnabled:!1,statusPosition:"bottom left",_animatingSegmentCount:0})},_defaultOptionsRules(){return this.callBase().concat([{device:s=>s.platform==="android",options:{_animatingSegmentCount:2}}])},_toggleReadOnlyState(){this.setAria("readonly",void 0)},_initMarkup(){this._renderStatus(),this._createCompleteAction(),this.callBase(),this.$element().addClass("dx-progressbar"),this._$wrapper.addClass("dx-progressbar-wrapper"),this._$bar.addClass("dx-progressbar-container"),this.setAria("role","progressbar"),_("<div>").addClass("dx-progressbar-range-container").appendTo(this._$wrapper).append(this._$bar),this._$range.addClass("dx-progressbar-range"),this._toggleStatus(this.option("showStatus"))},_useTemplates:()=>!1,_createCompleteAction(){this._completeAction=this._createActionByOption("onComplete")},_renderStatus(){this._$status=_("<div>").addClass("dx-progressbar-status")},_renderIndeterminateState(){this._$segmentContainer=_("<div>").addClass("dx-progressbar-animating-container");const s=this.option("_animatingSegmentCount");for(let e=0;e<s;e++)_("<div>").addClass(le).addClass(`${le}-${e+1}`).appendTo(this._$segmentContainer);this._$segmentContainer.appendTo(this._$wrapper)},_toggleStatus(s){const e=this.option("statusPosition").split(" ");s?e[0]==="top"||e[0]==="left"?this._$status.prependTo(this._$wrapper):this._$status.appendTo(this._$wrapper):this._$status.detach(),this._togglePositionClass()},_togglePositionClass(){const e=this.option("statusPosition").split(" ");this._$wrapper.removeClass("dx-position-top-left dx-position-top-right dx-position-bottom-left dx-position-bottom-right dx-position-left dx-position-right");let t=`dx-position-${e[0]}`;e[1]&&(t+=`-${e[1]}`),this._$wrapper.addClass(t)},_toggleIndeterminateState(s){s?(this._renderIndeterminateState(),this._$bar.toggle(!1)):(this._$bar.toggle(!0),this._$segmentContainer.remove(),delete this._$segmentContainer)},_renderValue(){const s=this.option("value"),e=this.option("max");if(!s&&s!==0){this._toggleIndeterminateState(!0);return}this._$segmentContainer&&this._toggleIndeterminateState(!1),s===e&&this._completeAction(),this.callBase(),this._setStatus()},_setStatus(){let s=this.option("statusFormat");H(s)?s=s.bind(this):s=function(t){return t};const e=s(this._currentRatio,this.option("value"));this._$status.text(e)},_dispose(){this._$status.remove(),this.callBase()},_optionChanged(s){switch(s.name){case"statusFormat":this._setStatus();break;case"showStatus":this._toggleStatus(s.value);break;case"statusPosition":this._toggleStatus(this.option("showStatus"));break;case"onComplete":this._createCompleteAction();break;case"_animatingSegmentCount":break;default:this.callBase(s)}}});q("dxProgressBar",me);const bt=de,D=Ee();let xt=()=>_("<input>").attr("type","file");const Z=()=>!!D.FormData;class vt extends bt{_supportedKeys(){const e=t=>{t.preventDefault();const o=this._selectButton.$element();M.trigger(o,ye)};return z(super._supportedKeys(),{space:e,enter:e})}_setOptionsByReference(){super._setOptionsByReference(),z(this._optionsByReference,{value:!0})}_getDefaultOptions(){return z(super._getDefaultOptions(),{chunkSize:0,value:[],selectButtonText:F.format("dxFileUploader-selectFile"),uploadButtonText:F.format("dxFileUploader-upload"),labelText:F.format("dxFileUploader-dropFile"),name:"files[]",multiple:!1,accept:"",uploadUrl:"/",allowCanceling:!0,showFileList:!0,progress:0,dialogTrigger:void 0,dropZone:void 0,readyToUploadMessage:F.format("dxFileUploader-readyToUpload"),uploadedMessage:F.format("dxFileUploader-uploaded"),uploadFailedMessage:F.format("dxFileUploader-uploadFailedMessage"),uploadAbortedMessage:F.format("dxFileUploader-uploadAbortedMessage"),uploadMode:"instantly",uploadMethod:"POST",uploadHeaders:{},uploadCustomData:{},onBeforeSend:null,onUploadStarted:null,onUploaded:null,onFilesUploaded:null,onProgress:null,onUploadError:null,onUploadAborted:null,onDropZoneEnter:null,onDropZoneLeave:null,allowedFileExtensions:[],maxFileSize:0,minFileSize:0,inputAttr:{},invalidFileExtensionMessage:F.format("dxFileUploader-invalidFileExtension"),invalidMaxFileSizeMessage:F.format("dxFileUploader-invalidMaxFileSize"),invalidMinFileSizeMessage:F.format("dxFileUploader-invalidMinFileSize"),extendSelection:!0,validationMessageMode:"always",uploadFile:null,uploadChunk:null,abortUpload:null,validationMessageOffset:{h:0,v:0},hoverStateEnabled:!0,useNativeInputClick:!1,useDragOver:!0,nativeDropSupported:!0,_uploadButtonType:"normal",_buttonStylingMode:"contained"})}_defaultOptionsRules(){return super._defaultOptionsRules().concat([{device:()=>A.real().deviceType==="desktop"&&!A.isSimulator(),options:{focusStateEnabled:!0}},{device:[{platform:"android"}],options:{validationMessageOffset:{v:0}}},{device:()=>A.real().deviceType!=="desktop",options:{useDragOver:!1}},{device:()=>!Z(),options:{uploadMode:"useForm"}},{device:()=>A.real().deviceType!=="desktop",options:{nativeDropSupported:!1}},{device:()=>Se(),options:{_uploadButtonType:"default"}},{device:()=>Fe(),options:{_buttonStylingMode:"text"}}])}_initOptions(e){const t="labelText"in e;super._initOptions(e),!t&&!this._shouldDragOverBeRendered()&&this.option("labelText","")}_init(){super._init(),this._initFileInput(),this._initLabel(),this._setUploadStrategy(),this._createFiles(),this._createBeforeSendAction(),this._createUploadStartedAction(),this._createUploadedAction(),this._createFilesUploadedAction(),this._createProgressAction(),this._createUploadErrorAction(),this._createUploadAbortedAction(),this._createDropZoneEnterAction(),this._createDropZoneLeaveAction()}_setUploadStrategy(){if(this.option("chunkSize")>0){const e=this.option("uploadChunk");this._uploadStrategy=e&&H(e)?new Ct(this):new Ft(this)}else{const e=this.option("uploadFile");this._uploadStrategy=e&&H(e)?new yt(this):new Et(this)}}_initFileInput(){this._isCustomClickEvent=!1;const{multiple:e,accept:t,hint:o}=this.option();this._$fileInput||(this._$fileInput=xt(),M.on(this._$fileInput,"change",this._inputChangeHandler.bind(this)),M.on(this._$fileInput,"click",i=>(i.stopPropagation(),this._resetInputValue(),this.option("useNativeInputClick")||this._isCustomClickEvent)));const a={multiple:e,accept:t,tabIndex:-1};E(o)&&(a.title=o),this._$fileInput.prop(a)}_inputChangeHandler(){if(this._doPreventInputChange)return;const e=this._$fileInput.val().replace(/^.*\\/,""),t=this._$fileInput.prop("files");if(t&&!t.length&&this.option("uploadMode")!=="useForm")return;const o=t?this._getFiles(t):[{name:e}];this._changeValue(o),this.option("uploadMode")==="instantly"&&this._uploadFiles()}_shouldFileListBeExtended(){return this.option("uploadMode")!=="useForm"&&this.option("extendSelection")&&this.option("multiple")}_changeValue(e){const t=this._shouldFileListBeExtended()?this.option("value").slice():[];this.option("value",t.concat(e))}_getFiles(e){const t=[];return U(e,(o,a)=>t.push(a)),t}_getFile(e){const t=Ce(e)?this.option("value")[e]:e;return this._files.filter(o=>o.value===t)[0]}_initLabel(){this._$inputLabel||(this._$inputLabel=_("<div>")),this._updateInputLabelText()}_updateInputLabelText(){const e=this._isInteractionDisabled()?"":this.option("labelText");this._$inputLabel.text(e)}_focusTarget(){return this.$element().find(".dx-fileuploader-button")}_getSubmitElement(){return this._$fileInput}_initMarkup(){super._initMarkup(),this.$element().addClass("dx-fileuploader"),this._renderWrapper(),this._renderInputWrapper(),this._renderSelectButton(),this._renderInputContainer(),this._renderUploadButton(),this._preventRecreatingFiles=!0,this._activeDropZone=null}_render(){this._preventRecreatingFiles=!1,this._attachDragEventHandlers(this._$inputWrapper),this._attachDragEventHandlers(this.option("dropZone")),this._renderFiles(),super._render()}_createFileProgressBar(e){e.progressBar=this._createProgressBar(e.value.size),e.progressBar.$element().appendTo(e.$file),this._initStatusMessage(e),this._ensureCancelButtonInitialized(e)}_setStatusMessage(e,t){setTimeout(()=>{this.option("showFileList")&&e.$statusMessage&&(e.$statusMessage.text(t),e.$statusMessage.css("display",""),e.progressBar.$element().remove())},400)}_getUploadAbortedStatusMessage(){return this.option("uploadMode")==="instantly"?this.option("uploadAbortedMessage"):this.option("readyToUploadMessage")}_createFiles(){const e=this.option("value");this._files&&((e==null?void 0:e.length)===0||!this._shouldFileListBeExtended())&&(this._preventFilesUploading(this._files),this._files=null),this._files||(this._files=[]),U(e==null?void 0:e.slice(this._files.length),(t,o)=>{const a=this._createFile(o);this._validateFile(a),this._files.push(a)})}_preventFilesUploading(e){e.forEach(t=>this._uploadStrategy.abortUpload(t))}_validateFile(e){e.isValidFileExtension=this._validateFileExtension(e),e.isValidMinSize=this._validateMinFileSize(e),e.isValidMaxSize=this._validateMaxFileSize(e)}_validateFileExtension(e){const t=this.option("allowedFileExtensions"),o=this.option("accept"),a=this._getAllowedFileTypes(o),i=e.value.name.substring(e.value.name.lastIndexOf(".")).toLowerCase();if((o==null?void 0:o.length)!==0&&!this._isFileTypeAllowed(e.value,a))return!1;if((t==null?void 0:t.length)===0)return!0;for(let n=0;n<t.length;n++)if(i===t[n].toLowerCase())return!0;return!1}_validateMaxFileSize(e){const t=e.value.size,o=this.option("maxFileSize");return o>0?t<=o:!0}_validateMinFileSize(e){const t=e.value.size,o=this.option("minFileSize");return o>0?t>=o:!0}_createBeforeSendAction(){this._beforeSendAction=this._createActionByOption("onBeforeSend",{excludeValidators:["readOnly"]})}_createUploadStartedAction(){this._uploadStartedAction=this._createActionByOption("onUploadStarted",{excludeValidators:["readOnly"]})}_createUploadedAction(){this._uploadedAction=this._createActionByOption("onUploaded",{excludeValidators:["readOnly"]})}_createFilesUploadedAction(){this._filesUploadedAction=this._createActionByOption("onFilesUploaded",{excludeValidators:["readOnly"]})}_createProgressAction(){this._progressAction=this._createActionByOption("onProgress",{excludeValidators:["readOnly"]})}_createUploadAbortedAction(){this._uploadAbortedAction=this._createActionByOption("onUploadAborted",{excludeValidators:["readOnly"]})}_createUploadErrorAction(){this._uploadErrorAction=this._createActionByOption("onUploadError",{excludeValidators:["readOnly"]})}_createDropZoneEnterAction(){this._dropZoneEnterAction=this._createActionByOption("onDropZoneEnter")}_createDropZoneLeaveAction(){this._dropZoneLeaveAction=this._createActionByOption("onDropZoneLeave")}_createFile(e){return{value:e,loadedSize:0,onProgress:k(),onAbort:k(),onLoad:k(),onError:k(),onLoadStart:k(),isValidFileExtension:!0,isValidMaxSize:!0,isValidMinSize:!0,isValid(){return this.isValidFileExtension&&this.isValidMaxSize&&this.isValidMinSize},isInitialized:!1}}_resetFileState(e){e.isAborted=!1,e.uploadStarted=!1,e.isStartLoad=!1,e.loadedSize=0,e.chunksData=void 0,e.request=void 0}_renderFiles(){var e;const t=this.option("value");this._$filesContainer?(!this._shouldFileListBeExtended()||(t==null?void 0:t.length)===0)&&this._$filesContainer.empty():this._$filesContainer=_("<div>").addClass("dx-fileuploader-files-container").appendTo(this._$content);const o=this.option("showFileList");o&&U(this._files,(a,i)=>{i.$file||this._renderFile(i)}),this.$element().toggleClass("dx-fileuploader-show-file-list",o),this._toggleFileUploaderEmptyClassName(),this._updateFileNameMaxWidth(),(e=this._validationMessage)===null||e===void 0||e.repaint()}_renderFile(e){const{value:t}=e,o=_("<div>").addClass("dx-fileuploader-file-container").appendTo(this._$filesContainer);this._renderFileButtons(e,o),e.$file=_("<div>").addClass("dx-fileuploader-file").appendTo(o);const a=_("<div>").addClass("dx-fileuploader-file-info").appendTo(e.$file);e.$statusMessage=_("<div>").addClass("dx-fileuploader-file-status-message").appendTo(e.$file),_("<div>").addClass("dx-fileuploader-file-name").text(t.name).appendTo(a),E(t.size)&&_("<div>").addClass("dx-fileuploader-file-size").text(this._getFileSize(t.size)).appendTo(a),e.isValid()?e.$statusMessage.text(this.option("readyToUploadMessage")):(e.isValidFileExtension||e.$statusMessage.append(this._createValidationElement("invalidFileExtensionMessage")),e.isValidMaxSize||e.$statusMessage.append(this._createValidationElement("invalidMaxFileSizeMessage")),e.isValidMinSize||e.$statusMessage.append(this._createValidationElement("invalidMinFileSizeMessage")),o.addClass("dx-fileuploader-invalid"))}_createValidationElement(e){return _("<span>").text(this.option(e))}_updateFileNameMaxWidth(){const e=this.option("allowCanceling")&&this.option("uploadMode")!=="useForm"?1:0,t=this.option("uploadMode")==="useButtons"?1:0,o=P(this._$filesContainer.find(".dx-fileuploader-file-container").first())||P(this._$filesContainer),a=this._$filesContainer.find(".dx-fileuploader-button-container").eq(0),i=P(a)*(e+t),n=this._$filesContainer.find(".dx-fileuploader-file-size").eq(0),h=n.text();n.text("1000 Mb");const u=P(n);n.text(h),this._$filesContainer.find(".dx-fileuploader-file-name").css("maxWidth",o-i-u)}_renderFileButtons(e,t){const o=this._getCancelButton(e);o&&t.append(o);const a=this._getUploadButton(e);a&&t.append(a)}_getCancelButton(e){if(this.option("uploadMode")==="useForm")return null;const{allowCanceling:t,readOnly:o,hoverStateEnabled:a,_buttonStylingMode:i}=this.option();return e.cancelButton=this._createComponent(_("<div>").addClass("dx-fileuploader-button dx-fileuploader-cancel-button"),j,{onClick:()=>this._removeFile(e),icon:"close",visible:t,disabled:o,integrationOptions:{},hoverStateEnabled:a,stylingMode:i}),_("<div>").addClass("dx-fileuploader-button-container").append(e.cancelButton.$element())}_getUploadButton(e){if(!e.isValid()||this.option("uploadMode")!=="useButtons")return null;const{hoverStateEnabled:t,_buttonStylingMode:o}=this.option();return e.uploadButton=this._createComponent(_("<div>").addClass("dx-fileuploader-button dx-fileuploader-upload-button"),j,{onClick:()=>this._uploadFile(e),icon:"upload",hoverStateEnabled:t,stylingMode:o}),e.onLoadStart.add(()=>e.uploadButton.option({visible:!1,disabled:!0})),e.onAbort.add(()=>e.uploadButton.option({visible:!0,disabled:!1})),_("<div>").addClass("dx-fileuploader-button-container").append(e.uploadButton.$element())}_removeFile(e){var t;(t=e.$file)===null||t===void 0||t.parent().remove(),this._files.splice(this._files.indexOf(e),1);const o=this.option("value").slice();o.splice(o.indexOf(e.value),1),this._preventRecreatingFiles=!0,this.option("value",o),this._preventRecreatingFiles=!1,this._toggleFileUploaderEmptyClassName(),this._resetInputValue(!0)}removeFile(e){if(this.option("uploadMode")==="useForm"||!E(e))return;const t=this._getFile(e);t&&(t.uploadStarted&&this._preventFilesUploading([t]),this._removeFile(t))}_toggleFileUploaderEmptyClassName(){this.$element().toggleClass("dx-fileuploader-empty",!this._files.length||this._hasInvalidFile(this._files))}_hasInvalidFile(e){for(let t=0;t<e.length;t++)if(!e[t].isValid())return!0;return!1}_getFileSize(e){let t=0;const o=[F.format("dxFileUploader-bytes"),F.format("dxFileUploader-kb"),F.format("dxFileUploader-Mb"),F.format("dxFileUploader-Gb")],a=o.length-1;for(;t<a&&e>=1024;)e/=1024,t++;return`${Math.round(e)} ${o[t]}`}_renderSelectButton(){const e=_("<div>").addClass("dx-fileuploader-button").appendTo(this._$inputWrapper);this._selectButton=this._createComponent(e,j,{text:this.option("selectButtonText"),focusStateEnabled:!1,integrationOptions:{},disabled:this.option("readOnly"),hoverStateEnabled:this.option("hoverStateEnabled")}),this._selectFileDialogHandler=this._selectButtonClickHandler.bind(this),A.real().deviceType==="desktop"?this._selectButton.option("onClick",this._selectFileDialogHandler):this._attachSelectFileDialogHandler(this._selectButton.$element()),this._attachSelectFileDialogHandler(this.option("dialogTrigger"))}_selectButtonClickHandler(){if(!this.option("useNativeInputClick")){if(this._isInteractionDisabled())return!1;this._isCustomClickEvent=!0,M.trigger(this._$fileInput,"click"),this._isCustomClickEvent=!1}}_attachSelectFileDialogHandler(e){E(e)&&(this._detachSelectFileDialogHandler(e),M.on(_(e),"click",this._selectFileDialogHandler))}_detachSelectFileDialogHandler(e){E(e)&&M.off(_(e),"click",this._selectFileDialogHandler)}_renderUploadButton(){if(this.option("uploadMode")!=="useButtons")return;const e=_("<div>").addClass("dx-fileuploader-button").addClass("dx-fileuploader-upload-button").appendTo(this._$content);this._uploadButton=this._createComponent(e,j,{text:this.option("uploadButtonText"),onClick:this._uploadButtonClickHandler.bind(this),type:this.option("_uploadButtonType"),integrationOptions:{},hoverStateEnabled:this.option("hoverStateEnabled")})}_uploadButtonClickHandler(){this._uploadFiles()}_shouldDragOverBeRendered(){return!this.option("readOnly")&&(this.option("uploadMode")!=="useForm"||this.option("nativeDropSupported"))}_isInteractionDisabled(){return this.option("readOnly")||this.option("disabled")}_renderInputContainer(){this._$inputContainer=_("<div>").addClass("dx-fileuploader-input-container").appendTo(this._$inputWrapper),this._$fileInput.addClass("dx-fileuploader-input"),this._renderInput();const e=`dx-fileuploader-input-label-${new ue}`;this._$inputLabel.attr("id",e).addClass("dx-fileuploader-input-label").appendTo(this._$inputContainer),this.setAria("labelledby",e,this._$fileInput)}_renderInput(){this.option("useNativeInputClick")?this._selectButton.option("template",this._selectButtonInputTemplate.bind(this)):(this._$fileInput.appendTo(this._$inputContainer),this._selectButton.option("template","content")),this._applyInputAttributes(this.option("inputAttr"))}_selectButtonInputTemplate(e,t){const o=_(t),a=_("<span>").addClass("dx-button-text").text(e.text);return o.append(a).append(this._$fileInput),o}_renderInputWrapper(){this._$inputWrapper=_("<div>").addClass("dx-fileuploader-input-wrapper").appendTo(this._$content)}_detachDragEventHandlers(e){E(e)&&M.off(_(e),T("",this.NAME))}_attachDragEventHandlers(e){const t=e!==this._$inputWrapper;!E(e)||!this._shouldDragOverBeRendered()||(this._detachDragEventHandlers(e),e=_(e),M.on(e,T("dragenter",this.NAME),this._dragEnterHandler.bind(this,t)),M.on(e,T("dragover",this.NAME),this._dragOverHandler.bind(this,t)),M.on(e,T("dragleave",this.NAME),this._dragLeaveHandler.bind(this,t)),M.on(e,T("drop",this.NAME),this._dropHandler.bind(this,t)))}_applyInputAttributes(e){this._$fileInput.attr(e)}_useInputForDrop(){return this.option("nativeDropSupported")&&this.option("uploadMode")==="useForm"}_getDropZoneElement(e,t){let o=e?Array.from(_(this.option("dropZone"))):[this._$inputWrapper];return o=o.map(a=>_(a).get(0)),o[o.indexOf(t.currentTarget)]}_dragEnterHandler(e,t){if(this.option("disabled"))return!1;this._useInputForDrop()||t.preventDefault();const o=this._getDropZoneElement(e,t);E(o)&&this._shouldRaiseDragOver(t,o)&&(this._activeDropZone=o,this._tryToggleDropZoneActive(!0,e,t))}_shouldRaiseDragOver(e,t){return this._activeDropZone===null&&this.isMouseOverElement(e,t,!1)&&e.originalEvent.dataTransfer.types.find(o=>o==="Files")}_dragOverHandler(e,t){if(this._useInputForDrop()||t.preventDefault(),t.originalEvent.dataTransfer.dropEffect="copy",!e){const o=this._getDropZoneElement(!1,t);this._shouldRaiseDragOver(t,o)&&this._dragEnterHandler(!1,t),this._shouldRaiseDragLeave(t,!1)&&this._dragLeaveHandler(!1,t)}}_dragLeaveHandler(e,t){this._useInputForDrop()||t.preventDefault(),this._shouldRaiseDragLeave(t,e)&&(this._tryToggleDropZoneActive(!1,e,t),this._activeDropZone=null)}_shouldRaiseDragLeave(e,t){return this._activeDropZone!==null&&!this.isMouseOverElement(e,this._activeDropZone,!t,-1)}_tryToggleDropZoneActive(e,t,o){const a=e?"addClass":"removeClass";this[e?"_dropZoneEnterAction":"_dropZoneLeaveAction"]({event:o,dropZoneElement:this._activeDropZone}),t||this.$element()[a]("dx-fileuploader-dragover")}_dropHandler(e,t){if(this._activeDropZone=null,e||this.$element().removeClass("dx-fileuploader-dragover"),this._useInputForDrop()||e&&this._isInteractionDisabled())return;t.preventDefault();const o=t.originalEvent.dataTransfer.files,a=this._getFiles(o);!this.option("multiple")&&a.length>1||a.length===0||(this._changeValue(a),this.option("uploadMode")==="instantly"&&this._uploadFiles())}_areAllFilesLoaded(){return this._files.every(e=>!e.isValid()||e._isError||e._isLoaded||e.isAborted)}_handleAllFilesUploaded(){this._recalculateProgress(),this._areAllFilesLoaded()&&this._filesUploadedAction()}_getAllowedFileTypes(e){return e.length?e.split(",").map(t=>t.trim()):[]}_isFileTypeAllowed(e,t){for(let o=0,a=t.length;o<a;o++){let i=t[o];if(i[0]==="."){if(i=i.replace(".","\\."),e.name.match(new RegExp(`${i}$`,"i")))return!0}else if(i=i.replace(new RegExp("\\*","g"),""),e.type.match(new RegExp(i,"i")))return!0}return!1}_renderWrapper(){const e=_("<div>").addClass("dx-fileuploader-wrapper").appendTo(this.$element()),t=_("<div>").addClass("dx-fileuploader-container").appendTo(e);this._$content=_("<div>").addClass("dx-fileuploader-content").appendTo(t)}_clean(){this._$fileInput.detach(),delete this._$filesContainer,this._detachSelectFileDialogHandler(this.option("dialogTrigger")),this._detachDragEventHandlers(this.option("dropZone")),this._files&&this._files.forEach(e=>{e.$file=null,e.$statusMessage=null}),super._clean()}abortUpload(e){if(this.option("uploadMode")!=="useForm")if(E(e)){const t=this._getFile(e);t&&this._preventFilesUploading([t])}else this._preventFilesUploading(this._files)}upload(e){if(this.option("uploadMode")!=="useForm")if(E(e)){const t=this._getFile(e);t&&Z()&&this._uploadFile(t)}else this._uploadFiles()}_uploadFiles(){Z()&&U(this._files,(e,t)=>this._uploadFile(t))}_uploadFile(e){this._uploadStrategy.upload(e)}_updateProgressBar(e,t){e.progressBar&&e.progressBar.option({value:t.loaded,showStatus:!0}),this._progressAction({file:e.value,segmentSize:t.currentSegmentSize,bytesLoaded:t.loaded,bytesTotal:t.total,event:t.event,request:e.request})}_updateTotalProgress(e,t){let o=0;E(e)&&(this._files.length>0&&this._areAllFilesLoaded()&&e===0&&t===0?o=this._getProgressValue(1):e&&(o=this._getProgressValue(t/e))),this.option("progress",o),this._setLoadedSize(t)}_getProgressValue(e){return Math.floor(100*e)}_initStatusMessage(e){e.$statusMessage.css("display","none")}_ensureCancelButtonInitialized(e){if(e.isInitialized)return;e.cancelButton.option("onClick",()=>{this._preventFilesUploading([e]),this._removeFile(e)});const t=()=>{setTimeout(()=>{e.cancelButton.option({visible:!1})},400)};e.onLoad.add(t),e.onError.add(t)}_createProgressBar(e){return this._createComponent(_("<div>"),me,{value:void 0,min:0,max:e,statusFormat:t=>`${this._getProgressValue(t)}%`,showStatus:!1,statusPosition:"right"})}_getTotalFilesSize(){return this._totalFilesSize||(this._totalFilesSize=0,U(this._files,(e,t)=>{this._totalFilesSize+=t.value.size})),this._totalFilesSize}_getTotalLoadedFilesSize(){return this._totalLoadedFilesSize||(this._totalLoadedFilesSize=0,U(this._files,(e,t)=>{this._totalLoadedFilesSize+=t.loadedSize})),this._totalLoadedFilesSize}_setLoadedSize(e){this._totalLoadedFilesSize=e}_recalculateProgress(){this._totalFilesSize=0,this._totalLoadedFilesSize=0,this._updateTotalProgress(this._getTotalFilesSize(),this._getTotalLoadedFilesSize())}isMouseOverElement(e,t,o){let a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;if(!t)return!1;const i=o?parseFloat(D.getComputedStyle(t,":before").height):0,n=o?parseFloat(D.getComputedStyle(t,":after").height):0,h=Q(t).left,u=Q(t).top+i,m=t.offsetWidth,d=t.offsetHeight-i-n,p=this._getEventX(e),c=this._getEventY(e);return p+a>=h&&p-a<h+m&&c+a>=u&&c-a<u+d}_getEventX(e){return ee(e)?this._getTouchEventX(e):e.clientX+this._getDocumentScrollLeft()}_getEventY(e){return ee(e)?this._getTouchEventY(e):e.clientY+this._getDocumentScrollTop()}_getTouchEventX(e){let t=null;return e.changedTouches.length>0?t=e.changedTouches:e.targetTouches.length>0&&(t=e.targetTouches),t?t[0].pageX:0}_getTouchEventY(e){let t=null;return e.changedTouches.length>0?t=e.changedTouches:e.targetTouches.length>0&&(t=e.targetTouches),t?t[0].pageY:0}_getDocumentScrollTop(){const e=te.getDocument();return e.documentElement.scrollTop||e.body.scrollTop}_getDocumentScrollLeft(){const e=te.getDocument();return e.documentElement.scrollLeft||e.body.scrollLeft}_updateReadOnlyState(){const e=this.option("readOnly");this._selectButton.option("disabled",e),this._files.forEach(t=>{var o;return(o=t.cancelButton)===null||o===void 0?void 0:o.option("disabled",e)}),this._updateInputLabelText(),this._attachDragEventHandlers(this._$inputWrapper)}_updateHoverState(){var e,t;const o=this.option("hoverStateEnabled");(e=this._selectButton)===null||e===void 0||e.option("hoverStateEnabled",o),(t=this._uploadButton)===null||t===void 0||t.option("hoverStateEnabled",o),this._files.forEach(a=>{var i,n;(i=a.uploadButton)===null||i===void 0||i.option("hoverStateEnabled",o),(n=a.cancelButton)===null||n===void 0||n.option("hoverStateEnabled",o)})}_optionChanged(e){const{name:t,value:o,previousValue:a}=e;switch(t){case"height":case"width":this._updateFileNameMaxWidth(),super._optionChanged(e);break;case"value":!o.length&&this._$fileInput.val(""),this._preventRecreatingFiles||(this._createFiles(),this._renderFiles()),this._recalculateProgress(),super._optionChanged(e);break;case"name":case"hint":this._initFileInput(),super._optionChanged(e);break;case"accept":this._initFileInput();break;case"multiple":this._initFileInput(),e.value||this.clear();break;case"readOnly":this._updateReadOnlyState(),super._optionChanged(e);break;case"disabled":this._updateInputLabelText(),super._optionChanged(e);break;case"selectButtonText":this._selectButton.option("text",o);break;case"uploadButtonText":this._uploadButton&&this._uploadButton.option("text",o);break;case"_uploadButtonType":this._uploadButton&&this._uploadButton.option("type",o);break;case"_buttonStylingMode":this._files.forEach(i=>{var n,h;(n=i.uploadButton)===null||n===void 0||n.option("stylingMode",o),(h=i.cancelButton)===null||h===void 0||h.option("stylingMode",o)});break;case"dialogTrigger":this._detachSelectFileDialogHandler(a),this._attachSelectFileDialogHandler(o);break;case"dropZone":this._detachDragEventHandlers(a),this._attachDragEventHandlers(o);break;case"maxFileSize":case"minFileSize":case"allowedFileExtensions":case"invalidFileExtensionMessage":case"invalidMaxFileSizeMessage":case"invalidMinFileSizeMessage":case"readyToUploadMessage":case"uploadedMessage":case"uploadFailedMessage":case"uploadAbortedMessage":case"nativeDropSupported":this._invalidate();break;case"labelText":this._updateInputLabelText();break;case"showFileList":this._preventRecreatingFiles||this._renderFiles();break;case"uploadFile":case"uploadChunk":case"chunkSize":this._setUploadStrategy();break;case"abortUpload":case"uploadUrl":case"progress":case"uploadMethod":case"uploadHeaders":case"uploadCustomData":case"extendSelection":break;case"hoverStateEnabled":this._updateHoverState(),super._optionChanged(e);break;case"allowCanceling":case"uploadMode":this.clear(),this._invalidate();break;case"onBeforeSend":this._createBeforeSendAction();break;case"onUploadStarted":this._createUploadStartedAction();break;case"onUploaded":this._createUploadedAction();break;case"onFilesUploaded":this._createFilesUploadedAction();break;case"onProgress":this._createProgressAction();break;case"onUploadError":this._createUploadErrorAction();break;case"onUploadAborted":this._createUploadAbortedAction();break;case"onDropZoneEnter":this._createDropZoneEnterAction();break;case"onDropZoneLeave":this._createDropZoneLeaveAction();break;case"useNativeInputClick":this._renderInput();break;case"useDragOver":this._attachDragEventHandlers(this._$inputWrapper);break;case"inputAttr":this._applyInputAttributes(this.option(t));break;default:super._optionChanged(e)}}_resetInputValue(e){this.option("uploadMode")==="useForm"&&!e||(this._doPreventInputChange=!0,this._$fileInput.val(""),this._doPreventInputChange=!1)}clear(){this.option("value",[])}}class St{constructor(e,t){this.file=e,this.chunkSize=t,this.index=0}read(){if(!this.file)return null;const e=this.createBlobResult(this.file,this.index,this.chunkSize);return e.isCompleted&&(this.file=null),this.index++,e}createBlobResult(e,t,o){const a=t*o;return{blob:this.sliceFile(e,a,o),index:t,isCompleted:a+o>=e.size}}sliceFile(e,t,o){return e.slice?e.slice(t,t+o):e.webkitSlice?e.webkitSlice(t,t+o):null}}class fe{constructor(e){this.fileUploader=e}upload(e){e.isInitialized&&e.isAborted&&this.fileUploader._resetFileState(e),e.isValid()&&!e.uploadStarted&&(this._prepareFileBeforeUpload(e),this._uploadCore(e))}abortUpload(e){if(!(e._isError||e._isLoaded||e.isAborted||!e.uploadStarted)&&(e.isAborted=!0,e.request&&e.request.abort(),this._isCustomCallback("abortUpload"))){const t=this.fileUploader.option("abortUpload"),o=this._createUploadArgument(e);let a=null;try{const i=t(e.value,o);a=G(i)}catch(i){a=X().reject(i).promise()}a.done(()=>e.onAbort.fire()).fail(i=>this._handleFileError(e,i))}}_beforeSend(e,t){const o=this._createUploadArgument(t);this.fileUploader._beforeSendAction({request:e,file:t.value,uploadInfo:o}),t.request=e}_createUploadArgument(e){}_uploadCore(e){}_isCustomCallback(e){const t=this.fileUploader.option(e);return t&&H(t)}_handleProgress(e,t){e._isError||(e._isProgressStarted=!0,this._handleProgressCore(e,t))}_handleProgressCore(e,t){}_handleFileError(e,t){e._isError=!0,e.onError.fire(t)}_prepareFileBeforeUpload(e){if(e.$file){var t;(t=e.progressBar)===null||t===void 0||t.dispose(),this.fileUploader._createFileProgressBar(e)}e.isInitialized||(e.onLoadStart.add(this._onUploadStarted.bind(this,e)),e.onLoad.add(this._onLoadedHandler.bind(this,e)),e.onError.add(this._onErrorHandler.bind(this,e)),e.onAbort.add(this._onAbortHandler.bind(this,e)),e.onProgress.add(this._onProgressHandler.bind(this,e)),e.isInitialized=!0)}_shouldHandleError(e,t){return(this._isStatusError(t.status)||!e._isProgressStarted)&&!e.isAborted}_isStatusError(e){return e>=400&&e<500||e>=500&&e<600}_onUploadStarted(e,t){e.uploadStarted=!0,this.fileUploader._uploadStartedAction({file:e.value,event:t,request:e.request})}_onAbortHandler(e,t){const o={file:e.value,event:t,request:e.request,message:this.fileUploader._getUploadAbortedStatusMessage()};this.fileUploader._uploadAbortedAction(o),this.fileUploader._setStatusMessage(e,o.message),this.fileUploader._handleAllFilesUploaded()}_onErrorHandler(e,t){const o={file:e.value,event:void 0,request:e.request,error:t,message:this.fileUploader.option("uploadFailedMessage")};this.fileUploader._uploadErrorAction(o),this.fileUploader._setStatusMessage(e,o.message),this.fileUploader._handleAllFilesUploaded()}_onLoadedHandler(e,t){const o={file:e.value,event:t,request:e.request,message:this.fileUploader.option("uploadedMessage")};e._isLoaded=!0,this.fileUploader._uploadedAction(o),this.fileUploader._setStatusMessage(e,o.message),this.fileUploader._handleAllFilesUploaded()}_onProgressHandler(e,t){if(e){const o=this.fileUploader._getTotalFilesSize(),a=this.fileUploader._getTotalLoadedFilesSize(),i=Math.min(t.loaded,e.value.size),n=i-e.loadedSize;e.loadedSize=i,this.fileUploader._updateTotalProgress(o,a+n),this.fileUploader._updateProgressBar(e,this._getLoadedData(i,t.total,n,t))}}_getLoadedData(e,t,o,a){return{loaded:e,total:t,currentSegmentSize:o}}_extendFormData(e){const t=this.fileUploader.option("uploadCustomData");for(const o in t)Object.prototype.hasOwnProperty.call(t,o)&&E(t[o])&&e.append(o,t[o])}}class ge extends fe{constructor(e){super(e),this.chunkSize=this.fileUploader.option("chunkSize")}_uploadCore(e){const t=e.value,o={name:t.name,loadedBytes:0,type:t.type,blobReader:new St(t,this.chunkSize),guid:new ue,fileSize:t.size,count:this._getFileChunksCount(t),customData:{}};e.chunksData=o,this._sendChunk(e,o)}_getFileChunksCount(e){return e.size===0?1:Math.ceil(e.size/this.chunkSize)}_sendChunk(e,t){const o=t.blobReader.read();t.currentChunk=o,o&&this._sendChunkCore(e,t,o).done(()=>{e.isAborted||(t.loadedBytes+=o.blob.size,e.onProgress.fire({loaded:t.loadedBytes,total:e.value.size}),o.isCompleted&&e.onLoad.fire(),setTimeout(()=>this._sendChunk(e,t)))}).fail(a=>{this._shouldHandleError(e,a)&&this._handleFileError(e,a)})}_sendChunkCore(e,t,o){}_tryRaiseStartLoad(e){e.isStartLoad||(e.isStartLoad=!0,e.onLoadStart.fire())}_getEvent(e){return null}_createUploadArgument(e){return this._createChunksInfo(e.chunksData)}_createChunksInfo(e){return{bytesUploaded:e.loadedBytes,chunkCount:e.count,customData:e.customData,chunkBlob:e.currentChunk.blob,chunkIndex:e.currentChunk.index}}}class Ft extends ge{_sendChunkCore(e,t,o){return ce.sendRequest({url:this.fileUploader.option("uploadUrl"),method:this.fileUploader.option("uploadMethod"),headers:this.fileUploader.option("uploadHeaders"),beforeSend:a=>this._beforeSend(a,e),upload:{onprogress:a=>this._handleProgress(e,a),onloadstart:()=>this._tryRaiseStartLoad(e),onabort:()=>e.onAbort.fire()},data:this._createFormData({fileName:t.name,blobName:this.fileUploader.option("name"),blob:o.blob,index:o.index,count:t.count,type:t.type,guid:t.guid,size:t.fileSize})})}_createFormData(e){const t=new D.FormData;return t.append(e.blobName,e.blob),t.append("chunkMetadata",JSON.stringify({FileName:e.fileName,Index:e.index,TotalCount:e.count,FileSize:e.size,FileType:e.type,FileGuid:e.guid})),this._extendFormData(t),t}}class Ct extends ge{_sendChunkCore(e,t){this._tryRaiseStartLoad(e);const o=this._createChunksInfo(t),a=this.fileUploader.option("uploadChunk");try{const i=a(e.value,o);return G(i)}catch(i){return X().reject(i).promise()}}_shouldHandleError(e,t){return!0}}class be extends fe{_uploadCore(e){e.loadedSize=0,this._uploadFile(e).done(()=>{e.isAborted||e.onLoad.fire()}).fail(t=>{this._shouldHandleError(e,t)&&this._handleFileError(e,t)})}_uploadFile(e){}_handleProgressCore(e,t){e.onProgress.fire(t)}_getLoadedData(e,t,o,a){const i=super._getLoadedData(e,t,o,a);return i.event=a,i}}class Et extends be{_uploadFile(e){return ce.sendRequest({url:this.fileUploader.option("uploadUrl"),method:this.fileUploader.option("uploadMethod"),headers:this.fileUploader.option("uploadHeaders"),beforeSend:t=>this._beforeSend(t,e),upload:{onprogress:t=>this._handleProgress(e,t),onloadstart:()=>e.onLoadStart.fire(),onabort:()=>e.onAbort.fire()},data:this._createFormData(this.fileUploader.option("name"),e.value)})}_createFormData(e,t){const o=new D.FormData;return o.append(e,t,t.name),this._extendFormData(o),o}}class yt extends be{_uploadFile(e){e.onLoadStart.fire();const t=a=>{const i={loaded:a,total:e.value.size};this._handleProgress(e,i)},o=this.fileUploader.option("uploadFile");try{const a=o(e.value,t);return G(a)}catch(a){return X().reject(a).promise()}}_shouldHandleError(e,t){return!0}}q("dxFileUploader",vt);function wt({subproyectos:s,laboratorios:e,filteredEventos:t,matrices:o,formData:a,protocolos:i}){const[n,h]=I.useState(null),[u,m]=I.useState(null);return r.jsxs(r.Fragment,{children:[r.jsxs(N,{caption:"Datos de referencia",colSpan:8,colCount:2,children:[r.jsx(C,{dataField:"subproyecto",editorType:"dxSelectBox",editorOptions:{dataSource:s,displayExpr:d=>d?`${d.codigo} - ${d.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0},children:r.jsx(L,{text:"Seleccione un Subproyecto"})}),r.jsx(C,{dataField:"evento",editorType:"dxSelectBox",editorOptions:{dataSource:t,displayExpr:d=>d?`${Oe(new Date(d.fecha),"dd/MM/yyyy")} - ${d.nombre}`:"",valueExpr:"id",searchEnabled:!0},children:r.jsx(L,{text:"Seleccione un Evento de Muestreo"})}),r.jsx(C,{dataField:"matrizId",caption:"Matriz",editorType:"dxSelectBox",editorOptions:{dataSource:o,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0},children:r.jsx(L,{text:"Seleccione una Matriz"})}),r.jsx(C,{dataField:"laboratorio",editorType:"dxSelectBox",editorOptions:{dataSource:e,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0},children:r.jsx(L,{text:"Seleccione un Laboratorio"})})]}),r.jsxs(N,{caption:"Adelanto de Protocolo",colSpan:4,colCount:1,children:[r.jsx(C,{dataField:"adelanto",editorType:"dxFileUploader",cssClass:"file-uploader-container",editorOptions:{selectButtonText:"Seleccionar archivo",labelText:"o arrastre un archivo aquí",accept:".xlsx",uploadMode:"useForm",width:"100%",disabled:!(a.evento&&a.laboratorio)||u,onValueChanged:d=>{h(d.value[0]||null),d.value[0]&&m(null)}},children:r.jsx(L,{text:"Cargar archivo Excel"})}),r.jsx(C,{dataField:"importados",editorType:"dxSelectBox",editorOptions:{dataSource:i,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0,uploadMode:"useForm",width:"100%",disabled:!(a.evento&&a.laboratorio)||n,onValueChanged:d=>{m(d.value||null),d.value&&h(null)}},children:r.jsx(L,{text:"Protocolos Importados"})})]})]})}function Mt({subproyectos:s,eventos:e,laboratorios:t,matrices:o,formData:a}){var i,n,h,u,m,d;return r.jsxs(r.Fragment,{children:[r.jsx(C,{colSpan:3,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((i=s.find(p=>p.id===a.subproyecto))==null?void 0:i.nombreLocacion)||"No seleccionado"},children:r.jsx(L,{text:"Subproyecto"})}),r.jsx(C,{colSpan:3,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((n=e.find(p=>p.id===a.evento))==null?void 0:n.nombre)||"No seleccionado"},children:r.jsx(L,{text:"Evento"})}),r.jsx(C,{colSpan:2,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((h=t.find(p=>p.id===a.laboratorio))==null?void 0:h.nombre)||"No seleccionado"},children:r.jsx(L,{text:"Laboratorio"})}),r.jsx(C,{colSpan:1,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((u=o.find(p=>p.id===a.matrizId))==null?void 0:u.nombre)||"No seleccionado"},children:r.jsx(L,{text:"Matriz"})}),r.jsx(C,{colSpan:3,editorType:"dxTextBox",editorOptions:{readOnly:!0,value:((d=(m=a.adelanto)==null?void 0:m[0])==null?void 0:d.name)||"Archivo no cargado"},children:r.jsx(L,{text:"Archivo Importado"})})]})}function Lt({adelantoData:s,setAdelantoData:e,matrizId:t}){const{compuestos:o,isLoadingCompuestos:a}=Pe(),{metodos:i,isLoadingMetodos:n}=je(),{UM:h,isLoadingUM:u}=Re(),m=I.useMemo(()=>o.filter(p=>p.matrizCodigo===t),[o,t]);if(a||n||u)return r.jsx("div",{children:"Cargando datos..."});const d=p=>{const{data:c}=p;e(g=>({...g,data:g.data.map(x=>x.compuestoLab===c.compuestoLab?{...x,...c}:x)}))};return r.jsxs(Y,{dataSource:s.data,keyExpr:"compuestoLab",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:450,scrolling:{mode:"virtual"},allowColumnResizing:!0,columnResizingMode:"widget",onRowUpdated:d,children:[r.jsx(J,{mode:"cell",allowUpdating:!0}),r.jsx(y,{dataField:"compuestoLab",caption:"Compuesto (Lab)",width:320,allowEditing:!1}),r.jsx(y,{dataField:"compuestoId",caption:"Compuesto (BFU)",width:320,lookup:{dataSource:m,valueExpr:"id",displayExpr:"nombre"}}),r.jsx(y,{dataField:"metodoLab",caption:"Metodo (Lab)",allowEditing:!1}),r.jsx(y,{dataField:"metodoId",caption:"Metodo (BFU)",lookup:{dataSource:i,valueExpr:"id",displayExpr:"nombre"}}),r.jsx(y,{dataField:"unidadLab",caption:"UM (Lab)",allowEditing:!1}),r.jsx(y,{dataField:"unidadId",caption:"UM (BFU)",lookup:{dataSource:h,valueExpr:"id",displayExpr:"nombre"}})]})}function $t({adelantoData:s,setAdelantoData:e,muestras:t}){const o=a=>{const{data:i}=a;e(n=>({...n,muestras:n.muestras.map(h=>h.muestraLab===i.muestraLab?{...h,...i}:h)}))};return r.jsxs(Y,{dataSource:s.muestras,keyExpr:"muestraLab",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:450,scrolling:{mode:"virtual"},onRowUpdated:o,children:[r.jsx(J,{mode:"cell",allowUpdating:!0}),r.jsx(y,{dataField:"muestraLab",caption:"Laboratorio",allowEditing:!1}),r.jsx(y,{dataField:"muestraCadena",caption:"Cadena",lookup:{dataSource:t||[],valueExpr:"muestraId",displayExpr:"muestra"}})]})}function It({formData:s,subproyectos:e,laboratorios:t,eventos:o,matrices:a,adelantoData:i,setAdelantoData:n,muestras:h,modo:u}){const d=window.innerWidth/100;return r.jsxs(N,{colSpan:12,colCount:12,children:[r.jsx(Mt,{subproyectos:e,eventos:o,laboratorios:t,matrices:a,formData:s}),r.jsxs(we,{deferRendering:!1,colSpan:12,children:[r.jsx(oe,{title:"Vista Importada",children:r.jsxs(Y,{dataSource:i.data,keyExpr:"compuestoLab",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!1,height:450,scrolling:{mode:"virtual"},onCellPrepared:p=>{p.rowType==="data"&&p.column.dataField!=="compuestoId"&&p.column.dataField!=="metodoId"&&p.column.dataField!=="unidadId"&&(p.value===-1?p.cellElement.style.backgroundColor="#E0F7E9":p.value===-2&&(p.cellElement.style.backgroundColor="#ECEFF1"))},children:[r.jsx(y,{dataField:"compuestoLab",caption:"Compuesto",fixed:!0,fixedPosition:"left",width:12*d}),r.jsx(y,{dataField:"metodoLab",caption:"Método",fixed:!0,fixedPosition:"left",width:12*d}),r.jsx(y,{dataField:"unidadLab",caption:"Unidad",fixed:!0,fixedPosition:"left",width:5*d}),r.jsx(J,{allowUpdating:u==="excel",allowAdding:!1,allowDeleting:!1,mode:"cell"}),Object.keys(i.data[0]).filter(p=>!["compuestoId","metodoId","unidadId","compuestoLab","metodoLab","unidadLab"].includes(p)).map(p=>r.jsx(y,{dataField:p,caption:p,cellRender:({value:c})=>ke(c)},p))]})}),r.jsxs(oe,{title:"Asignación Compuestos",colCount:12,children:[r.jsx(C,{colSpan:9,children:r.jsx(Lt,{adelantoData:i,setAdelantoData:n,matrizId:s.matrizId})}),r.jsx(C,{colSpan:3,children:r.jsx($t,{adelantoData:i,setAdelantoData:n,muestras:h})})]})]})]})}const Bt=async(s,e,t,o,a,i,n,h)=>{if(s)try{const{matrizLab:u,muestrasListLab:m,warnMessages:d}=await nt(s,i);d.length>0&&n({visible:!0,message:d.join(`
`),type:"warning"});const p=await ct(u,e.matrizId),c=await mt(m,a.muestras);t({data:p,muestras:c}),h("excel")}catch(u){console.error("Error:",u),n({visible:!0,message:`Error al procesar el archivo: ${u.message||u}`,type:"error"}),o(m=>({...m,adelanto:[]}))}},Ut=(s,e,t)=>{let o=[];const a=e.data.filter(n=>n.compuestoId===null||n.metodoId===null||n.unidadId===null);a.length>0&&o.push(`Hay ${a.length} compuestos sin asignar.`);const i=e.muestras.filter(n=>n.muestraCadena===null);return i.length>0&&o.push(`Hay ${i.length} muestras sin referencia en la cadena de custodia.`),o.length>0?(t({visible:!0,message:`Error: ${o.join(" ")}`,type:"warning"}),!1):!0},At=async(s,e,t,o,a)=>{try{if(!Ut(e,t,o))return;const i=await ze(e,t);o({visible:!0,message:"Protocolo guardado exitosamente.",type:"success"}),a()}catch(i){console.error("Error al guardar el protocolo:",i),o({visible:!0,message:`Error al guardar el protocolo: ${i.message}`,type:"error"})}},kt=async(s,e,t,o,a)=>{if(s)try{const i=await Te(s);e({data:i.adelantoData.data,muestras:i.adelantoData.muestras}),a("protocolo")}catch(i){console.error("Error:",i),o({visible:!0,message:`Error al cargar el protocolo: ${i.message||i}`,type:"error"}),t(n=>({...n,adelanto:[]}))}};function Kt(){const[s,e]=I.useState({visible:!1,message:"",type:"info"}),[t,o]=I.useState({data:[],muestras:[]}),[a,i]=I.useState([]),[n,h]=I.useState(null),[u,m]=I.useState({subproyecto:null,evento:null,laboratorio:null,adelanto:null,matrizId:null,protocoloSeleccionado:null}),{laboratorios:d}=Ie(),{subproyectos:p}=$e(),{eventos:c}=Le(!1),{matrizEvento:g}=Ne(u.evento),{matrices:x}=Ue(),{protocolos:l}=gt(u.evento,u.matrizId,u.laboratorio),v=()=>{o({data:[],muestras:[]}),m({subproyecto:null,evento:null,laboratorio:null,adelanto:null,matrizId:null,protocoloSeleccionado:null}),i([]),h(null)},w=I.useCallback(async f=>{const S={...u,[f.dataField]:f.value};if(f.dataField==="subproyecto"&&i(c.filter(b=>b.subproyectoId===f.value)),["subproyecto","evento","matrizId","laboratorio"].includes(f.dataField)&&(h(null),o({data:[],muestras:[]}),S.adelanto=null,S.protocoloSeleccionado=null),f.dataField==="adelanto"&&f.value){const b=d.find($=>$.id===S.laboratorio);await Bt(f.value[0],S,o,m,g,b==null?void 0:b.formato,e,h)}if(f.dataField==="importados"&&f.value){const b=l.find($=>$.id===f.value);S.adelanto=b?[{name:b.nombre}]:null,await kt(f.value,o,m,e,h)}m(S)},[c,g,d,l]);return r.jsxs("div",{children:[r.jsx(Me,{formData:u,onFieldDataChanged:w,colCount:12,children:t.data.length<=0?r.jsx(wt,{subproyectos:p,laboratorios:d,filteredEventos:a,matrices:x,formData:u,protocolos:l}):r.jsxs(r.Fragment,{children:[r.jsx(It,{subproyectos:p,laboratorios:d,eventos:c,matrices:x,formData:u,adelantoData:t,setAdelantoData:o,muestras:g.muestras,modo:n}),r.jsxs(N,{cssClass:"buttons-group",colSpan:12,colCount:12,children:[r.jsx(ae,{colSpan:10}),n!="protocolo"?r.jsx(se,{colSpan:1,buttonOptions:{text:"Confirmar",type:"default",onClick:f=>At(f,u,t,e,v)}}):r.jsx(ae,{colSpan:1}),r.jsx(se,{colSpan:1,buttonOptions:{text:"Cancelar",type:"default",onClick:v}})]})]})}),r.jsx(De,{visible:s.visible,message:s.message,type:s.type,displayTime:4e3,onHiding:()=>e({...s,visible:!1})})]})}export{Kt as default};
