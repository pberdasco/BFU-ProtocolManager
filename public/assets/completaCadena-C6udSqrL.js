import{j as c,S as I,_ as v,af as P,r as E,F as V,$ as G,a0 as M}from"./index-Cm1k3WOj.js";import{T as H}from"./toast-Y0YPr_e4.js";import"./tag-box-CWUWQ9QM.js";import{a as Q}from"./protocolosDataAccess-Hi5oC4Od.js";import{e as y,f as Z,s as q,d as W,a as J}from"./cadenaCompletaDataAccess-Dvit168Y.js";import{s as b,f as X}from"./specialValues-CHSjwz8L.js";import{f as Y}from"./localization-BrGm2QGq.js";import{D as ee,E as oe,C as j}from"./data-grid-BFs8E209.js";import{u as se}from"./subproyectos-BsnxX71z.js";import{u as te}from"./eventos-WOvfGx5T.js";import{u as ae}from"./cadenas-ZmfLKR77.js";import{u as re}from"./compuestos-Dak9RLOv.js";import{u as ne}from"./metodos-BaRMbRPg.js";import{u as le}from"./um-C4DC3yG0.js";import{a as de}from"./apiResource-5P-thon0.js";import{u as ie}from"./useQuery-CW2cZTZx.js";import"./m_utils.scroll-Spvb4scB.js";import"./m_export-0R763p3z.js";const S=["id","estado","compuestoId","metodoId","umId","protocoloItemId"];function L(o,a,s){const r=s.length>0?Object.keys(s[0]).filter(n=>!S.includes(n)):a.protocoloMuestras.map(n=>n.muestraCadena);return{id:1e3+o.id,estado:y.nueva,compuestoId:o.compuestoId,metodoId:o.metodoId,umId:o.unidadId,protocoloItemId:o.id,...r.reduce((n,d)=>({...n,[d]:null}),{})}}function w(o,a,s,r,n,d){let t=!1;return Object.keys(o).forEach(e=>{if(!S.includes(e)){console.log("key: ",e),console.log("muestrasList:",r);const u=s.protocoloMuestras.find(m=>{console.log("muestras: ",m);const l=r.find(i=>i.muestraId==m.muestraCadena);return console.log("muestraFromList:  ",l),l&&l.muestra===e});if(u){console.log("protocoloResultados: ",u.id,s.protocoloResultados),console.log("protocoloItem: ",a);const m=s.protocoloResultados.find(l=>l.itemProtocoloId===a.id&&l.muestraProtocoloId===u.id);if(m){const l=o[e];o[e]=m.valor,l!=null&&l!==b.NO_ANALIZADO&&(t=!0)}}}}),n&&(o.protocoloItemId=a.id,o.metodoId===1e3||o.metodoId===a.metodoId?o.estado=y.encontrada:o.estado=y.metodoNoCoincide,o.metodoId=a.metodoId,a.unidadId&&(o.umId=a.unidadId)),t&&d.push({compuesto:a.compuestoLab,metodo:a.metodoLab}),o}function ce(o,a){const s=new Map;o.forEach(t=>{const e=a.find(u=>u.id===t.compuestoId);e&&e.agrupaEn&&(s.has(e.agrupaEn)||s.set(e.agrupaEn,[]),s.get(e.agrupaEn).push(e.id))});const r=new Map;function n(t,e=0){if(!s.has(t))return e;if(r.has(t))return r.get(t);let u=e;for(const m of s.get(t))u=Math.max(u,n(m,e+1));return r.set(t,u),u}return Array.from(s.keys()).forEach(t=>n(t)),Array.from(r.keys()).sort((t,e)=>r.get(t)-r.get(e)).forEach(t=>{const e=o.find(u=>u.compuestoId===t&&u.estado===y.noEncontrada);if(e){const u=s.get(t)||[],m=o.filter(i=>u.includes(i.compuestoId));let l=!1;m.forEach(i=>{Object.keys(e).forEach(p=>{if(!S.includes(p)){let h=e[p],g=i[p];h=h!==null&&h!==""?parseFloat(h):null,g=g!==null&&g!==""?parseFloat(g):null,h===null?(e[p]=g,l=!0,!e.umId&&i.umId&&(e.umId=i.umId)):[b.LQ,b.NO_DETECTADO,b.NO_ANALIZADO].includes(h)&&g!==null&&(g>=0||g===b.LQ)?(e[p]=g,l=!0):h>=0&&g!==null&&g>=0&&(e[p]=Math.round((e[p]+g)*1e3)/1e3,l=!0)}})}),l&&(e.estado=y.calculada)}}),o}async function ue(o,a,s,r){console.log("cadenaCompleta: ",a);const n=[];if(!o||o.length===0)return{estado:"error",mensaje:"Falta seleccionar protocolo",repetidos:[]};let d=[...a.filas];for(const t of o)try{const e=await Q(t);if(!(e!=null&&e.protocoloItems))return{estado:"error",mensaje:`Protocolo ${t} no tiene items`,repetidos:[]};e.protocoloItems.forEach(u=>{const m=d.filter(l=>l.compuestoId===u.compuestoId);if(console.log("matchingRows: ",m),console.log("updatedFilas: ",d),m.length===1){const l=d.findIndex(p=>p.compuestoId===u.compuestoId),i=w(d[l],u,e,a.muestras,!0,n);d[l]=i,console.log("mR.L=1 =>",l,"=> ",i)}else if(m.length>1){const l=m.find(i=>i.metodoId===u.metodoId);if(l){const i=d.findIndex(h=>h.id===l.id),p=w(l,u,e,a.muestras,!0,n);d[i]=p,console.log("rowConMetodo =>",i,"=> ",p)}else{let i=L(u,e,d);const p=w(i,u,e,a.muestras,!1,n);N(p)&&d.push(p),console.log("rowSinMetodo =>",i,p)}}else{let l=L(u,e,d);const i=w(l,u,e,a.muestras,!1,n);N(i)&&d.push(i),console.log("noMatching =>",l,i)}})}catch(e){console.error(`Error al procesar el protocolo ${t}:`,e);continue}return d=ce(d,r),s({...a,filas:d}),n.length>0?{estado:"warning",mensaje:"Existen datos repetidos",repetidos:n}:{estado:"Ok"}}function N(o){return Object.keys(o).filter(r=>!S.includes(r)).some(r=>Number(o[r])!==b.NO_ANALIZADO&&o[r]!=null)}function me({subproyectos:o,filteredEventos:a,cadenas:s,protocolos:r,grillaCargada:n,protocoloSeleccionado:d}){return c.jsxs(c.Fragment,{children:[c.jsx(I,{dataField:"subproyecto",editorType:"dxSelectBox",editorOptions:{dataSource:o,displayExpr:t=>t?`${t.codigo} - ${t.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0},children:c.jsx(v,{text:"Seleccione un Subproyecto"})}),c.jsx(I,{dataField:"evento",editorType:"dxSelectBox",editorOptions:{dataSource:a,displayExpr:t=>t?`${Y(new Date(t.fecha),"dd/MM/yyyy")} - ${t.nombre}`:"",valueExpr:"id",searchEnabled:!0},children:c.jsx(v,{text:"Seleccione un Evento de Muestreo"})}),c.jsx(I,{dataField:"cadena",editorType:"dxSelectBox",editorOptions:{dataSource:s,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0},children:c.jsx(v,{text:"Seleccione una Cadena de Custodia"})}),c.jsx(I,{dataField:"protocolosSeleccionados",editorType:"dxTagBox",editorOptions:{dataSource:r,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0,disabled:!n||d,showSelectionControls:!0,maxDisplayedTags:2,applyValueMode:"useButtons"},children:c.jsx(v,{text:"Seleccione uno o mas Protocolos"})})]})}function pe({filas:o,muestras:a,compuestos:s,metodos:r,UM:n,onRowPrepared:d}){return c.jsx(P,{colSpan:4,children:c.jsxs(ee,{dataSource:o,keyExpr:"id",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:450,scrolling:{mode:"virtual"},onRowPrepared:d,children:[c.jsx(oe,{mode:"cell",allowUpdating:!0,allowDeleting:!0}),c.jsx(j,{dataField:"compuestoId",caption:"Compuesto",allowEditing:!1,width:250,lookup:{dataSource:s,valueExpr:"id",displayExpr:"nombre"},fixed:!0}),c.jsx(j,{dataField:"metodoId",caption:"Método",allowEditing:!1,width:250,lookup:{dataSource:r,valueExpr:"id",displayExpr:"nombre"}}),c.jsx(j,{dataField:"umId",caption:"UM",width:80,lookup:{dataSource:n,valueExpr:"id",displayExpr:"nombre"}}),a.map(t=>c.jsx(j,{dataField:t.muestra,caption:t.muestra,cellRender:({value:e})=>X(e)},t.muestra))]})})}const fe=async(o,a)=>{const s=new de("protocolos");let r=[];return o!==0&&r.push(["eventoMuestreoId","=",o]),o!==0&&a!==0&&r.push("and"),a!==0&&r.push(["matrizId","=",a]),r.length===0&&(r=null),(await s.fetch({filter:r,sort:[{selector:"fecha",desc:!1}]})).data},ge=(o,a)=>{const{data:s=[],isLoading:r,error:n,...d}=ie({queryKey:["protocolos",o,a],queryFn:()=>fe(o,a),enabled:o!=null&&a!=null});return{protocolos:s,isLoadingProtocolos:r,isErrorProtocolos:n,...d}},he=["id","estado","compuestoId","metodoId","umId","protocoloItemId"];async function xe(o,a,s,r){if(!o.value){a([]);return}try{const n=await Z(o.value);n&&n.filas&&n.filas.length>0?(a(n),s(!0),r(!0)):(await $(o,a),s(!1),r(!1))}catch(n){console.error("Error al cargar la cadena completa guardada:",n),await $(o,a),s(!1),r(!1)}}async function $(o,a){if(!o.value){a([]);return}try{const s=await J(o.value),r=s.muestras.reduce((t,e)=>(t[e.muestra]=null,t),{}),n=s.compuestos.map((t,e)=>({id:e+1,estado:y.noEncontrada,compuestoId:t.compuestoId,metodoId:t.metodoId,umId:null,protocoloItemId:null,...r})),d=s.muestras.map(t=>({muestraId:t.muestraId,muestra:t.muestra,tipo:t.tipo,pozo:t.pozo||null}));a({filas:n,muestras:d})}catch(s){console.error("Error al obtener los datos de la cadena:",s)}}const ye=async(o,a,s,r,n,d,t)=>{try{if(!s||!s.filas||s.filas.length===0){r({visible:!0,message:"No hay datos para guardar.",type:"warning"});return}const e=s.filas.filter(m=>m.umId?Object.keys(m).some(l=>!he.includes(l)&&(m[l]===null||m[l]==="")):!0);if(e.length>0){const m=e.map(i=>{const p=d.find(h=>h.id===i.compuestoId);return p?p.nombre:`ID ${i.compuestoId}`}),l=[...new Set(m)];r({visible:!0,message:`Hay ${e.length} filas con datos faltantes. Compuestos afectados: ${l.join(", ")}.`,type:"warning"});return}const u=await q(a.cadena,s,t);r({visible:!0,message:"Cadena completa guardada exitosamente.",type:"success"}),n()}catch(e){console.error("Error al guardar la cadena completa:",e),r({visible:!0,message:`Error al guardar la cadena completa: ${e.message}`,type:"error"})}},Ee=async(o,a,s)=>{try{await W(o.cadena),a({visible:!0,message:"Cadena eliminada exitosamente.",type:"success"}),s()}catch{a({visible:!0,message:"Error al eliminar la cadena.",type:"error"})}};function Te(){var O,A,R;const[o,a]=E.useState([]),[s,r]=E.useState({subproyecto:null,evento:null,cadena:null,protocolosSeleccionados:[]}),[n,d]=E.useState([]),[t,e]=E.useState(!1),[u,m]=E.useState(!1),[l,i]=E.useState({visible:!1,message:"",type:"info"}),{subproyectos:p}=se(),{eventos:h}=te(!1),{cadenas:g}=ae(s.evento),{compuestos:C}=re(),{metodos:k}=ne(),{UM:T}=le(),B=((O=g==null?void 0:g.find(f=>f.id===s.cadena))==null?void 0:O.matrizCodigo)||null,{protocolos:K}=ge(s.evento,B),F=()=>{d({filas:[],muestras:[]}),e(!1),m(!1),r({subproyecto:null,evento:null,cadena:null,protocolosSeleccionados:[]})},z=E.useCallback(async f=>{if(f.dataField==="subproyecto")a(h.filter(x=>x.subproyectoId===f.value));else if(f.dataField==="cadena")await xe(f,d,e,m);else if(f.dataField==="protocolosSeleccionados"){const x=await ue(f.value||[],n,d,C);if(m(!0),x.estado!=="Ok")if(x.repetidos&&x.repetidos.length>0){const U=x.repetidos.map(D=>` Compuesto: ${D.compuesto},  - Método: ${D.metodo} `).join(`
`);i({visible:!0,message:x.mensaje+U,type:x.estado})}else i({visible:!0,message:x.mensaje,type:x.estado})}r(x=>({...x,[f.dataField]:f.value}))},[s,h,g,n]),_=E.useCallback(f=>{if(f.rowType==="data")switch(f.data.estado){case y.encontrada:f.rowElement.style.color="green";break;case y.nueva:f.rowElement.style.color="blue";break;case y.calculada:f.rowElement.style.color="violet";break;case y.metodoNoCoincide:f.rowElement.style.color="goldenrod";break;default:f.rowElement.style.color="red";break}},[]);return c.jsxs("div",{children:[c.jsxs(V,{formData:s,onFieldDataChanged:z,colCount:4,children:[c.jsx(me,{subproyectos:p,filteredEventos:o,cadenas:g,protocolos:K,grillaCargada:((A=n.filas)==null?void 0:A.length)>0,protocoloSeleccionado:u}),((R=n.filas)==null?void 0:R.length)>0&&c.jsxs(c.Fragment,{children:[c.jsx(pe,{filas:n.filas,muestras:n.muestras,compuestos:C,metodos:k,UM:T,onRowPrepared:_}),c.jsxs(P,{cssClass:"buttons-group",colSpan:4,colCount:12,children:[c.jsx(G,{colSpan:10-(t?1:0)}),c.jsx(M,{colSpan:1,buttonOptions:{text:"Confirmar",type:"default",width:120,onClick:f=>ye(f,s,n,i,F,C,t)}}),c.jsx(M,{colSpan:1,buttonOptions:{text:"Cancelar",type:"default",width:120,onClick:F}}),t&&c.jsx(M,{colSpan:1,buttonOptions:{text:"Borrar",type:"default",width:120,onClick:()=>Ee(s,i,F)}})]})]})]}),c.jsx(H,{visible:l.visible,message:l.message,type:l.type,displayTime:4e3,onHiding:()=>i({...l,visible:!1})})]})}export{Te as default};
