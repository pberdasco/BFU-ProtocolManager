import{j as r,r as F,B as z}from"./index-Dyddoe5k.js";import{G as w}from"./GenericGrid-ojUWl94W.js";import{u as h}from"./useQuery-DA5bnrbd.js";import{a as I}from"./apiResource-5P-thon0.js";import{u as A}from"./pozosDeSubproyecto-DsjkQeN3.js";import{u as L}from"./autAplicacion-De4aNhpz.js";import{S as R}from"./select-box-Ba2NQo3R.js";import{P as T}from"./popup-qIGyxpRH.js";import"./data-grid-ByYvucdn.js";import"./m_export-BSg2CvWz.js";import"./localization-CAfdGNO3.js";import"./excelExport-D57iZOje.js";import"./exceljs.min-CR6lYXX8.js";import"./export_merged_ranges_manager-wABkCk97.js";function f(o){const a=/(\d{1,3})춿(\d{1,2})'(\d{1,2}(?:[.,]\d+)?)"?([NSEW])/i,t=o.trim().match(a);if(!t)return null;let[,d,s,c,p]=t;c=c.replace(",",".");let u=parseInt(d)+parseInt(s)/60+parseFloat(c)/3600;return/S|W/i.test(p)&&(u*=-1),+u.toFixed(6)}function E(o,a="lat"){const t=a==="lat"?o>=0?"N":"S":o>=0?"E":"W",d=Math.abs(o),s=Math.floor(d),c=Math.floor((d-s)*60),p=((d-s-c/60)*3600).toFixed(2).replace(".",",");return`${s}춿${c}'${p}"${t}`}function b(o){if(typeof o!="string")return o;const a=o.match(/^(\d{8})([NSWE])$/i);if(!a)return o;const[,t,d]=a,s=t.substring(0,2),c=t.substring(2,4),p=t.substring(4,6),u=t.substring(6,8);return`${s}춿${c}'${p},${u}"${d.toUpperCase()}`}const O=async()=>(await new I("pozosEstado").fetch()).data.map(t=>({id:t.id,display:t.nombre})),P=async()=>(await new I("pozosTipo").fetch()).data.map(t=>({id:t.id,display:t.nombre})),j=o=>{if((o.dataField==="latitud"||o.dataField==="longitud")&&(o.parentType==="dataRow"||o.parentType==="form")){const a=o.dataField==="latitud",t=a?"lat":"lon",d=o.value;d==null?o.editorOptions.value=a?`00춿00'00,00"S`:`00춿00'00,00"W`:o.editorOptions.value=E(d,t)}},k=(o,a)=>{o.data.subproyectoId=a.id,o.data.subproyecto=a.codigo},$=(o,a)=>{o.changes.length>0&&o.changes.length>0&&o.changes.forEach(t=>{if(t.type==="insert"||t.type==="update"){if(t.data.subproyectoId||(t.data.subproyectoId=a),typeof t.data.latitud=="string")if(t.data.latitud.replace(/[^0-9]/g,"")==="")delete t.data.latitud;else{const s=f(b(t.data.latitud));t.data.latitud=s===0?null:s}if(typeof t.data.longitud=="string")if(t.data.longitud.replace(/[^0-9]/g,"")==="")delete t.data.longitud;else{const s=f(b(t.data.longitud));t.data.longitud=s===0?null:s}}})};function C({subproyecto:o}){if(!o)return r.jsx("div",{children:"No se ha seleccionado un subproyecto"});const{data:a,isLoading:t,error:d}=h({queryKey:["estados"],queryFn:O}),{data:s,isLoading:c,error:p}=h({queryKey:["tipos"],queryFn:P}),{pozos:u}=A(o.id),x=[{icon:"globe",hint:"Ver en Google Maps",name:"verMapa",onClick:i=>{const{latitud:n,longitud:g}=i.row.data;if(n&&g){const y=`https://www.google.com/maps?q=${n},${g}`;window.open(y,"_blank")}else alert("Este pozo no tiene coordenadas v치lidas.")}}],m=()=>{if(!u||u.length===0){alert("No se encontraron pozos para este subproyecto.");return}const i=u.filter(n=>n.latitud&&n.longitud&&n.latitud!==0&&n.longitud!==0);if(i.length===0){alert("No hay pozos con coordenadas v치lidas en este subproyecto.");return}if(i.length===1){const n=i[0],g=`https://www.google.com/maps?q=${n.latitud},${n.longitud}&z=15`;window.open(g,"_blank")}else{const g={type:"FeatureCollection",features:i.map(l=>({type:"Feature",geometry:{type:"Point",coordinates:[l.longitud,l.latitud]},properties:{title:l.nombre||`Pozo ${l.id}`,estado:l.estado,tipo:l.tipo}}))},e=`https://geojson.io/#data=data:application/json,${encodeURIComponent(JSON.stringify(g))}&map=table`;window.open(e,"_blank")}},S=[{dataField:"id",width:90,caption:"ID",allowFiltering:!1,allowSearch:!1},{dataField:"subproyectoId",visible:!1},{dataField:"subproyecto",caption:"Subproyecto"},{dataField:"nombre",caption:"Pozo",validationRules:[{type:"required",message:"El Nombre es obligatorio"}]},{dataField:"estadoId",caption:"Estado",lookup:{dataSource:a,valueExpr:"id",displayExpr:"display"},validationRules:[{type:"required",message:"El estado es obligatorio"}]},{dataField:"tipoId",caption:"Tipo",lookup:{dataSource:s,valueExpr:"id",displayExpr:"display"},validationRules:[{type:"required",message:"El tipo es obligatorio"}]},{dataField:"latitud",caption:"Latitud",customizeText:({value:i})=>i===null||i===0?"":E(i,"lat")},{dataField:"longitud",caption:"Longitud",customizeText:({value:i})=>i===null||i===0?"":E(i,"lon")}],v={colCount:8,items:[{dataField:"id",colSpan:2,editorOptions:{disabled:!0}},{dataField:"subproyecto",colSpan:3,editorOptions:{disabled:!0}},{dataField:"nombre",colSpan:3,editorOptions:{maxLength:10,focusStateEnabled:!0}},{dataField:"estadoId",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:a,displayExpr:"display",valueExpr:"id",searchEnabled:!0}},{dataField:"tipoId",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:s,displayExpr:"display",valueExpr:"id",searchEnabled:!0}},{dataField:"latitud",colSpan:4,caption:"Latitud",editorType:"dxTextBox",editorOptions:{mask:`00춿00'00,00"A`,maskRules:{A:/[SN]/},maskInvalidMessage:`Ingrese un c칩digo en formato v치lido: 00춿00'00,00"S`},validationRules:[{type:"custom",validationCallback:({value:i})=>{if(!i||i.replace(/[^0-9]/g,"")==="")return!0;const n=b(i);return f(n)!==null},message:`Formato inv치lido. Usar: 00춿00'00,00"S`}]},{dataField:"longitud",colSpan:4,caption:"Longitud",editorType:"dxTextBox",editorOptions:{mask:`00춿00'00,00"A`,maskRules:{A:/[WE]/},maskInvalidMessage:`Ingrese un c칩digo en formato v치lido: 00춿00'00,00"W`},validationRules:[{type:"custom",validationCallback:({value:i})=>{if(!i||i.replace(/[^0-9]/g,"")==="")return!0;const n=b(i);return f(n)!==null},message:`Formato inv치lido. Usar: 00춿00'00,00"W`}]}]};return r.jsxs("div",{children:[r.jsx("div",{style:{marginBottom:"10px"},children:r.jsx("button",{onClick:m,style:{position:"absolute",top:"50px",right:"30px",background:"none",border:"none",fontSize:"18px",cursor:"pointer",padding:0},title:"Ver en mapa",children:"游깷"})}),r.jsx(w,{title:"",resource:"pozos",columns:S,editable:!0,form:v,size:"medium",externalFilter:["subproyectoId","=",o.id],onSaving:i=>$(i,o.id),onInitNewRow:i=>k(i,o),customActions:x,onEditorPreparing:j})]})}const N=(o,a,t)=>{o.data.proyectoId=t;const d=a.find(s=>s.id===t);d&&(o.data.proyecto=d.codigo)},q=(o,a)=>{o.changes.length>0&&o.changes.length>0&&o.changes.forEach(t=>{(t.type==="insert"||t.type==="update")&&(t.data.proyectoId||(t.data.proyectoId=a)),t.type==="remove"&&console.log("Eliminando elemento con key:",t.key)})},B=async()=>(await new I("proyectos").fetch({sort:[{selector:"codigo",desc:!1}]})).data,M=()=>{const{data:o=[],isLoading:a,error:t,...d}=h({queryKey:["proyectos"],queryFn:B});return{proyectos:o,isLoadingProyectos:a,errorProyecto:t,...d}};function to(){const{proyectos:o,isLoadingProyectos:a,errorProyectos:t}=M(),{autAplicacion:d,isLoadingAutAplicacion:s,errorAutAplicacion:c}=L(),[p,u]=F.useState(null),[x,m]=F.useState(!1),[S,v]=F.useState(null),i=[{icon:"verticalalignbottom",hint:"Ver pozos",name:"pozos",onClick:e=>{console.log("Boton pozos: ",e),v({id:e.row.data.id,codigo:e.row.data.codigo}),m(!0)}}],n={itemTemplate:e=>`<div title="${e.nombre}">${e.nombre}</div>`,onContentReady:e=>{const l=e.element.querySelector(".dx-texteditor-input");l&&(l.title=l.value)},searchEnabled:!0,displayExpr:"nombre",valueExpr:"id"},g=[{dataField:"id",width:90,caption:"ID",allowFiltering:!1,allowSearch:!1},{dataField:"proyecto",caption:"Proyecto"},{dataField:"codigo",caption:"C칩digo",validationRules:[{type:"required",message:"El c칩digo es obligatorio"},{type:"custom",message:"El c칩digo debe comenzar con los primeros 6 d칤gitos del proyecto seleccionado",validationCallback:e=>e.value.startsWith(e.data.proyecto)}]},{dataField:"nombreLocacion",caption:"Nombre"},{dataField:"ubicacion",caption:"Ubicacion"},{dataField:"proyectoId",caption:"Proyecto",visible:!1},{dataField:"autAplicacionAguaId",caption:"Regulaci칩n Agua",visible:!1,validationRules:[{type:"required",message:"La autoridad de aplicaci칩n es obligatoria"}]},{dataField:"autAplicacionSueloId",caption:"Regulaci칩n Suelo",visible:!1,validationRules:[{type:"required",message:"La autoridad de aplicaci칩n es obligatoria"}]},{dataField:"autAplicacionGasesId",caption:"Regulaci칩n Gases",visible:!1,validationRules:[{type:"required",message:"La autoridad de aplicaci칩n es obligatoria"}]},{dataField:"autAplicacionFLNAId",caption:"Regulaci칩n FLNA",visible:!1,validationRules:[{type:"required",message:"La autoridad de aplicaci칩n es obligatoria"}]},{dataField:"cantPozos",caption:"#Pozos"},{dataField:"apies",caption:"Apies",visible:!1},{dataField:"objetivo",caption:"Objetivo",visible:!1},{dataField:"notas",caption:"Notas",visible:!1}],y={colCount:8,items:[{dataField:"id",colSpan:2,editorOptions:{disabled:!0}},{dataField:"proyectoId",colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:o,displayExpr:"codigo",valueExpr:"id",value:p,disabled:!0}},{dataField:"codigo",colSpan:3,editorOptions:{maxLength:10,focusStateEnabled:!0}},{dataField:"nombreLocacion",colSpan:4,editorOptions:{maxLength:45}},{dataField:"ubicacion",colSpan:4,editorOptions:{maxLength:100}},{dataField:"autAplicacionAguaId",colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:d.filter(e=>e.matrizId===1),...n}},{dataField:"autAplicacionSueloId",colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:d.filter(e=>e.matrizId===3),...n}},{dataField:"autAplicacionGasesId",colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:d.filter(e=>e.matrizId===4),...n}},{dataField:"autAplicacionFLNAId",colSpan:2,editorType:"dxSelectBox",editorOptions:{dataSource:d.filter(e=>e.matrizId===2),...n}},{dataField:"objetivo",colSpan:5,editorOptions:{maxLength:45}},{dataField:"apies",colSpan:2,editorOptions:{maxLength:10}},{dataField:"notas",colSpan:6,editorOptions:{maxLength:60}}]};return a||s?r.jsx("div",{children:"Cargando datos..."}):t||c?r.jsx("div",{children:"Error al cargar datos"}):r.jsxs("div",{children:[r.jsx("div",{style:{marginBottom:"20px"},children:r.jsx(R,{dataSource:o,displayExpr:e=>e?`${e.codigo} - ${e.cliente}`:"",valueExpr:"id",label:"Seleccione un proyecto",labelMode:"outside",searchEnabled:!0,onValueChanged:e=>u(e.value)})}),p&&r.jsx(w,{title:"Sub Proyectos",resource:"subproyectos",columns:g,keyExpr:"id",editable:!0,form:y,size:"large",externalFilter:["proyectoId","=",p],onSaving:(e,l)=>q(e,l),onInitNewRow:e=>N(e,o,p),customActions:i}),r.jsx(T,{visible:x,onHiding:()=>m(!1),title:"Pozos",width:"75%",height:600,showTitle:!0,dragEnabled:!0,hideOnOutsideClick:!1,children:r.jsxs("div",{children:[r.jsx(C,{subproyecto:S}),r.jsx("div",{style:{textAlign:"right",marginTop:"20px"},children:r.jsx(z,{text:"Salir",type:"default",onClick:()=>m(!1)})})]})})]})}export{to as default};
