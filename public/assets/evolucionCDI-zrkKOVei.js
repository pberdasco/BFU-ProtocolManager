import{r as o,C as G,bG as P,b2 as p,j as t,ai as R,F as L,S as j,B}from"./index-C37p9Lq4.js";import{S as M}from"./select-box-rvVdTmQh.js";import{B as N,I as x}from"./box-BGZIs1_I.js";import{T as _}from"./toast-BTJFKrW3.js";import{G as S}from"./GenericGrid-DkTc9tEX.js";import{u as z}from"./compuestos-wNu3-3Fd.js";import"./tag-box-COb70gS8.js";import{u as A}from"./pozosDeSubproyecto-B9_kysJQ.js";import{A as w,a as F}from"./apiResource-5P-thon0.js";import{u as U}from"./subproyectos-CuBD9c8_.js";import{u as D}from"./useQuery-DBqjJV59.js";import"./data-grid-CEAYuK_4.js";import"./m_export-DeFelJNZ.js";import"./localization-V_Bd1Ycn.js";import"./excelExport-CiUyvjK6.js";import"./exceljs.min-uy0cDVws.js";import"./export_merged_ranges_manager-Bs1fMwcN.js";import"./m_utils.scroll-HIGYRNAS.js";/*!
 * devextreme-react
 * Version: 24.2.3
 * Build date: Fri Dec 06 2024
 *
 * Copyright (c) 2012 - 2024 Developer Express Inc. ALL RIGHTS RESERVED
 *
 * This software may be modified and distributed under the terms
 * of the MIT license. See the LICENSE file in the root of the project for details.
 *
 * https://github.com/DevExpress/devextreme-react
 */const E=o.memo(o.forwardRef((e,n)=>{const a=o.useRef(null);o.useImperativeHandle(n,()=>({instance(){var d;return(d=a.current)==null?void 0:d.getInstance()}}),[a.current]);const c=o.useMemo(()=>["opened","value"],[]),l=o.useMemo(()=>["onChange","onClosed","onContentReady","onCopy","onCut","onDisposing","onEnterKey","onFocusIn","onFocusOut","onInitialized","onInput","onKeyDown","onKeyUp","onOpened","onPaste","onValueChanged"],[]),r=o.useMemo(()=>({defaultOpened:"opened",defaultValue:"value"}),[]),i=o.useMemo(()=>({button:{optionName:"buttons",isCollectionItem:!0},calendarOptions:{optionName:"calendarOptions",isCollectionItem:!1},displayFormat:{optionName:"displayFormat",isCollectionItem:!1},dropDownOptions:{optionName:"dropDownOptions",isCollectionItem:!1}}),[]),s=o.useMemo(()=>[{tmplOption:"dropDownButtonTemplate",render:"dropDownButtonRender",component:"dropDownButtonComponent"}],[]);return o.createElement(G,{WidgetClass:P,ref:a,useRequestAnimationFrameFlag:!0,subscribableOptions:c,independentEvents:l,defaults:r,expectedChildren:i,templateProps:s,...e})})),V=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"animation",ExpectedChildren:{hide:{optionName:"hide",isCollectionItem:!1},show:{optionName:"show",isCollectionItem:!1}}}});Object.assign(V,{componentType:"option"});const k=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"at"}});Object.assign(k,{componentType:"option"});const q=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"boundaryOffset"}});Object.assign(q,{componentType:"option"});const $=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"buttons",IsCollectionItem:!0,ExpectedChildren:{options:{optionName:"options",isCollectionItem:!1}}}});Object.assign($,{componentType:"option"});const K=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"calendarOptions",DefaultsProps:{defaultValue:"value",defaultZoomLevel:"zoomLevel"},TemplateProps:[{tmplOption:"cellTemplate",render:"cellRender",component:"cellComponent"}]}});Object.assign(K,{componentType:"option"});const H=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"collision"}});Object.assign(H,{componentType:"option"});const J=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"displayFormat"}});Object.assign(J,{componentType:"option"});const W=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"dropDownOptions",DefaultsProps:{defaultHeight:"height",defaultPosition:"position",defaultVisible:"visible",defaultWidth:"width"},ExpectedChildren:{animation:{optionName:"animation",isCollectionItem:!1},position:{optionName:"position",isCollectionItem:!1},toolbarItem:{optionName:"toolbarItems",isCollectionItem:!0}},TemplateProps:[{tmplOption:"contentTemplate",render:"contentRender",component:"contentComponent"},{tmplOption:"titleTemplate",render:"titleRender",component:"titleComponent"}]}});Object.assign(W,{componentType:"option"});const Z=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"from",ExpectedChildren:{position:{optionName:"position",isCollectionItem:!1}}}});Object.assign(Z,{componentType:"option"});const Q=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"hide",ExpectedChildren:{from:{optionName:"from",isCollectionItem:!1},to:{optionName:"to",isCollectionItem:!1}}}});Object.assign(Q,{componentType:"option"});const X=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"my"}});Object.assign(X,{componentType:"option"});const Y=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"offset"}});Object.assign(Y,{componentType:"option"});const ee=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"options",TemplateProps:[{tmplOption:"template",render:"render",component:"component"}]}});Object.assign(ee,{componentType:"option"});const oe=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"position"}});Object.assign(oe,{componentType:"option"});const te=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"show"}});Object.assign(te,{componentType:"option"});const ne=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"to"}});Object.assign(ne,{componentType:"option"});const ae=e=>o.createElement(p,{...e,elementDescriptor:{OptionName:"toolbarItems",IsCollectionItem:!0,TemplateProps:[{tmplOption:"menuItemTemplate",render:"menuItemRender",component:"menuItemComponent"},{tmplOption:"template",render:"render",component:"component"}]}});Object.assign(ae,{componentType:"option"});const re=[{id:1,nombre:"Nivel Freático / FLNA"},{id:2,nombre:"Nivel Freático / CDIs"},{id:3,nombre:"Otros CDIs"}],ie=e=>{e.data.eje1=[],e.data.eje2=[]};function se(){const{compuestos:e}=z(),n=o.useMemo(()=>[{id:-1,codigo:"00000001",nombre:"Nivel Freático"},{id:-2,codigo:"00000001",nombre:"FLNA"},...e||[]],[e]);function a(r){const i=[-1,-2],s=r.value||[];return!(i.some(f=>s.includes(f))&&s.length>1)}const c=[{dataField:"id",caption:"ID",allowFiltering:!1,allowSearch:!1,visible:!1},{dataField:"nombre",caption:"Nombre",width:150,fixed:!0,validationRules:[{type:"required",message:"El Nombre del Gráfico es obligatorio"}]},{dataField:"eje1",caption:"Eje 1",width:250,cellRender:r=>r.value.map(i=>{var s;return(s=n.find(d=>d.id===i))==null?void 0:s.nombre}).join(", "),validationRules:[{type:"required",message:"Debe haber al menos un compuesto en el eje 1"}]},{dataField:"eje2",caption:"Eje 2",cellRender:r=>r.value.map(i=>{var s;return(s=n.find(d=>d.id===i))==null?void 0:s.nombre}).join(", ")},{dataField:"seccion",caption:"Seccion del Anexo",visible:!1,validationRules:[{type:"required",message:"La seccion es obligatoria"}]},{dataField:"anexoNombre",caption:"Nombre del/os componente/s en el Anexo",visible:!1,validationRules:[{type:"required",message:"El nombre es obligatorio"}]}],l={colCount:12,items:[{dataField:"id",colSpan:2,editorOptions:{disabled:!0}},{dataField:"nombre",colSpan:10,editorOptions:{maxLength:20,focusStateEnabled:!0}},{dataField:"eje1",editorType:"dxTagBox",colSpan:12,editorOptions:{items:n||[],valueExpr:"id",displayExpr:"nombre",placeholder:"Eje 1",showSelectionControls:!0,applyValueMode:"useButtons"},validationRules:[{type:"custom",reevaluate:!0,message:"Nivel Freático y FLNA no pueden compartir eje con otros compuestos.",validationCallback:a}]},{dataField:"eje2",editorType:"dxTagBox",colSpan:12,editorOptions:{items:n||[],valueExpr:"id",displayExpr:"nombre",placeholder:"Eje 2",showSelectionControls:!0,applyValueMode:"useButtons"},validationRules:[{type:"custom",reevaluate:!0,message:"Nivel Freático y FLNA no pueden compartir eje con otros compuestos.",validationCallback:a}]},{dataField:"seccion",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:re,displayExpr:"nombre",valueExpr:"id"}},{dataField:"anexoNombre",colSpan:8,editorOptions:{maxLength:20}}]};return t.jsx("div",{children:t.jsx(S,{title:"Gráficos",editTitle:"Gráficos",resource:"graficos",columns:c,editable:!0,form:l,size:"medium",onInitNewRow:r=>ie(r)})})}const le=(e,n)=>{e.data.subproyectoId=n,e.data.nombre="",e.data.eje1=[],e.data.eje2=[]},ce=(e,n)=>{e.changes.length>0&&e.changes.forEach(a=>{(a.type==="insert"||a.type==="update")&&(a.data.subproyectoId||(a.data.subproyectoId=n))})};function pe({subproyectoId:e,paramGraficos:n}){const{pozos:a}=A(e),c=[{dataField:"id",caption:"ID",allowFiltering:!1,allowSearch:!1,visible:!1},{dataField:"nombre",caption:"Nombre",width:200,validationRules:[{type:"required",message:"El Nombre del Gráfico es obligatorio"}]},{dataField:"pozos",caption:"Pozos",cellRender:r=>r.value.map(i=>{var s;return(s=a.find(d=>d.id===i))==null?void 0:s.nombre}).join(", ")},{dataField:"graficos",caption:"Gráficos",cellRender:r=>r.value.map(i=>{var s;return(s=n.find(d=>d.id===i))==null?void 0:s.nombre}).join(", ")}],l={colCount:12,items:[{dataField:"id",colSpan:2,editorOptions:{disabled:!0}},{dataField:"nombre",colSpan:10,editorOptions:{maxLength:20,focusStateEnabled:!0}},{dataField:"pozos",editorType:"dxTagBox",colSpan:12,editorOptions:{items:a||[],valueExpr:"id",displayExpr:"nombre",placeholder:"Pozos",showSelectionControls:!0,applyValueMode:"useButtons"}},{dataField:"graficos",editorType:"dxTagBox",colSpan:12,editorOptions:{items:n||[],valueExpr:"id",displayExpr:"nombre",placeholder:"Gráficos",showSelectionControls:!0,applyValueMode:"useButtons"}}]};return t.jsx("div",{children:t.jsx(S,{title:"Grupos",editTitle:"Grupos",resource:"graficosGrupos",columns:c,editable:!0,form:l,size:"medium",externalFilter:["subproyectoId","=",e],onSaving:r=>ce(r,e),onInitNewRow:r=>le(r,e)})})}async function de(e,n,a,c,l,r,i){if(!e){i({visible:!0,message:"Debes seleccionar un subproyecto.",type:"error"});return}const s=n.find(u=>u.id===e),d=(s==null?void 0:s.codigo)||"",f={subproyectoId:e,proyectoNombre:d,gruposConfig:c,graficosConfig:a,minFechaUsuario:l,maxFechaUsuario:r};try{const u=await fetch(`${w}evolucionCDI/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)}),b=await u.json();if(!u.ok){const O=b.message||"Error en la solicitud";i({visible:!0,message:O,type:"error"});return}const{status:y,log:g,createdFiles:v}=b;if(y==="Fail"){console.error("Error al generar gráficos.",g),i({visible:!0,message:`Error al generar los gráficos: no se pudo crear ninguno. 
Consulta el log en "Inspect" para más información.`,type:"error"});return}if(y==="NoData"){console.error("No habia datos para generar graficos.",g),i({visible:!0,message:`No habia datos para generar los graficos solicitados. 
Consulta el log en "Inspect" para más información.`,type:"error"});return}me(v),y==="Ok"?i({visible:!0,message:"Archivo Zip (word + excel) generado",type:"success"}):(console.warn("Generación completada con advertencias:",g),i({visible:!0,message:`Generación completada con advertencias: algunos gráficos tienen datos faltantes. 
Consulta el log en "Inspect" para más información.`,type:"warning"}))}catch(u){i({visible:!0,message:u.message,type:"error"})}}async function me(e){const n=await fetch(`${w}getzip`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({archivos:e})});if(!n.ok)throw new Error(`Error al descargar el zip: ${n.statusText}`);const a=await n.blob(),c=window.URL.createObjectURL(a),l=document.createElement("a");l.href=c,l.download=e[0].zipName+".zip",document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(c)}const ue=async()=>(await new F("graficos").fetch({sort:[{selector:"id",desc:!1}]})).data,fe=()=>{const{data:e=[],isLoading:n,error:a,refetch:c,...l}=D({queryKey:["graficos"],queryFn:()=>ue()});return{paramGraficos:e,isLoadingParamGraficos:n,errorParamGraficos:a,refetchParamGraficos:c,...l}},be=async e=>(await new F("graficosGrupos").fetch({filter:["subproyectoId","=",e],sort:[{selector:"id",desc:!1}]})).data,ye=e=>{const{data:n=[],isLoading:a,error:c,refetch:l,...r}=D({queryKey:["graficosGrupos",e],queryFn:()=>be(e),enabled:!!e});return{paramGruposDeSubproyecto:n,isLoadingParamGruposDeSubproyecto:a,errorParamGruposDeSubproyecto:c,refetchParamGruposDeSubproyecto:l,...r}};function Le(){const[e,n]=o.useState(null),[a,c]=o.useState(!1),[l,r]=o.useState(null),[i,s]=o.useState(null),{subproyectos:d,isLoadingSubproyectos:f,errorSubproyecto:u}=U(),{paramGraficos:b,islLoadingParamGraficos:y,errorParamGraficos:g}=fe(),{paramGruposDeSubproyecto:v,isLoadingParamGruposDeSubproyecto:O,errorParamGruposDeSubproyecto:I}=ye(e),[h,C]=o.useState({visible:!1,message:"",type:"info"});if(f||y||O)return t.jsx("div",{children:"Cargando datos..."});if(u||g||I)return t.jsx("div",{children:"Error al cargar datos iniciales"});async function T(){c(!0);try{await de(e,d,b,v,l,i,C)}finally{c(!1)}}return t.jsxs(t.Fragment,{children:[t.jsx(R,{visible:a,shading:!0,shadingColor:"rgba(0,0,0,0.4)",showIndicator:!0,showPane:!1,hideOnOutsideClick:!1,hideOnParentScroll:!1,container:document.body,position:{of:"#root"}}),t.jsxs(L,{colCount:4,labelLocation:"top",children:[t.jsx(j,{dataField:"subproyectoId",label:{text:"Seleccione un Subproyecto"},colSpan:2,children:t.jsx(M,{dataSource:d,displayExpr:m=>m?`${m.codigo}: ${m.nombreLocacion}`:"",valueExpr:"id",value:e,searchEnabled:!0,onValueChanged:m=>n(m.value)})}),t.jsx(j,{dataField:"minFechaUsuario",label:{text:"Gráficos desde"},colSpan:1,children:t.jsx(E,{value:l,onValueChanged:m=>r(m.value),type:"date",displayFormat:"yyyy-MM-dd"})}),t.jsx(j,{dataField:"maxFechaUsuario",label:{text:"Gráficos hasta"},colSpan:1,children:t.jsx(E,{value:i,onValueChanged:m=>s(m.value),type:"date",displayFormat:"yyyy-MM-dd"})})]}),t.jsxs(N,{direction:"row",align:"end",children:[t.jsx(x,{ratio:1,children:t.jsx("div",{className:"tableBox",children:t.jsx(se,{})})}),t.jsx(x,{ratio:1,children:t.jsx("div",{className:"tableBox",children:t.jsx(pe,{subproyectoId:e,paramGraficos:b})})})]}),t.jsx("div",{className:"gapSpace"}),t.jsxs(N,{direction:"row",align:"end",className:"buttons-box",children:[t.jsx(x,{ratio:10}),t.jsx(x,{ratio:2,children:t.jsx(B,{text:"Generar Excel",type:"default",width:"100%",disabled:!e,hint:e?"":"Seleccione un subproyecto primero",onClick:T})})]}),t.jsx(_,{visible:h.visible,message:h.message,type:h.type,displayTime:4e3,onHiding:()=>C({...h,visible:!1})})]})}export{Le as default};
