import{j as i,r as c,F as U,S as T,_ as k,$ as V,a0 as D,B as $}from"./index-CUZSR6jm.js";import{G as O}from"./GenericGrid-a7weaJcj.js";import{u as H}from"./pozosDeSubproyecto-M1X6cCfi.js";import{M as w,g as K,a as _}from"./muestrasConfig-CwDeG0hD.js";import{u as M}from"./useQuery-B74RDuhm.js";import{a as z,A as j}from"./apiResource-X6nNJMGp.js";import{u as J}from"./laboratorios-scnKg5Rg.js";import{u as Q}from"./matrices-B6U0l-vT.js";import{u as Z}from"./eventos-CzRf3KlA.js";import{u as W}from"./subproyectos-GanWGkiP.js";import"./select-box-Duxp4ywA.js";import{P as A}from"./popup-puaL1xln.js";import{f as X}from"./localization-wC_hBY2P.js";import"./data-grid-CGD_RL6S.js";import"./m_export-CLlCNyBP.js";import"./excelExport-B0wlWVfN.js";import"./exceljs.min-Bu-WEMN3.js";import"./export_merged_ranges_manager-D8l_JMl9.js";const Y=(e,o)=>{e.data.cadenaCustodiaId=o.id,o.matrizCodigo===w.SUELO?e.data.tipo=2:e.data.tipo=1,e.data.pozoId=null,e.data.nivelFreatico=0,e.data.profundidad=null,e.data.flna=null},ee=(e,o)=>{e.changes.length>0&&e.changes.length>0&&e.changes.forEach(r=>{(r.type==="insert"||r.type==="update")&&(r.data.cadenaCustodiaId||(r.data.cadenaCustodiaId=o.id))})};function oe({cadena:e}){if(!e)return i.jsx("div",{children:"No se ha seleccionado una Cadena de Custodia"});const{pozos:o}=H(e.subproyectoId),r=e.matrizCodigo===w.AGUA||e.matrizCodigo===w.FLNA,s=e.matrizCodigo===w.SUELO,l=c.useCallback(d=>{d.parentType==="dataRow"&&d.dataField==="pozoId"?d.editorOptions.disabled=d.row.data.tipo!==1:d.parentType==="dataRow"&&(d.dataField==="nivelFreatico"||d.dataField==="nivelFLNA")?d.editorOptions.disabled=!r:d.parentType==="dataRow"&&d.dataField==="profundidad"&&(d.editorOptions.disabled=!s)},[r,s]),m=c.useMemo(()=>K(o,e.matrizCodigo,r,s),[e,o]),x=c.useMemo(()=>_(o),[o]);return i.jsx("div",{children:i.jsx(O,{title:"",editTitle:"Muestras",resource:"muestras",columns:m,editable:!0,form:x,size:"medium",externalFilter:["cadenaCustodiaId","=",e.id],onSaving:d=>ee(d,e),onInitNewRow:d=>Y(d,e),onEditorPreparing:l})})}const p=[{value:1,text:"Grupo"},{value:2,text:"Compuesto"}],te=async({queryKey:e})=>{const[,o]=e;return(await new z("grupoCompuestos").fetch({filter:["matrizCodigo","=",o]})).data},ae=async({queryKey:e})=>{const[,o]=e;return(await new z("compuestos").fetch({filter:["matrizCodigo","=",o]})).data},ie=async()=>(await new z("Metodos").fetch()).data,re=(e,o)=>{e.data.cadenaCustodiaId=o.id},se=(e,o)=>{e.changes.length>0&&e.changes.length>0&&e.changes.forEach(r=>{(r.type==="insert"||r.type==="update")&&(r.data.cadenaCustodiaId||(r.data.cadenaCustodiaId=o.id))})};function de({cadena:e}){if(!e)return i.jsx("div",{children:"No se ha seleccionado una Cadena de Custodia"});const{data:o,isLoading:r,error:s}=M({queryKey:["grupos",e.matrizCodigo],queryFn:te}),{data:l,isLoading:m,error:x}=M({queryKey:["compuestos",e.matrizCodigo],queryFn:ae}),{data:d,isLoading:f,error:L}=M({queryKey:["metodos"],queryFn:ie}),S=c.useCallback(t=>{t.parentType==="dataRow"&&t.dataField==="grupoId"&&(t.editorOptions.disabled=t.row.data.tipo!==p[0].value),t.parentType==="dataRow"&&t.dataField==="compuestoId"&&(t.editorOptions.disabled=t.row.data.tipo!==p[1].value),t.parentType==="dataRow"&&t.dataField==="metodoId"&&(t.editorOptions.disabled=t.row.data.tipo===p[0].value)},[]),C=[{dataField:"id",width:90,caption:"ID",allowFiltering:!1,allowSearch:!1},{dataField:"tipo",caption:"Tipo",lookup:{dataSource:p,valueExpr:"value",displayExpr:"text"},setCellValue:(t,n,v)=>{t.tipo=n,n!==p[0].value&&(t.grupoId=null),n!==p[1].value&&(t.compuestoId=null)},validationRules:[{type:"required",message:"El estado es obligatorio"}]},{dataField:"grupoId",caption:"Grupo",lookup:{dataSource:o,valueExpr:"id",displayExpr:"nombre"},setCellValue:(t,n,v)=>{t.grupoId=n;const h=o.find(E=>E.id===n);t.metodoId=h?h.metodoId:null},validationRules:[{type:"custom",message:"El Grupo es obligatorio si el tipo es Grupo",validationCallback:t=>t.data.tipo!==p[1].value||t.value!==null}]},{dataField:"compuestoId",caption:"Compuesto",lookup:{dataSource:l,valueExpr:"id",displayExpr:"nombre"},validationRules:[{type:"custom",message:"El Compuesto es obligatorio si el tipo es Compuesto",validationCallback:t=>t.data.tipo!==p[1].value||t.value!==null}]},{dataField:"metodoId",caption:"Metodo",lookup:{dataSource:d,valueExpr:"id",displayExpr:"nombre"},validationRules:[{type:"required",message:"La Metodo es obligatorio"}]}],g={colCount:8,items:[{dataField:"id",colSpan:1,editorOptions:{disabled:!0}},{dataField:"tipo",colSpan:3,editorType:"dxSelectBox",editorOptions:{dataSource:p,displayExpr:"text",valueExpr:"value",searchEnabled:!0}},{dataField:"grupoId",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:o,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0}},{dataField:"compuestoId",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:l,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0}},{dataField:"metodoId",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:d,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0}}]};return i.jsx("div",{children:i.jsx(O,{title:"",editTitle:"Analisis Requeridos",resource:"analisisrequeridos",columns:C,editable:!0,form:g,size:"mediumShort",externalFilter:["cadenaCustodiaId","=",e.id],onSaving:t=>se(t,e),onInitNewRow:t=>re(t,e),onEditorPreparing:S})})}const ne=(e,o,r)=>{e.data.eventoMuestreoId=o,e.data.subproyectoId=r},le=(e,o,r)=>{e.changes.length>0&&e.changes.length>0&&e.changes.forEach(s=>{(s.type==="insert"||s.type==="update")&&(s.data.eventoMuestreoId||(s.data.eventoMuestreoId=o,s.data.subproyectoId=r)),s.type==="remove"&&console.log("Eliminando elemento con key:",s.key)})};async function ue(e){try{const o=await fetch(`${j}eventomuestreo/fulldata/${e}`);if(!o.ok)throw new Error(`Error al obtener los datos del evento: ${o.statusText}`);const r=await o.json();if(!r||!r.cadenas)throw new Error("La respuesta de la API no tiene el formato esperado.");const s=await fetch(`${j}cadenatoexcel/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cadenas:r.cadenas})});if(!s.ok)throw new Error(`Error al generar el Excel: ${s.statusText}`);const l=await s.json();if(!l.file)throw new Error("No se recibió un nombre de archivo válido");const m=await fetch(`${j}cadenatoexcel/${l.file}`);if(!m.ok)throw new Error(`Error al descargar el archivo: ${m.statusText}`);const x=await m.blob(),d=window.URL.createObjectURL(x),f=document.createElement("a");return f.href=d,f.download=l.file,document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(d),l}catch(o){console.error("Error en generarFormExcel:",o)}}function Oe(){const{laboratorios:e,isLoadingLaboratorios:o,errorLaboratorios:r}=J(),{matrices:s,isLoadingMatrices:l,errorMatrices:m}=Q(),{eventos:x,isLoadingEventos:d,errorEventos:f}=Z(),{subproyectos:L,isLoadingSubproyectos:S,errorSubproyectos:C}=W(),[g,t]=c.useState(null),[n,v]=c.useState(null),[h,E]=c.useState([]),[N,I]=c.useState(!1),[B,F]=c.useState(!1),[u,R]=c.useState(null),q=[{icon:"verticalalignbottom",hint:"Ver Muestras",name:"muestras",onClick:a=>{const b=s.find(y=>y.codigo===a.row.data.matrizCodigo);R({id:a.row.data.id,nombre:a.row.data.nombre,subproyectoId:a.row.data.subproyectoId,matrizCodigo:a.row.data.matrizCodigo,matrizNombre:b.nombre}),I(!0)}},{icon:"color",hint:"Ver Analisis",name:"analisis",onClick:a=>{const b=s.find(y=>y.codigo===a.row.data.matrizCodigo);R({id:a.row.data.id,nombre:a.row.data.nombre,subproyectoId:a.row.data.subproyectoId,matrizCodigo:a.row.data.matrizCodigo,matrizNombre:b.nombre}),F(!0)}}],G=[{dataField:"id",width:90,caption:"ID"},{dataField:"eventoMuestreoId",visible:!1},{dataField:"subproyectoId",visible:!1},{dataField:"fecha",caption:"Fecha",dataType:"date",format:"dd/MM/yyyy",validationRules:[{type:"required",message:"La fecha es obligatoria"}]},{dataField:"nombre",caption:"Nombre",validationRules:[{type:"required",message:"El nombre es obligatorio"}]},{dataField:"laboratorioId",caption:"Laboratorio",lookup:{dataSource:e,valueExpr:"id",displayExpr:"nombre"}},{dataField:"matrizCodigo",caption:"Matriz",lookup:{dataSource:s,valueExpr:"codigo",displayExpr:"nombre"}},{dataField:"cantidadMuestras",caption:"#Muestras",allowSorting:!1,allowHeaderFiltering:!1},{dataField:"cantidadAnalisis",caption:"#Analisis",allowSorting:!1,allowHeaderFiltering:!1}],P={colCount:8,items:[{dataField:"id",colSpan:2,editorOptions:{disabled:!0}},{dataField:"fecha",colSpan:2},{dataField:"nombre",colSpan:4,editorOptions:{maxLength:45}},{dataField:"laboratorioId",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:e,displayExpr:"nombre",valueExpr:"id",searchEnabled:!0}},{dataField:"matrizCodigo",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:s,displayExpr:"nombre",valueExpr:"codigo",searchEnabled:!0}}]};return S||d||o||l?i.jsx("div",{children:"Cargando datos..."}):C||f||r||m?i.jsx("div",{children:"Error al cargar datos"}):i.jsxs("div",{children:[i.jsx("div",{style:{marginBottom:"20px"},children:i.jsxs(U,{colCount:12,labelLocation:"top",children:[i.jsx(T,{dataField:"subproyecto",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:L,displayExpr:a=>a?`${a.codigo} - ${a.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0,showClearButton:!0,onValueChanged:a=>{if(t(a.value),v(null),a.value){const b=x.filter(y=>y.subproyectoId===a.value);E(b)}else E([])}},children:i.jsx(k,{text:"Seleccione un Subproyecto"})}),i.jsx(T,{dataField:"evento",colSpan:4,editorType:"dxSelectBox",editorOptions:{dataSource:h,displayExpr:a=>a?`${X(new Date(a.fecha),"dd/MM/yyyy")} - ${a.nombre}`:"",valueExpr:"id",value:n,searchEnabled:!0,showClearButton:!0,onValueChanged:a=>v(a.value)},children:i.jsx(k,{text:"Seleccione un Evento de Muestreo"})}),i.jsx(V,{colSpan:2}),i.jsx(D,{colSpan:2,buttonOptions:{text:"Generar Form",type:"default",onClick:()=>ue(n)}})]})}),n&&i.jsx(O,{title:"Cadenas de Custodia",resource:"cadenascustodia",columns:G,keyExpr:"id",editable:!0,form:P,size:"medium",externalFilter:["eventoMuestreoId","=",n],onSaving:(a,b)=>le(a,b,g),onInitNewRow:a=>ne(a,n,g),customActions:q},`${g}-${n}`),i.jsx(A,{visible:N,onHiding:()=>I(!1),title:`Muestras cadena: ${u==null?void 0:u.nombre}`,width:"75%",height:600,showTitle:!0,dragEnabled:!0,hideOnOutsideClick:!1,children:i.jsxs("div",{children:[i.jsx(oe,{cadena:u}),i.jsx("div",{style:{textAlign:"right",marginTop:"20px"},children:i.jsx($,{text:"Salir",type:"default",onClick:()=>I(!1)})})]})}),i.jsx(A,{visible:B,onHiding:()=>F(!1),title:`Analisis Requeridos para la cadena: ${u==null?void 0:u.nombre} (${u==null?void 0:u.matrizNombre})`,width:"75%",height:600,showTitle:!0,dragEnabled:!0,hideOnOutsideClick:!1,children:i.jsxs("div",{children:[i.jsx(de,{cadena:u}),i.jsx("div",{style:{textAlign:"right",marginTop:"20px"},children:i.jsx($,{text:"Salir",type:"default",onClick:()=>F(!1)})})]})})]})}export{Oe as default};
