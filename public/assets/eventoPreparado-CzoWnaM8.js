import{j as c,S as L,_ as q,$ as Y,af as ue,r as G,F as me,a0 as _}from"./index-CUZSR6jm.js";import{T as fe}from"./toast-CZNTznit.js";import"./tag-box-DCYl5-uU.js";import{f as pe}from"./localization-wC_hBY2P.js";import{D as ge,b as be,a as Ce,I as xe,E as ve,C as $}from"./data-grid-CGD_RL6S.js";import{e as he}from"./excelExport-B0wlWVfN.js";import{f as ee}from"./specialValues-CHSjwz8L.js";import{u as ye}from"./subproyectos-GanWGkiP.js";import{u as Ee}from"./eventos-CzRf3KlA.js";import{u as we}from"./matrices-B6U0l-vT.js";import{u as Se}from"./compuestos-BXMislYw.js";import{u as Fe}from"./metodos-CA8LqQEI.js";import{u as Ie}from"./um-DSAQmlt4.js";import{u as V}from"./useQuery-B74RDuhm.js";import{a as Oe,A as te}from"./apiResource-X6nNJMGp.js";import{u as je}from"./laboratorios-scnKg5Rg.js";import{b as ze,c as Ae}from"./cadenaCompletaDataAccess-BFEdg8Rt.js";import{E as Me}from"./exceljs.min-Bu-WEMN3.js";import{F as Re}from"./export_merged_ranges_manager-D8l_JMl9.js";import"./m_utils.scroll-D49eWnGj.js";import"./m_export-CLlCNyBP.js";const Ge=[{nombre:"Original",id:1},{nombre:"Reducido",id:2},{nombre:"Muy Reducido",id:3}];function Ne({subproyectos:e,matrices:r,filteredEventos:l,setColor:n}){return c.jsxs(c.Fragment,{children:[c.jsx(L,{dataField:"subproyecto",editorType:"dxSelectBox",colSpan:3,editorOptions:{dataSource:e,displayExpr:a=>a?`${a.codigo} - ${a.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0},children:c.jsx(q,{text:"Seleccione un Subproyecto"})}),c.jsx(L,{dataField:"matriz",editorType:"dxSelectBox",colSpan:1,editorOptions:{dataSource:r,displayExpr:"nombre",valueExpr:"id",searchEnabled:!1},children:c.jsx(q,{text:"Matriz"})}),c.jsx(L,{dataField:"evento",editorType:"dxSelectBox",colSpan:3,editorOptions:{dataSource:l,displayExpr:a=>a?`${pe(new Date(a.fecha),"dd/MM/yyyy")} - ${a.nombre}`:"",valueExpr:"id",searchEnabled:!0},children:c.jsx(q,{text:"Seleccione un Evento de Muestreo"})}),c.jsx(Y,{colSpan:1}),c.jsx(L,{dataField:"mostrar",editorType:"dxSelectBox",colSpan:2,editorOptions:{dataSource:Ge,displayExpr:"nombre",valueExpr:"id",searchEnabled:!1},children:c.jsx(q,{text:"Mostrar"})}),c.jsx(L,{dataField:"colorear",editorType:"dxCheckBox",colSpan:1,label:{text:"Regulaciones",showColon:!0},editorOptions:{text:"Colorear",onValueChanged:a=>n(a.value)}}),c.jsx(Y,{colSpan:1})]})}function Ue({filas:e,muestras:r,compuestos:l,metodos:n,UM:a,colorActive:p,onRowPrepared:o}){function g(s){var u;if(p&&s.rowType==="data"){const b=(u=s.column)==null?void 0:u.dataField;if(!b||["compuestoId","metodoId","umId","nivelGuia","nivelGuiaUM"].includes(b))return;const t=s.value,d=parseFloat(s.data.nivelGuia);if(isNaN(d)||t===null||t===void 0||t===-3)return;d===-1?t>0?s.cellElement.style.backgroundColor="red":(t===-1||t===-2||t===0)&&(s.cellElement.style.backgroundColor="green"):d===-2?s.cellElement.style.backgroundColor="green":d===-3?t>0||t===-1?s.cellElement.style.backgroundColor="red":(t===-2||t===0)&&(s.cellElement.style.backgroundColor="green"):t>d?s.cellElement.style.backgroundColor="red":s.cellElement.style.backgroundColor="green"}}function m(s){he(s.component,"ReporteEventoPreparado.xlsx")}return c.jsx(ue,{colSpan:12,children:c.jsxs(ge,{dataSource:e,keyExpr:"id",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:450,scrolling:{mode:"virtual"},onCellPrepared:g,onRowPrepared:o,onExporting:m,children:[c.jsx(be,{enabled:!0,allowExportSelectedData:!0,fileName:"ReporteEventoPreparado"}),c.jsx(Ce,{children:c.jsx(xe,{name:"exportButton"})}),c.jsx(ve,{mode:"cell",allowUpdating:!0,allowDeleting:!0}),c.jsx($,{dataField:"compuestoId",caption:"Compuesto",allowEditing:!1,width:220,lookup:{dataSource:l,valueExpr:"id",displayExpr:"nombre"},fixed:!0,fixedPosition:"left"}),c.jsx($,{dataField:"metodoId",caption:"Método",allowEditing:!1,width:220,lookup:{dataSource:n,valueExpr:"id",displayExpr:"nombre"}}),c.jsx($,{dataField:"umId",caption:"UM",width:80,lookup:{dataSource:a,valueExpr:"id",displayExpr:"nombre"}}),c.jsx($,{dataField:"nivelGuia",caption:"NG",width:100,cellRender:({value:s})=>ke(s)}),r.map(s=>c.jsx($,{dataField:s.muestra,caption:s.muestra,cellRender:({value:u})=>ee(u,!1)},s.muestra))]})})}function ke(e){return e==null?"NL":Number(e)===-1?"<LC":Number(e)===-2?"SAT/SOL":Number(e)===-3?"<LD":Number(e)===-5?"ERR-Conv":Number(e)||e}const W=async e=>{const r=new Oe("regulados");if(e===null)return[];const l=e!==0?["autAplicacionId","=",e]:null;return(await r.fetch({filter:l})).data},De=({agua:e,suelo:r,gases:l,FLNA:n})=>{const a=V({queryKey:["regulados","agua",e],queryFn:()=>W(e),enabled:!!e}),p=V({queryKey:["regulados","suelo",r],queryFn:()=>W(r),enabled:!!r}),o=V({queryKey:["regulados","gases",l],queryFn:()=>W(l),enabled:!!l}),g=V({queryKey:["regulados","FLNA",n],queryFn:()=>W(n),enabled:!!n}),s=[...a.data||[],...p.data||[],...o.data||[],...g.data||[]].reduce((b,t)=>{const d=t.compuestoId,E=new Date(t.fechaVigencia);return(!b[d]||new Date(b[d].fechaVigencia)<E)&&(b[d]=t),b},{});return{regulados:Object.values(s),isLoadingRegulados:a.isLoading||p.isLoading||o.isLoading||g.isLoading,errorRegulados:a.error||p.error||o.error||g.error}};function Te(e){const r=["id","cadenaCustodiaId","compuestoId","estado","metodoId","umId","protocoloItemId","codigo","nivelGuia","nivelGuiaOriginalUM","nivelGuiaOriginal"];return Object.entries(e).some(([n,a])=>r.includes(n)?!1:typeof a=="number"&&a>0)}function Le(e,r,l){if(r===1)return!0;const n=l.find(a=>a.id===e.compuestoId);if(!n)return!0;if(r===2)return n.exponeId!=0;if(r===3)return n.exponeId==1||n.exponeId==2&&Te(e)}function oe(e,r,l){return{muestras:e.muestras,filas:e.filas.filter(n=>Le(n,r,l))}}async function $e(e,r,l){try{const[n,a]=await Promise.all([ze(e,r),Ae()]);if(n&&n.filas&&n.filas.length>0)return n.filas=Be(n.filas,l,a),n;throw new Error("Evento preparado no ha devuelto datos")}catch(n){throw n}}const re=(e,r)=>{const l=Math.pow(10,r);return Number((Math.round(e*l)/l).toFixed(r))};function Be(e,r,l){const n=Object.fromEntries(r.map(p=>[p.compuestoId,p])),a=new Map;return l.forEach(p=>{a.set(`${p.desdeUMId}-${p.hastaUMId}`,parseFloat(p.factor))}),e.map(p=>{const o=n[p.compuestoId];if(!o)return{...p,nivelGuia:null,nivelGuiaOriginal:null,nivelGuiaOriginalUM:null};const g=parseFloat(o.valorReferencia),m=o.umId,s=p.umId;if(g===-1||g===-2||g===-3)return{...p,nivelGuia:g,nivelGuiaOriginal:g,nivelGuiaOriginalUM:m};if(isNaN(g))return{...p,nivelGuia:null,nivelGuiaOriginal:null,nivelGuiaOriginalUM:m};let u=g;if(s!==m){const b=a.get(`${m}-${s}`);if(b)u=re(g*b,5);else{const t=a.get(`${s}-${m}`);t?u=re(g/t,5):u=-5}}return{...p,nivelGuia:u,nivelGuiaOriginal:g,nivelGuiaOriginalUM:m}})}const ae=3,H=4,Pe=1,le=2,ne=2,se=35,ie=15,D=12,N=11,K="FF00B050",Q="FFFF0000",R="FFFFFFFF",Z="FF808080",M="FFD9D9D9",z={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},X={AGUA:1,SUELO:3,GASES:4};function qe(e){let r="";for(;e>0;){const l=(e-1)%26;r=String.fromCharCode(65+l)+r,e=Math.floor((e-l)/26)}return r}function de(e,r,l){if(!l||isNaN(r)||e===null||e===void 0||e===-3)return R;if(r===-1)return e>0?Q:e===-1||e===-2||e===0?K:R;if(r===-2)return K;if(r===-1)return e>0||e===-1?Q:e===-2||e===0?K:R;if(typeof e=="number"){if(e>r)return Q;if(e<=r)return K}return R}function ce(e,r){var l;return((l=r.find(n=>n.id===e.compuestoId))==null?void 0:l.nombre)||`Compuesto ${e.compuestoId}`}function Ve(e,r){var l;return((l=r.find(n=>n.id===e.umId))==null?void 0:l.nombre)||`UM ${e.umId}`}async function We(e,r,l,n,a){const p=new Me.Workbook,o=p.addWorksheet("Muestras");if(r===X.AGUA||r===X.GASES){const s=1+e.filas.length;let u=0;for(const b of e.muestras){if(b.tipo!==1)continue;const t=u%ae*(H+Pe)+1,d=Math.floor(u/ae)*(s+le)+1;o.getColumn(t).width=10,o.getColumn(t+1).width=se,o.getColumn(t+2).width=ie,o.getColumn(t+3).width=10,o.mergeCells(d,t,d,t+H-1);const E=o.getCell(d,t);E.value=b.muestra||"",E.alignment={horizontal:"center",vertical:"middle"},E.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},E.font={name:"Arial",size:D,bold:!1,color:{argb:R}},E.border=z;const w=d+1;let h=w;for(const i of e.filas){const S=i[b.muestra],F=ee(i[b.muestra],!1)??"",k=ce(i,l),C=Ve(i,n),I=isNaN(i.nivelGuia)?NaN:parseFloat(i.nivelGuia);o.getCell(h,t).value="";const T=o.getCell(h,t+1);T.value=k,T.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},T.font={name:"Arial",size:D,bold:!1};const B=o.getCell(h,t+2);B.value=F,B.font={name:"Arial",size:N,bold:!1},B.alignment={horizontal:"center",vertical:"middle"},B.fill={type:"pattern",pattern:"solid",fgColor:{argb:de(S,I,a)}};const P=o.getCell(h,t+3);P.value=C,P.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},P.alignment={horizontal:"center",vertical:"middle"},P.font={name:"Arial",size:N,bold:!1};for(let J=t;J<t+H;J++)o.getCell(h,J).border=z;h++}const O=w,A=h-1,v=qe(t),x=`${v}${O}:${v}${A}`;o.mergeCells(x);const f=o.getCell(O,t);f.value="Compuesto",f.alignment={horizontal:"center",vertical:"middle",textRotation:90},f.font={name:"Arial",size:D,bold:!1},f.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}};for(let i=O;i<=A;i++)o.getCell(i,t).border=z;const y=t+3;let j=!0;const U=o.getCell(w,y).value;for(let i=w;i<h;i++)if(o.getCell(i,y).value!==U){j=!1;break}if(j){o.mergeCells(w,y,h-1,y);const i=o.getCell(w,y);i.alignment={horizontal:"center",vertical:"middle"},i.font={name:"Arial",size:N,bold:!1},i.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}else{let i=w,S=o.getCell(i,y).value;for(let F=w+1;F<h;F++){const k=o.getCell(F,y).value;if(k!==S){if(F-i>=ne){o.mergeCells(i,y,F-1,y);const C=o.getCell(i,y);C.alignment={horizontal:"center",vertical:"middle"},C.font={name:"Arial",size:N,bold:!1},C.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}i=F,S=k}}if(h-i>=ne){o.mergeCells(i,y,h-1,y);const F=o.getCell(i,y);F.alignment={horizontal:"center",vertical:"middle"},F.font={name:"Arial",size:N,bold:!1},F.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}}u++}}else if(r===X.SUELO){const m=e.muestras.filter(b=>b.tipo===1),s=[...new Set(m.map(b=>b.pozo))];let u=1;for(const b of s){const t=m.filter(v=>v.pozo===b);t.sort((v,x)=>v.profundidad-x.profundidad);const d=1;o.getColumn(d).width=se;for(let v=0;v<t.length;v++)o.getColumn(d+1+v).width=ie;const E=o.getCell(u,d);E.value="INTERVENCION",E.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},E.font={name:"Arial",size:D,bold:!0,color:{argb:R}},E.alignment={horizontal:"center",vertical:"middle"},E.border=z,t.forEach((v,x)=>{const f=o.getCell(u,d+1+x);f.value=v.muestra,f.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},f.font={name:"Arial",size:D,bold:!0,color:{argb:R}},f.alignment={horizontal:"center",vertical:"middle"},f.border=z});const w=u+1,h=o.getCell(w,d);h.value="COMPUESTOS",h.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},h.font={name:"Arial",size:D,bold:!1},h.alignment={horizontal:"center",vertical:"middle"},h.border=z,t.forEach((v,x)=>{const f=o.getCell(w,d+1+x);f.value=v.profundidad,f.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},f.font={name:"Arial",size:N,bold:!1},f.alignment={horizontal:"center",vertical:"middle"},f.border=z});const O=u+2;o.mergeCells(w,d,O,d),t.forEach((v,x)=>{const f=e.filas.find(S=>S[v.muestra]!==void 0);let y=f==null?void 0:f.umId,j=n.find(S=>S.id===y),U=(j==null?void 0:j.nombre)||"UM";const i=o.getCell(O,d+1+x);i.value=U,i.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},i.font={name:"Arial",size:N,bold:!1},i.alignment={horizontal:"center",vertical:"middle"},i.border=z});let A=u+3;for(const v of e.filas){const x=ce(v,l),f=o.getCell(A,d);f.value=x,f.fill={type:"pattern",pattern:"solid",fgColor:{argb:R}},f.font={name:"Arial",size:D,bold:!1},f.alignment={vertical:"middle"},f.border=z,t.forEach((y,j)=>{const U=ee(v[y.muestra],!1)??"",i=isNaN(v.nivelGuia)?NaN:parseFloat(v.nivelGuia),S=o.getCell(A,d+1+j);S.value=U,S.font={name:"Arial",size:N,bold:!1},S.alignment={horizontal:"center",vertical:"middle"},S.border=z,S.fill={type:"pattern",pattern:"solid",fgColor:{argb:de(valorMuestraNumerico,i,a)}}}),A++}u=A+le}}const g=await p.xlsx.writeBuffer();Re.saveAs(new Blob([g]),"muestrasCDI.xlsx")}async function Ke(e,r,l,n,a,p,o){const g={proyecto:r.codigo,fecha:l.fecha,data:n};g.data.compuestos=p,g.data.nivelesGuia=a,g.data.laboratorios=o;try{const m=await fetch(`${te}cadenatodoctabla`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)});if(!m.ok){const w=(await m.json()).message||`Error al obtener los datos del evento: ${m.statusText}`;throw new Error(w)}const s=await m.json();if(!s.file)throw new Error("No se recibió un nombre de archivo válido");const u=await fetch(`${te}cadenatodoctabla/${s.file}`);if(!u.ok)throw new Error(`Error al descargar el archivo: ${u.statusText}`);const b=await u.blob(),t=window.URL.createObjectURL(b),d=document.createElement("a");d.href=t,d.download=s.file,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(t),e({visible:!0,message:"Exportación exitosa",type:"success"})}catch(m){e({visible:!0,message:(m==null?void 0:m.message)||"Error al exportar tablas",type:"error"})}}function pt(){var k;const[e,r]=G.useState([]),[l,n]=G.useState(!1),[a,p]=G.useState({subproyecto:null,matriz:null,evento:null,mostrar:1}),[o,g]=G.useState([]),[m,s]=G.useState([]),[u,b]=G.useState({visible:!1,message:"",type:"info"}),{subproyectos:t}=ye(),{eventos:d}=Ee(!1),{matrices:E}=we(),{laboratorios:w}=je(),h=[...E,{id:0,codigo:0,nombre:"Todos"}],{compuestos:O}=Se(),{metodos:A}=Fe(),{UM:v}=Ie(),x=t.find(C=>C.id===a.subproyecto),f={agua:(x==null?void 0:x.autAplicacionAguaId)||null,suelo:(x==null?void 0:x.autAplicacionSueloId)||null,gases:(x==null?void 0:x.autAplicacionGasesId)||null,FLNA:(x==null?void 0:x.autAplicacionFLNAId)||null},{regulados:y}=De(f),j=d.find(C=>C.id===a.evento),U=()=>{s({filas:[],muestras:[]}),p({subproyecto:null,matriz:null,evento:null,mostrar:1})},i=C=>{n(C)},S=G.useCallback(async C=>{if(C.dataField==="subproyecto")r(d.filter(I=>I.subproyectoId===C.value));else if(C.dataField==="evento")try{const I=await $e(C.value,a.matriz,y);g(I);const T=oe(I,a.mostrar,O);s(T)}catch(I){g({filas:[],muestras:[]}),s({filas:[],muestras:[]}),b({visible:!0,message:`(${I.status||"NS"}) ${I.message||I}`,type:"error"})}else if(C.dataField==="matriz")g({filas:[],muestras:[]}),s({filas:[],muestras:[]});else if(C.dataField==="mostrar"&&o){const I=oe(o,C.value,O);s(I)}p(I=>({...I,[C.dataField]:C.value,...C.dataField==="matriz"?{evento:null}:{}}))},[a,d,m]),F=G.useCallback(C=>{C.rowType},[]);return c.jsxs("div",{children:[c.jsxs(me,{formData:a,onFieldDataChanged:S,colCount:12,children:[c.jsx(Ne,{subproyectos:t,matrices:h,filteredEventos:e,setColor:i}),((k=m.filas)==null?void 0:k.length)>0&&c.jsxs(c.Fragment,{children:[c.jsx(Ue,{filas:m.filas,muestras:m.muestras,compuestos:O,metodos:A,UM:v,colorActive:l,onRowPrepared:F}),c.jsxs(ue,{cssClass:"buttons-group",colSpan:12,colCount:12,children:[c.jsx(Y,{colSpan:8}),a.matriz===0&&c.jsx(_,{colSpan:2,buttonOptions:{text:"Exportar Tablas",type:"default",width:200,onClick:C=>Ke(b,x,j,m,y,O,w)}}),a.matriz!==0&&c.jsx(_,{colSpan:2,buttonOptions:{text:"Exportar CDI",type:"default",width:200,onClick:C=>We(m,a.matriz,O,v,l)}}),c.jsx(_,{colSpan:2,buttonOptions:{text:"Cancelar",type:"default",width:200,onClick:C=>U()}})]})]})]}),c.jsx(fe,{visible:u.visible,message:u.message,type:u.type,displayTime:4e3,onHiding:()=>b({...u,visible:!1})})]})}export{pt as default};
