import{j as c,S as L,_ as q,$ as Y,af as ce,r as R,F as ue,a0 as _}from"./index-C37p9Lq4.js";import{T as me}from"./toast-BTJFKrW3.js";import"./tag-box-COb70gS8.js";import{f as fe}from"./localization-V_Bd1Ycn.js";import{D as pe,b as ge,a as be,I as Ce,E as xe,C as $}from"./data-grid-CEAYuK_4.js";import{e as he}from"./excelExport-CiUyvjK6.js";import{f as ee}from"./specialValues-CHSjwz8L.js";import{u as ve}from"./subproyectos-CuBD9c8_.js";import{u as ye}from"./eventos-gNGVqZq1.js";import{u as Ee}from"./matrices-C_DwGCla.js";import{u as we}from"./compuestos-wNu3-3Fd.js";import{u as Se}from"./metodos-CJf_zQ85.js";import{u as Fe}from"./um-DNiGqkha.js";import{u as V}from"./useQuery-DBqjJV59.js";import{a as Ie,A as te}from"./apiResource-5P-thon0.js";import{u as Oe}from"./laboratorios-CoqsY4PK.js";import{b as je,c as ze}from"./cadenaCompletaDataAccess-Dvit168Y.js";import{E as Ae}from"./exceljs.min-uy0cDVws.js";import{F as Me}from"./export_merged_ranges_manager-Bs1fMwcN.js";import"./m_utils.scroll-HIGYRNAS.js";import"./m_export-DeFelJNZ.js";const Ge=[{nombre:"Original",id:1},{nombre:"Reducido",id:2},{nombre:"Muy Reducido",id:3}];function Re({subproyectos:e,matrices:o,filteredEventos:a,setColor:n}){return c.jsxs(c.Fragment,{children:[c.jsx(L,{dataField:"subproyecto",editorType:"dxSelectBox",colSpan:3,editorOptions:{dataSource:e,displayExpr:l=>l?`${l.codigo} - ${l.nombreLocacion}`:"",valueExpr:"id",searchEnabled:!0},children:c.jsx(q,{text:"Seleccione un Subproyecto"})}),c.jsx(L,{dataField:"matriz",editorType:"dxSelectBox",colSpan:1,editorOptions:{dataSource:o,displayExpr:"nombre",valueExpr:"id",searchEnabled:!1},children:c.jsx(q,{text:"Matriz"})}),c.jsx(L,{dataField:"evento",editorType:"dxSelectBox",colSpan:3,editorOptions:{dataSource:a,displayExpr:l=>l?`${fe(new Date(l.fecha),"dd/MM/yyyy")} - ${l.nombre}`:"",valueExpr:"id",searchEnabled:!0},children:c.jsx(q,{text:"Seleccione un Evento de Muestreo"})}),c.jsx(Y,{colSpan:1}),c.jsx(L,{dataField:"mostrar",editorType:"dxSelectBox",colSpan:2,editorOptions:{dataSource:Ge,displayExpr:"nombre",valueExpr:"id",searchEnabled:!1},children:c.jsx(q,{text:"Mostrar"})}),c.jsx(L,{dataField:"colorear",editorType:"dxCheckBox",colSpan:1,label:{text:"Regulaciones",showColon:!0},editorOptions:{text:"Colorear",onValueChanged:l=>n(l.value)}}),c.jsx(Y,{colSpan:1})]})}function Ne({filas:e,muestras:o,compuestos:a,metodos:n,UM:l,colorActive:u,onRowPrepared:t}){function p(s){var f;if(u&&s.rowType==="data"){const b=(f=s.column)==null?void 0:f.dataField;if(!b||["compuestoId","metodoId","umId","nivelGuia","nivelGuiaUM"].includes(b))return;const r=s.value,d=parseFloat(s.data.nivelGuia);if(isNaN(d)||r===null||r===void 0||r===-3)return;d===-1?r>0?s.cellElement.style.backgroundColor="red":(r===-1||r===-2||r===0)&&(s.cellElement.style.backgroundColor="green"):d===-2?s.cellElement.style.backgroundColor="green":d===-3?r>0||r===-1?s.cellElement.style.backgroundColor="red":(r===-2||r===0)&&(s.cellElement.style.backgroundColor="green"):r>d?s.cellElement.style.backgroundColor="red":s.cellElement.style.backgroundColor="green"}}function m(s){he(s.component,"ReporteEventoPreparado.xlsx")}return c.jsx(ce,{colSpan:12,children:c.jsxs(pe,{dataSource:e,keyExpr:"id",showBorders:!0,columnAutoWidth:!0,rowAlternationEnabled:!0,height:450,scrolling:{mode:"virtual"},onCellPrepared:p,onRowPrepared:t,onExporting:m,children:[c.jsx(ge,{enabled:!0,allowExportSelectedData:!0,fileName:"ReporteEventoPreparado"}),c.jsx(be,{children:c.jsx(Ce,{name:"exportButton"})}),c.jsx(xe,{mode:"cell",allowUpdating:!0,allowDeleting:!0}),c.jsx($,{dataField:"compuestoId",caption:"Compuesto",allowEditing:!1,width:220,lookup:{dataSource:a,valueExpr:"id",displayExpr:"nombre"},fixed:!0,fixedPosition:"left"}),c.jsx($,{dataField:"metodoId",caption:"Método",allowEditing:!1,width:220,lookup:{dataSource:n,valueExpr:"id",displayExpr:"nombre"}}),c.jsx($,{dataField:"umId",caption:"UM",width:80,lookup:{dataSource:l,valueExpr:"id",displayExpr:"nombre"}}),c.jsx($,{dataField:"nivelGuia",caption:"NG",width:100,cellRender:({value:s})=>Ue(s)}),o.map(s=>c.jsx($,{dataField:s.muestra,caption:s.muestra,cellRender:({value:f})=>ee(f,!1)},s.muestra))]})})}function Ue(e){return e==null?"NL":Number(e)===-1?"<LC":Number(e)===-2?"SAT/SOL":Number(e)===-3?"<LD":Number(e)||e}const W=async e=>{const o=new Ie("regulados");if(e===null)return[];const a=e!==0?["autAplicacionId","=",e]:null;return(await o.fetch({filter:a})).data},ke=({agua:e,suelo:o,gases:a,FLNA:n})=>{const l=V({queryKey:["regulados","agua",e],queryFn:()=>W(e),enabled:!!e}),u=V({queryKey:["regulados","suelo",o],queryFn:()=>W(o),enabled:!!o}),t=V({queryKey:["regulados","gases",a],queryFn:()=>W(a),enabled:!!a}),p=V({queryKey:["regulados","FLNA",n],queryFn:()=>W(n),enabled:!!n}),s=[...l.data||[],...u.data||[],...t.data||[],...p.data||[]].reduce((b,r)=>{const d=r.compuestoId,E=new Date(r.fechaVigencia);return(!b[d]||new Date(b[d].fechaVigencia)<E)&&(b[d]=r),b},{});return{regulados:Object.values(s),isLoadingRegulados:l.isLoading||u.isLoading||t.isLoading||p.isLoading,errorRegulados:l.error||u.error||t.error||p.error}};function De(e){const o=["id","cadenaCustodiaId","compuestoId","estado","metodoId","umId","protocoloItemId","codigo","nivelGuia","nivelGuiaOriginalUM","nivelGuiaOriginal"];return Object.entries(e).some(([n,l])=>o.includes(n)?!1:typeof l=="number"&&l>0)}function Te(e,o,a){if(o===1)return!0;const n=a.find(l=>l.id===e.compuestoId);if(!n)return!0;if(o===2)return n.exponeId!=0;if(o===3)return n.exponeId==1||n.exponeId==2&&De(e)}function oe(e,o,a){return{muestras:e.muestras,filas:e.filas.filter(n=>Te(n,o,a))}}async function Le(e,o,a){try{const[n,l]=await Promise.all([je(e,o),ze()]);if(n&&n.filas&&n.filas.length>0)return n.filas=Be(n.filas,a,l),n;throw new Error("Evento preparado no ha devuelto datos")}catch(n){throw n}}const $e=(e,o)=>{const a=Math.pow(10,o);return Number((Math.round(e*a)/a).toFixed(o))};function Be(e,o,a){const n=Object.fromEntries(o.map(u=>[u.compuestoId,u])),l=new Map;return a.forEach(u=>{l.set(`${u.desdeUMId}-${u.hastaUMId}`,parseFloat(u.factor))}),e.map(u=>{const t=n[u.compuestoId];if(!t)return console.log("!regulado: ",u.compuestoId),{...u,nivelGuia:null,nivelGuiaOriginal:null,nivelGuiaOriginalUM:null};const p=parseFloat(t.valorReferencia),m=t.umId,s=u.umId;if(p===-1||p===-2||p===-3)return console.log("especial: ",u.compuestoId,p,m),{...u,nivelGuia:p,nivelGuiaOriginal:p,nivelGuiaOriginalUM:m};if(isNaN(p))return console.log("isNan: ",u.compuestoId),{...u,nivelGuia:null,nivelGuiaOriginal:null,nivelGuiaOriginalUM:m};let f=p;if(s!==m){const b=l.get(`${m}-${s}`);b?f=$e(p*b,5):f=null}return console.log("normal: ",u.compuestoId,f,p,m),{...u,nivelGuia:f,nivelGuiaOriginal:p,nivelGuiaOriginalUM:m}})}const re=3,H=4,Pe=1,ae=2,le=2,ne=35,se=15,D=12,N=11,K="FF00B050",Q="FFFF0000",G="FFFFFFFF",Z="FF808080",M="FFD9D9D9",z={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}},X={AGUA:1,SUELO:3,GASES:4};function qe(e){let o="";for(;e>0;){const a=(e-1)%26;o=String.fromCharCode(65+a)+o,e=Math.floor((e-a)/26)}return o}function ie(e,o,a){if(!a||isNaN(o)||e===null||e===void 0||e===-3)return G;if(o===-1)return e>0?Q:e===-1||e===-2||e===0?K:G;if(o===-2)return K;if(o===-1)return e>0||e===-1?Q:e===-2||e===0?K:G;if(typeof e=="number"){if(e>o)return Q;if(e<=o)return K}return G}function de(e,o){var a;return((a=o.find(n=>n.id===e.compuestoId))==null?void 0:a.nombre)||`Compuesto ${e.compuestoId}`}function Ve(e,o){var a;return((a=o.find(n=>n.id===e.umId))==null?void 0:a.nombre)||`UM ${e.umId}`}async function We(e,o,a,n,l){const u=new Ae.Workbook,t=u.addWorksheet("Muestras");if(o===X.AGUA||o===X.GASES){const s=1+e.filas.length;let f=0;for(const b of e.muestras){if(b.tipo!==1)continue;const r=f%re*(H+Pe)+1,d=Math.floor(f/re)*(s+ae)+1;t.getColumn(r).width=10,t.getColumn(r+1).width=ne,t.getColumn(r+2).width=se,t.getColumn(r+3).width=10,t.mergeCells(d,r,d,r+H-1);const E=t.getCell(d,r);E.value=b.muestra||"",E.alignment={horizontal:"center",vertical:"middle"},E.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},E.font={name:"Arial",size:D,bold:!1,color:{argb:G}},E.border=z;const w=d+1;let v=w;for(const i of e.filas){const S=i[b.muestra],F=ee(i[b.muestra],!1)??"",k=de(i,a),C=Ve(i,n),I=isNaN(i.nivelGuia)?NaN:parseFloat(i.nivelGuia);t.getCell(v,r).value="";const T=t.getCell(v,r+1);T.value=k,T.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},T.font={name:"Arial",size:D,bold:!1};const B=t.getCell(v,r+2);B.value=F,B.font={name:"Arial",size:N,bold:!1},B.alignment={horizontal:"center",vertical:"middle"},B.fill={type:"pattern",pattern:"solid",fgColor:{argb:ie(S,I,l)}};const P=t.getCell(v,r+3);P.value=C,P.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},P.alignment={horizontal:"center",vertical:"middle"},P.font={name:"Arial",size:N,bold:!1};for(let J=r;J<r+H;J++)t.getCell(v,J).border=z;v++}const O=w,A=v-1,h=qe(r),x=`${h}${O}:${h}${A}`;t.mergeCells(x);const g=t.getCell(O,r);g.value="Compuesto",g.alignment={horizontal:"center",vertical:"middle",textRotation:90},g.font={name:"Arial",size:D,bold:!1},g.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}};for(let i=O;i<=A;i++)t.getCell(i,r).border=z;const y=r+3;let j=!0;const U=t.getCell(w,y).value;for(let i=w;i<v;i++)if(t.getCell(i,y).value!==U){j=!1;break}if(j){t.mergeCells(w,y,v-1,y);const i=t.getCell(w,y);i.alignment={horizontal:"center",vertical:"middle"},i.font={name:"Arial",size:N,bold:!1},i.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}else{let i=w,S=t.getCell(i,y).value;for(let F=w+1;F<v;F++){const k=t.getCell(F,y).value;if(k!==S){if(F-i>=le){t.mergeCells(i,y,F-1,y);const C=t.getCell(i,y);C.alignment={horizontal:"center",vertical:"middle"},C.font={name:"Arial",size:N,bold:!1},C.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}i=F,S=k}}if(v-i>=le){t.mergeCells(i,y,v-1,y);const F=t.getCell(i,y);F.alignment={horizontal:"center",vertical:"middle"},F.font={name:"Arial",size:N,bold:!1},F.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}}}}f++}}else if(o===X.SUELO){const m=e.muestras.filter(b=>b.tipo===1),s=[...new Set(m.map(b=>b.pozo))];let f=1;for(const b of s){const r=m.filter(h=>h.pozo===b);r.sort((h,x)=>h.profundidad-x.profundidad);const d=1;t.getColumn(d).width=ne;for(let h=0;h<r.length;h++)t.getColumn(d+1+h).width=se;const E=t.getCell(f,d);E.value="INTERVENCION",E.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},E.font={name:"Arial",size:D,bold:!0,color:{argb:G}},E.alignment={horizontal:"center",vertical:"middle"},E.border=z,r.forEach((h,x)=>{const g=t.getCell(f,d+1+x);g.value=h.muestra,g.fill={type:"pattern",pattern:"solid",fgColor:{argb:Z}},g.font={name:"Arial",size:D,bold:!0,color:{argb:G}},g.alignment={horizontal:"center",vertical:"middle"},g.border=z});const w=f+1,v=t.getCell(w,d);v.value="COMPUESTOS",v.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},v.font={name:"Arial",size:D,bold:!1},v.alignment={horizontal:"center",vertical:"middle"},v.border=z,r.forEach((h,x)=>{const g=t.getCell(w,d+1+x);g.value=h.profundidad,g.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},g.font={name:"Arial",size:N,bold:!1},g.alignment={horizontal:"center",vertical:"middle"},g.border=z});const O=f+2;t.mergeCells(w,d,O,d),r.forEach((h,x)=>{const g=e.filas.find(S=>S[h.muestra]!==void 0);let y=g==null?void 0:g.umId,j=n.find(S=>S.id===y),U=(j==null?void 0:j.nombre)||"UM";const i=t.getCell(O,d+1+x);i.value=U,i.fill={type:"pattern",pattern:"solid",fgColor:{argb:M}},i.font={name:"Arial",size:N,bold:!1},i.alignment={horizontal:"center",vertical:"middle"},i.border=z});let A=f+3;for(const h of e.filas){const x=de(h,a),g=t.getCell(A,d);g.value=x,g.fill={type:"pattern",pattern:"solid",fgColor:{argb:G}},g.font={name:"Arial",size:D,bold:!1},g.alignment={vertical:"middle"},g.border=z,r.forEach((y,j)=>{const U=ee(h[y.muestra],!1)??"",i=isNaN(h.nivelGuia)?NaN:parseFloat(h.nivelGuia),S=t.getCell(A,d+1+j);S.value=U,S.font={name:"Arial",size:N,bold:!1},S.alignment={horizontal:"center",vertical:"middle"},S.border=z,S.fill={type:"pattern",pattern:"solid",fgColor:{argb:ie(valorMuestraNumerico,i,l)}}}),A++}f=A+ae}}const p=await u.xlsx.writeBuffer();Me.saveAs(new Blob([p]),"muestrasCDI.xlsx")}async function Ke(e,o,a,n,l,u,t){const p={proyecto:o.codigo,fecha:a.fecha,data:n};p.data.compuestos=u,p.data.nivelesGuia=l,p.data.laboratorios=t;try{const m=await fetch(`${te}cadenatodoctabla`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!m.ok){const w=(await m.json()).message||`Error al obtener los datos del evento: ${m.statusText}`;throw new Error(w)}const s=await m.json();if(!s.file)throw new Error("No se recibió un nombre de archivo válido");const f=await fetch(`${te}cadenatodoctabla/${s.file}`);if(!f.ok)throw new Error(`Error al descargar el archivo: ${f.statusText}`);const b=await f.blob(),r=window.URL.createObjectURL(b),d=document.createElement("a");d.href=r,d.download=s.file,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(r),e({visible:!0,message:"Exportación exitosa",type:"success"})}catch(m){e({visible:!0,message:(m==null?void 0:m.message)||"Error al exportar tablas",type:"error"})}}function pt(){var k;const[e,o]=R.useState([]),[a,n]=R.useState(!1),[l,u]=R.useState({subproyecto:null,matriz:null,evento:null,mostrar:1}),[t,p]=R.useState([]),[m,s]=R.useState([]),[f,b]=R.useState({visible:!1,message:"",type:"info"}),{subproyectos:r}=ve(),{eventos:d}=ye(!1),{matrices:E}=Ee(),{laboratorios:w}=Oe(),v=[...E,{id:0,codigo:0,nombre:"Todos"}],{compuestos:O}=we(),{metodos:A}=Se(),{UM:h}=Fe(),x=r.find(C=>C.id===l.subproyecto),g={agua:(x==null?void 0:x.autAplicacionAguaId)||null,suelo:(x==null?void 0:x.autAplicacionSueloId)||null,gases:(x==null?void 0:x.autAplicacionGasesId)||null,FLNA:(x==null?void 0:x.autAplicacionFLNAId)||null},{regulados:y}=ke(g),j=d.find(C=>C.id===l.evento),U=()=>{s({filas:[],muestras:[]}),u({subproyecto:null,matriz:null,evento:null,mostrar:1})},i=C=>{n(C)},S=R.useCallback(async C=>{if(C.dataField==="subproyecto")o(d.filter(I=>I.subproyectoId===C.value));else if(C.dataField==="evento")try{const I=await Le(C.value,l.matriz,y);p(I);const T=oe(I,l.mostrar,O);s(T)}catch(I){p({filas:[],muestras:[]}),s({filas:[],muestras:[]}),b({visible:!0,message:`(${I.status||"NS"}) ${I.message||I}`,type:"error"})}else if(C.dataField==="matriz")p({filas:[],muestras:[]}),s({filas:[],muestras:[]});else if(C.dataField==="mostrar"&&t){const I=oe(t,C.value,O);s(I)}u(I=>({...I,[C.dataField]:C.value,...C.dataField==="matriz"?{evento:null}:{}}))},[l,d,m]),F=R.useCallback(C=>{C.rowType},[]);return c.jsxs("div",{children:[c.jsxs(ue,{formData:l,onFieldDataChanged:S,colCount:12,children:[c.jsx(Re,{subproyectos:r,matrices:v,filteredEventos:e,setColor:i}),((k=m.filas)==null?void 0:k.length)>0&&c.jsxs(c.Fragment,{children:[c.jsx(Ne,{filas:m.filas,muestras:m.muestras,compuestos:O,metodos:A,UM:h,colorActive:a,onRowPrepared:F}),c.jsxs(ce,{cssClass:"buttons-group",colSpan:12,colCount:12,children:[c.jsx(Y,{colSpan:8}),l.matriz===0&&c.jsx(_,{colSpan:2,buttonOptions:{text:"Exportar Tablas",type:"default",width:200,onClick:C=>Ke(b,x,j,m,y,O,w)}}),l.matriz!==0&&c.jsx(_,{colSpan:2,buttonOptions:{text:"Exportar CDI",type:"default",width:200,onClick:C=>We(m,l.matriz,O,h,a)}}),c.jsx(_,{colSpan:2,buttonOptions:{text:"Cancelar",type:"default",width:200,onClick:C=>U()}})]})]})]}),c.jsx(me,{visible:f.visible,message:f.message,type:f.type,displayTime:4e3,onHiding:()=>b({...f,visible:!1})})]})}export{pt as default};
